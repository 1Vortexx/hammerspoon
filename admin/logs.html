<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>X-ORBIT Logs Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --bg:           #000;
    --surface:      #070707;
    --surface-2:    #050505;
    --border:       #1a1a1a;
    --border-hi:    #2a2a2a;
    --text:         #fff;
    --text-dim:     #ccc;
    --text-muted:   #888;
    --text-faint:   #555;
    --text-ghost:   #444;
    --text-dead:    #333;
}

body {
    font-family: 'Share Tech Mono', monospace;
    background: var(--bg);
    color: var(--text);
    font-size: 13px;
    line-height: 1.5;
    height: 100vh;
    overflow: hidden;
}

/* ════════════════════════════════════════════════
   BLOCKED PAGE
════════════════════════════════════════════════ */
.blocked-page {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--bg);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.blocked-page.show { display: flex; }

.blocked-content {
    text-align: center;
    padding: 48px;
    background: var(--surface);
    border: 1px solid rgba(248,113,113,0.25);
    max-width: 440px;
}

.blocked-icon {
    font-size: 2.5rem;
    color: #f87171;
    margin-bottom: 20px;
    opacity: 0.7;
}

.blocked-content h1 {
    font-family: 'Orbitron', monospace;
    font-size: 1rem;
    font-weight: 900;
    color: #f87171;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 16px;
}

.blocked-content p {
    font-size: 0.78rem;
    color: var(--text-faint);
    line-height: 1.7;
    margin-bottom: 10px;
}

/* ════════════════════════════════════════════════
   NEW LOGS NOTIFICATION
════════════════════════════════════════════════ */
.new-logs-notification {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%) translateY(-60px);
    background: var(--text);
    color: var(--bg);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 1000;
    transition: transform 0.3s ease;
    cursor: pointer;
    font-family: 'Orbitron', monospace;
    font-size: 0.62rem;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    white-space: nowrap;
}

.new-logs-notification.show {
    transform: translateX(-50%) translateY(0);
}

.new-logs-notification i { font-size: 0.8rem; }

.notification-text { display: flex; flex-direction: column; gap: 1px; }
.notification-title { font-size: 0.62rem; }
.notification-subtitle { font-size: 0.56rem; opacity: 0.6; font-family: 'Share Tech Mono', monospace; letter-spacing: 1px; }

.notification-close {
    padding: 3px 8px;
    background: var(--bg);
    border: none;
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    cursor: pointer;
    margin-left: 4px;
    transition: opacity 0.15s;
}
.notification-close:hover { opacity: 0.7; }

/* ════════════════════════════════════════════════
   LOGS CONTAINER
════════════════════════════════════════════════ */
.logs-container {
    display: none;
    height: 100vh;
    flex-direction: column;
}

.logs-container.show { display: flex; }

/* ─── TOP BAR ───────────────────────────────────── */
.logs-header {
    display: flex;
    align-items: stretch;
    height: 50px;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
    flex-shrink: 0;
}

.logs-brand {
    font-family: 'Orbitron', monospace;
    font-size: 0.82rem;
    font-weight: 900;
    color: var(--text);
    letter-spacing: 3px;
    padding: 0 24px;
    border-right: 1px solid var(--border);
    display: flex;
    align-items: center;
    white-space: nowrap;
    flex-shrink: 0;
}

.logs-brand span {
    background: var(--text);
    color: var(--bg);
    padding: 0 5px;
}

/* nav tabs */
.logs-tabs {
    display: flex;
    align-items: stretch;
    border-right: 1px solid var(--border);
}

.log-tab-btn {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 0 20px;
    background: transparent;
    border: none;
    border-right: 1px solid var(--border);
    border-bottom: 2px solid transparent;
    cursor: pointer;
    font-family: 'Orbitron', monospace;
    font-size: 0.58rem;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-ghost);
    transition: color 0.15s, background 0.15s, border-bottom-color 0.15s;
    white-space: nowrap;
}
.log-tab-btn:last-child { border-right: none; }
.log-tab-btn:hover { color: var(--text-muted); background: #080808; }
.log-tab-btn.active {
    color: var(--text);
    background: var(--bg);
    border-bottom-color: var(--text);
}

/* inline stats */
.logs-top-stats {
    display: flex;
    align-items: stretch;
    border-right: 1px solid var(--border);
}

.logs-top-stat {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 0 16px;
    border-right: 1px solid var(--border);
    white-space: nowrap;
}
.logs-top-stat:last-child { border-right: none; }

.logs-top-stat-num {
    font-family: 'Orbitron', monospace;
    font-size: 0.88rem;
    font-weight: 700;
    color: var(--text-muted);
}

.logs-top-stat-lbl {
    font-size: 0.58rem;
    color: var(--text-ghost);
    letter-spacing: 1px;
    text-transform: uppercase;
}

.top-bar-spacer { flex: 1; }

/* right side */
.logs-header-right {
    display: flex;
    align-items: stretch;
    border-left: 1px solid var(--border);
}

.log-count {
    display: flex;
    align-items: center;
    padding: 0 18px;
    font-size: 0.72rem;
    color: var(--text-faint);
    border-right: 1px solid var(--border);
    white-space: nowrap;
}

.refresh-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 18px;
    background: transparent;
    border: none;
    color: var(--text-ghost);
    font-family: 'Orbitron', monospace;
    font-size: 0.56rem;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: color 0.15s, background 0.15s;
    white-space: nowrap;
}
.refresh-btn:hover { color: var(--text); background: #080808; }

/* ─── FILTER BAR ────────────────────────────────── */
.logs-filter-bar {
    display: flex;
    align-items: stretch;
    height: 42px;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
    flex-shrink: 0;
}

.filter-item {
    display: flex;
    align-items: center;
    height: 100%;
    border-right: 1px solid var(--border);
    padding: 0 14px;
    gap: 8px;
}

.filter-item label {
    font-size: 0.58rem;
    color: var(--text-ghost);
    letter-spacing: 1px;
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
}

.filter-item input,
.filter-item select {
    background: transparent;
    border: none;
    color: var(--text-dim);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.78rem;
    outline: none;
    min-width: 0;
}

.filter-item input { width: 220px; }
.filter-item input::placeholder { color: var(--text-ghost); }
.filter-item select option { background: var(--surface); }

/* ─── TABLE AREA ────────────────────────────────── */
.logs-content {
    flex: 1;
    overflow-y: auto;
}

.logs-content::-webkit-scrollbar { width: 3px; }
.logs-content::-webkit-scrollbar-track { background: transparent; }
.logs-content::-webkit-scrollbar-thumb { background: var(--border-hi); }

.logs-table {
    width: 100%;
    border-collapse: collapse;
}

.logs-table thead {
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 10;
}

.logs-table th {
    padding: 10px 14px;
    text-align: left;
    font-size: 0.58rem;
    font-weight: 700;
    color: var(--text-ghost);
    text-transform: uppercase;
    letter-spacing: 2px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}

.logs-table td {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 0.78rem;
    color: var(--text-muted);
    vertical-align: middle;
}

.logs-table tbody tr {
    transition: background 0.12s;
    position: relative;
}

.logs-table tbody tr:hover td { background: #080808; }
.logs-table tbody tr:hover td:first-child { border-left: 2px solid var(--text-faint); padding-left: 12px; }

/* status badges */
.success-badge,
.failed-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 8px;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: 1px solid;
    white-space: nowrap;
}

.success-badge { color: #6ee7b7; border-color: rgba(110,231,183,0.3); background: rgba(110,231,183,0.05); }
.failed-badge  { color: #f87171; border-color: rgba(248,113,113,0.3); background: rgba(248,113,113,0.05); }
.success-badge i, .failed-badge i { font-size: 0.6rem; }

.uuid-badge {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 1px;
}

/* column-specific text colors */
.col-ts     { color: var(--text-ghost); font-size: 0.72rem; white-space: nowrap; }
.col-user   { color: var(--text-dim); font-weight: bold; }
.col-email  { color: var(--text-faint); }
.col-reason { color: #f87171; font-size: 0.72rem; }
.col-ua     { color: var(--text-ghost); font-size: 0.68rem; }

/* empty / loading */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 64px 32px;
    gap: 12px;
    color: var(--text-ghost);
}

.empty-state i { font-size: 2rem; color: var(--border-hi); }
.empty-state p { font-size: 0.72rem; letter-spacing: 1px; text-transform: uppercase; }

.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 48px;
    gap: 10px;
    color: var(--text-ghost);
    font-size: 0.75rem;
}
.loading i { animation: spin 1s linear infinite; }

@keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}
</style>
</head>
<body>

<!-- Blocked Access Page -->
<div class="blocked-page" id="blockedPage">
    <div class="blocked-content">
        <div class="blocked-icon"><i class="fas fa-lock"></i></div>
        <h1>Access Denied</h1>
        <p>This page can only be accessed through the X-ORBIT Admin Dashboard. Direct access is not permitted.</p>
        <p>If you believe this is an error, contact your system administrator.</p>
    </div>
</div>

<!-- New Logs Notification -->
<div class="new-logs-notification" id="newLogsNotification" onclick="refreshFromNotification()">
    <i class="fas fa-bell"></i>
    <div class="notification-text">
        <div class="notification-title">New logs available</div>
        <div class="notification-subtitle">Click to refresh</div>
    </div>
    <button class="notification-close" onclick="dismissNotification(event)">Dismiss</button>
</div>

<!-- Logs Container -->
<div class="logs-container" id="logsContainer">

    <!-- TOP BAR -->
    <header class="logs-header">
        <div class="logs-brand">X-<span>ORBIT</span></div>

        <nav class="logs-tabs">
            <button class="log-tab-btn active" data-tab="login_attempts" onclick="switchLogTab('login_attempts')">
                <i class="fas fa-terminal"></i> Login Attempts
            </button>
        </nav>

        <div class="logs-top-stats">
            <div class="logs-top-stat">
                <span class="logs-top-stat-num" id="statTotal">0</span>
                <span class="logs-top-stat-lbl">Total</span>
            </div>
            <div class="logs-top-stat">
                <span class="logs-top-stat-num" id="statSuccess">0</span>
                <span class="logs-top-stat-lbl">Success</span>
            </div>
            <div class="logs-top-stat">
                <span class="logs-top-stat-num" id="statFailed">0</span>
                <span class="logs-top-stat-lbl">Failed</span>
            </div>
            <div class="logs-top-stat">
                <span class="logs-top-stat-num" id="statToday">0</span>
                <span class="logs-top-stat-lbl">Today</span>
            </div>
        </div>

        <div class="top-bar-spacer"></div>

        <div class="logs-header-right">
            <span class="log-count" id="logCount">0 logs</span>
            <button class="refresh-btn" onclick="refreshLogs()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </header>

    <!-- FILTER BAR -->
    <div class="logs-filter-bar">
        <div class="filter-item">
            <label>Search</label>
            <input type="text" id="searchFilter" placeholder="username, email, UUID…" oninput="applyFilters()">
        </div>
        <div class="filter-item">
            <label>Status</label>
            <select id="successFilter" onchange="applyFilters()">
                <option value="all">All</option>
                <option value="true">Success</option>
                <option value="false">Failed</option>
            </select>
        </div>
    </div>

    <!-- TABLE -->
    <div class="logs-content" id="logsContent">
        <div class="loading"><i class="fas fa-circle-notch"></i> Loading logs…</div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://rujvmtvozorylfzsqppc.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY';

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentTab = 'login_attempts';
let allLogs = [];
let isAuthenticated = false;
let authToken = null;
let latestLogTimestamp = null;
let backgroundCheckInterval = null;

function checkIframeStatus() {
    try {
        const inIframe = window.self !== window.top;
        if (!inIframe) { showBlockedPage(); return; }
        waitForAuthentication();
    } catch (e) {
        showBlockedPage();
    }
}

function showBlockedPage() {
    document.getElementById('blockedPage').classList.add('show');
    document.getElementById('logsContainer').classList.remove('show');
}

function showLogsPage() {
    document.getElementById('blockedPage').classList.remove('show');
    document.getElementById('logsContainer').classList.add('show');
    loadLogs();
    startBackgroundCheck();
}

function waitForAuthentication() {
    const authTimeout = setTimeout(() => {
        if (!isAuthenticated) { showBlockedPage(); }
    }, 2000);

    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'auth-token') {
            clearTimeout(authTimeout);
            authToken = event.data.token;
            if (verifyAuthToken(authToken)) {
                isAuthenticated = true;
                showLogsPage();
            } else {
                showBlockedPage();
            }
        }
    });

    window.parent.postMessage({ type: 'request-auth' }, '*');
}

function verifyAuthToken(token) {
    return token && typeof token === 'string' && token.startsWith('xorbit-admin-');
}

async function loadLogs() {
    if (!isAuthenticated) { showBlockedPage(); return; }

    const logsContent = document.getElementById('logsContent');
    logsContent.innerHTML = '<div class="loading"><i class="fas fa-circle-notch"></i> Loading logs…</div>';

    try {
        const result = await supabaseClient
            .from('login_attempts')
            .select('*')
            .order('attempt_timestamp', { ascending: false })
            .limit(500);

        if (result.error) throw result.error;

        allLogs = result.data || [];
        if (allLogs.length > 0) latestLogTimestamp = allLogs[0].attempt_timestamp;

        updateStats(allLogs);
        displayLogs(allLogs);
        updateLogCount(allLogs.length);
    } catch (error) {
        console.error('Error loading logs:', error);
        logsContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Failed to load logs</p>
                <p style="font-size:0.68rem;color:var(--text-ghost);">${error.message}</p>
            </div>`;
    }
}

async function checkForNewLogs() {
    if (!isAuthenticated || !latestLogTimestamp) return;
    try {
        const result = await supabaseClient
            .from('login_attempts')
            .select('attempt_timestamp')
            .order('attempt_timestamp', { ascending: false })
            .limit(1);

        if (result.error) throw result.error;
        if (result.data && result.data.length > 0) {
            if (result.data[0].attempt_timestamp > latestLogTimestamp) {
                showNewLogsNotification();
            }
        }
    } catch (error) {
        console.error('Error checking for new logs:', error);
    }
}

function startBackgroundCheck() {
    if (backgroundCheckInterval) clearInterval(backgroundCheckInterval);
    backgroundCheckInterval = setInterval(checkForNewLogs, 15000);
}

function stopBackgroundCheck() {
    if (backgroundCheckInterval) { clearInterval(backgroundCheckInterval); backgroundCheckInterval = null; }
}

function showNewLogsNotification() {
    const notification = document.getElementById('newLogsNotification');
    notification.classList.add('show');
    setTimeout(() => dismissNotification(), 30000);
}

function refreshFromNotification() { dismissNotification(); refreshLogs(); }

function dismissNotification(event) {
    if (event) event.stopPropagation();
    document.getElementById('newLogsNotification').classList.remove('show');
}

function updateStats(logs) {
    const today = new Date().toDateString();
    const success = logs.filter(l => l.success).length;
    const failed  = logs.filter(l => !l.success).length;
    const todayCount = logs.filter(l => new Date(l.attempt_timestamp).toDateString() === today).length;

    document.getElementById('statTotal').textContent   = logs.length;
    document.getElementById('statSuccess').textContent = success;
    document.getElementById('statFailed').textContent  = failed;
    document.getElementById('statToday').textContent   = todayCount;
}

function displayLogs(logs) {
    const logsContent = document.getElementById('logsContent');

    if (logs.length === 0) {
        logsContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No logs found</p>
            </div>`;
        return;
    }

    logsContent.innerHTML = `
        <table class="logs-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Status</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Client</th>
                    <th>Device UUID</th>
                    <th>Failure Reason</th>
                    <th>User Agent</th>
                </tr>
            </thead>
            <tbody>
                ${logs.map(log => `
                    <tr>
                        <td class="col-ts">${formatTimestamp(log.attempt_timestamp)}</td>
                        <td>
                            <span class="${log.success ? 'success-badge' : 'failed-badge'}">
                                <i class="fas fa-${log.success ? 'check' : 'times'}"></i>
                                ${log.success ? 'Success' : 'Failed'}
                            </span>
                        </td>
                        <td class="col-user">${log.attempted_username || '—'}</td>
                        <td class="col-email">${log.attempted_email || '—'}</td>
                        <td>${log.client_name || '—'}</td>
                        <td>${log.device_uuid ? `<span class="uuid-badge">${log.device_uuid}</span>` : '<span style="opacity:0.3;">—</span>'}</td>
                        <td class="col-reason">${log.failure_reason || '—'}</td>
                        <td class="col-ua">${truncate(log.user_agent, 40)}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>`;
}

function switchLogTab(tab) {
    if (!isAuthenticated) return;
    currentTab = tab;
    document.querySelectorAll('.log-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    loadLogs();
}

function applyFilters() {
    const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
    const successFilter = document.getElementById('successFilter').value;

    let filtered = allLogs;

    if (searchTerm) {
        filtered = filtered.filter(log =>
            (log.attempted_username || '').toLowerCase().includes(searchTerm) ||
            (log.attempted_email || '').toLowerCase().includes(searchTerm) ||
            (log.client_name || '').toLowerCase().includes(searchTerm) ||
            (log.device_uuid || '').toLowerCase().includes(searchTerm) ||
            (log.user_agent || '').toLowerCase().includes(searchTerm)
        );
    }

    if (successFilter !== 'all') {
        const filterValue = successFilter === 'true';
        filtered = filtered.filter(log => log.success === filterValue);
    }

    displayLogs(filtered);
    updateLogCount(filtered.length);
}

function refreshLogs() {
    if (!isAuthenticated) return;
    loadLogs();
}

function formatTimestamp(timestamp) {
    return new Date(timestamp).toLocaleString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
}

function truncate(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '…' : text;
}

function updateLogCount(count) {
    document.getElementById('logCount').textContent = `${count} log${count !== 1 ? 's' : ''}`;
}

window.addEventListener('message', (event) => {
    if (event.data && event.data.type === 'auth-token') {
        authToken = event.data.token;
        if (verifyAuthToken(authToken)) { isAuthenticated = true; showLogsPage(); }
        else showBlockedPage();
        return;
    }
    if (event.data === 'refresh-logs' && isAuthenticated) refreshLogs();
});

window.addEventListener('load', () => checkIframeStatus());
window.addEventListener('beforeunload', () => stopBackgroundCheck());
</script>
</body>
</html>
