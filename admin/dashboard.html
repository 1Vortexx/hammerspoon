<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-ORBIT Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg:           #000;
            --surface:      #070707;
            --surface-2:    #050505;
            --border:       #1a1a1a;
            --border-hi:    #2a2a2a;
            --text:         #fff;
            --text-dim:     #ccc;
            --text-muted:   #888;
            --text-faint:   #555;
            --text-ghost:   #444;
            --text-dead:    #333;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            line-height: 1.5;
            height: 100vh;
            overflow: hidden;
        }

        /* ════════════════════════════════════════════════
           LOGIN
        ════════════════════════════════════════════════ */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        #loginScreen::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(rgba(255,255,255,0.018) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.018) 1px, transparent 1px);
            background-size: 52px 52px;
            pointer-events: none;
        }

        .login-wrap {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 740px;
            max-width: 95vw;
            border: 1px solid var(--border-hi);
        }

        .login-brand {
            padding: 56px 44px;
            border-right: 1px solid var(--border);
            background: var(--surface-2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .login-brand-top {}

        .login-eyebrow {
            font-size: 0.58rem;
            color: var(--text-ghost);
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .login-eyebrow::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .login-logo {
            font-family: 'Orbitron', monospace;
            font-size: 2.6rem;
            font-weight: 900;
            color: var(--text);
            letter-spacing: 4px;
            line-height: 1;
            margin-bottom: 10px;
        }

        .login-logo span {
            background: var(--text);
            color: var(--bg);
            padding: 0 8px;
        }

        .login-tagline {
            font-size: 0.68rem;
            color: var(--text-faint);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .login-brand-bottom {
            border-top: 1px solid var(--border);
            padding-top: 24px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .login-feature {
            font-size: 0.65rem;
            color: var(--text-ghost);
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-feature::before {
            content: '→';
            color: var(--text-dead);
        }

        .login-form-panel {
            padding: 56px 44px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-form-heading {
            font-family: 'Orbitron', monospace;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-faint);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 32px;
        }

        .error-message {
            background: rgba(239,68,68,0.07);
            color: #f87171;
            border: 1px solid rgba(239,68,68,0.2);
            padding: 10px 12px;
            margin-bottom: 16px;
            display: none;
            font-size: 0.78rem;
        }
        .error-message.show { display: block; }

        .form-group { margin-bottom: 18px; }

        .form-group label {
            display: block;
            margin-bottom: 7px;
            color: var(--text-ghost);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .form-group input {
            width: 100%;
            padding: 11px 13px;
            background: var(--bg);
            border: 1px solid var(--border-hi);
            color: var(--text);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.88rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group input:focus { border-color: var(--text-faint); }
        .form-group input::placeholder { color: var(--border-hi); }

        .login-btn {
            width: 100%;
            padding: 13px;
            background: var(--text);
            border: 1px solid var(--text);
            color: var(--bg);
            font-family: 'Orbitron', monospace;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .login-btn:hover:not(:disabled) { background: var(--bg); color: var(--text); }
        .login-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ════════════════════════════════════════════════
           DASHBOARD SHELL
        ════════════════════════════════════════════════ */
        #dashboard {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        /* ─── TOP BAR ───────────────────────────────────── */
        .top-bar {
            display: flex;
            align-items: stretch;
            height: 50px;
            border-bottom: 1px solid var(--border);
            background: var(--surface-2);
            flex-shrink: 0;
        }

        .top-bar-brand {
            font-family: 'Orbitron', monospace;
            font-size: 0.82rem;
            font-weight: 900;
            color: var(--text);
            letter-spacing: 3px;
            padding: 0 24px;
            border-right: 1px solid var(--border);
            display: flex;
            align-items: center;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .top-bar-brand span {
            background: var(--text);
            color: var(--bg);
            padding: 0 5px;
        }

        /* nav tabs */
        .top-nav {
            display: flex;
            align-items: stretch;
            border-right: 1px solid var(--border);
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 0 20px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border);
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-size: 0.58rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-ghost);
            transition: color 0.15s, background 0.15s, border-bottom-color 0.15s;
            white-space: nowrap;
        }
        .nav-tab:last-child { border-right: none; }
        .nav-tab:hover { color: var(--text-muted); background: #080808; }
        .nav-tab.active {
            color: var(--text);
            background: var(--bg);
            border-bottom-color: var(--text);
        }

        .nav-count {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.6rem;
            background: var(--border-hi);
            color: var(--text-ghost);
            padding: 1px 5px;
            line-height: 1.4;
        }
        .nav-tab.active .nav-count {
            background: var(--text);
            color: var(--bg);
        }

        /* inline stats */
        .top-stats {
            display: flex;
            align-items: stretch;
            border-right: 1px solid var(--border);
        }

        .top-stat {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 0 16px;
            border-right: 1px solid var(--border);
            white-space: nowrap;
        }
        .top-stat:last-child { border-right: none; }

        .top-stat-num {
            font-family: 'Orbitron', monospace;
            font-size: 0.88rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .top-stat-lbl {
            font-size: 0.58rem;
            color: var(--text-ghost);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .top-bar-spacer { flex: 1; }

        /* right side */
        .top-bar-right {
            display: flex;
            align-items: stretch;
            border-left: 1px solid var(--border);
        }

        .top-bar-admin {
            display: flex;
            align-items: center;
            padding: 0 18px;
            font-size: 0.72rem;
            color: var(--text-faint);
            border-right: 1px solid var(--border);
            white-space: nowrap;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 18px;
            background: transparent;
            border: none;
            color: var(--text-ghost);
            font-family: 'Orbitron', monospace;
            font-size: 0.56rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: color 0.15s, background 0.15s;
            white-space: nowrap;
        }
        .logout-btn:hover { color: var(--text); background: #080808; }

        /* ════════════════════════════════════════════════
           WORKSPACE
        ════════════════════════════════════════════════ */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ─── TICKET PANEL ──────────────────────────────── */
        .ticket-panel {
            width: 290px;
            flex-shrink: 0;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            background: var(--surface-2);
            transition: width 0.25s ease, opacity 0.25s ease;
            overflow: hidden;
        }

        .ticket-panel.hidden {
            width: 0;
            opacity: 0;
        }

        .panel-search {
            position: relative;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .panel-search input {
            width: 100%;
            padding: 13px 36px 13px 16px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.78rem;
            outline: none;
            letter-spacing: 1px;
            transition: background 0.15s;
        }
        .panel-search input:focus { background: #080808; }
        .panel-search input::placeholder { color: var(--text-ghost); }

        .panel-search i {
            position: absolute;
            right: 13px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-ghost);
            font-size: 0.68rem;
            pointer-events: none;
        }

        .ticket-list {
            flex: 1;
            overflow-y: auto;
        }
        .ticket-list::-webkit-scrollbar { width: 3px; }
        .ticket-list::-webkit-scrollbar-track { background: transparent; }
        .ticket-list::-webkit-scrollbar-thumb { background: var(--border-hi); }

        .ticket-item {
            padding: 13px 16px 13px 18px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s;
            position: relative;
        }

        .ticket-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 2px;
            background: transparent;
            transition: background 0.12s;
        }

        .ticket-item:hover { background: #080808; }
        .ticket-item:hover::before { background: var(--text-faint); }
        .ticket-item.active { background: #0a0a0a; }
        .ticket-item.active::before { background: var(--text); }

        .ticket-row-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .ticket-id {
            font-family: 'Orbitron', monospace;
            font-size: 0.58rem;
            font-weight: 700;
            color: var(--text-faint);
            letter-spacing: 1px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .dot-open             { background: #fbbf24; }
        .dot-in_progress      { background: #60a5fa; }
        .dot-waiting_response { background: #f9a8d4; }
        .dot-resolved         { background: #6ee7b7; }
        .dot-closed           { background: var(--border-hi); }

        .ticket-name {
            font-size: 0.82rem;
            color: var(--text-dim);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ticket-subject {
            font-size: 0.7rem;
            color: var(--text-faint);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ticket-time {
            font-size: 0.6rem;
            color: var(--text-ghost);
        }

        /* ════════════════════════════════════════════════
           CHAT / CONTENT PANEL
        ════════════════════════════════════════════════ */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
            min-width: 0;
        }

        /* empty state */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .empty-state i {
            font-size: 32px;
            color: var(--border-hi);
        }

        .empty-state p {
            font-size: 0.7rem;
            color: var(--text-ghost);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* ─── INFO BAR ──────────────────────────────────── */
        .chat-info-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 46px;
            padding: 0 20px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
            gap: 12px;
            overflow: hidden;
        }

        .chat-info-left {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
            flex: 1;
            min-width: 0;
        }

        .chat-tid {
            font-family: 'Orbitron', monospace;
            font-size: 0.62rem;
            font-weight: 900;
            color: var(--text);
            letter-spacing: 2px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-sep { color: var(--border-hi); font-size: 0.8rem; flex-shrink: 0; }

        .chat-uname {
            font-size: 0.78rem;
            color: var(--text-dim);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-email {
            font-size: 0.7rem;
            color: var(--text-faint);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-cat {
            font-size: 0.6rem;
            color: var(--text-ghost);
            border: 1px solid var(--border-hi);
            padding: 2px 7px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .chat-info-right {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-select {
            padding: 5px 9px;
            background: var(--bg);
            border: 1px solid var(--border-hi);
            color: var(--text-dim);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.7rem;
            outline: none;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .action-select:hover { border-color: var(--text-faint); }
        .action-select option { background: var(--surface); color: var(--text); }

        /* ─── MESSAGES ──────────────────────────────────── */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 28px;
        }
        .messages-container::-webkit-scrollbar { width: 3px; }
        .messages-container::-webkit-scrollbar-track { background: transparent; }
        .messages-container::-webkit-scrollbar-thumb { background: var(--border-hi); }

        .message {
            max-width: 64%;
            margin-bottom: 18px;
            animation: msgIn 0.18s ease;
        }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .message.user { margin-left: auto; text-align: right; }

        .msg-sender {
            font-size: 0.58rem;
            color: var(--text-ghost);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .msg-bubble {
            display: inline-block;
            padding: 10px 14px;
            line-height: 1.6;
            font-size: 0.85rem;
        }

        .message.user .msg-bubble {
            background: #0a0a0a;
            color: var(--text-dim);
            border: 1px solid var(--border-hi);
        }

        .message.staff .msg-bubble {
            background: var(--text);
            color: var(--bg);
        }

        .message.system {
            max-width: 100%;
            text-align: center;
            margin: 14px 0;
        }

        .message.system .msg-bubble {
            background: transparent;
            color: var(--text-ghost);
            border: 1px solid var(--border);
            padding: 5px 14px;
            font-size: 0.68rem;
            font-style: italic;
        }

        .msg-time {
            font-size: 0.58rem;
            color: var(--text-ghost);
            margin-top: 4px;
            opacity: 0.6;
        }

        /* ─── INPUT AREA ────────────────────────────────── */
        .message-input-area {
            border-top: 1px solid var(--border);
            background: var(--surface);
            flex-shrink: 0;
        }

        .input-hint {
            padding: 6px 16px 0;
            font-size: 0.56rem;
            color: var(--text-ghost);
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .input-row {
            display: flex;
            align-items: stretch;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border);
            color: var(--text);
            resize: none;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.88rem;
            outline: none;
            line-height: 1.5;
        }
        .message-input::placeholder { color: var(--border-hi); }

        .send-btn {
            padding: 0 28px;
            background: var(--text);
            border: none;
            color: var(--bg);
            font-family: 'Orbitron', monospace;
            font-size: 0.62rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            transition: background 0.15s;
        }
        .send-btn:hover:not(:disabled) { background: var(--text-dim); }
        .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* ════════════════════════════════════════════════
           LOGS IFRAME
        ════════════════════════════════════════════════ */
        #logsContent {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        /* ─── MISC ──────────────────────────────────────── */
        .no-tickets {
            padding: 20px 16px;
            text-align: center;
            font-size: 0.72rem;
            color: var(--text-ghost);
            letter-spacing: 1px;
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 32px;
            color: var(--text-ghost);
            gap: 8px;
            font-size: 0.72rem;
        }

        .loading-spinner i { animation: spin 1s linear infinite; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to   { transform: rotate(360deg); }
        }

        /* ════════════════════════════════════════════════
           ADMINS PANEL
        ════════════════════════════════════════════════ */
        #adminsContent {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .admins-layout {
            display: grid;
            grid-template-columns: 340px 1fr;
            height: 100%;
            overflow: hidden;
        }

        .admin-create-panel {
            border-right: 1px solid var(--border);
            background: var(--surface-2);
            overflow-y: auto;
            padding: 28px;
        }

        .clients-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
            background: var(--bg);
        }

        .clients-col {
            padding: 28px 24px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }
        .clients-col:last-child { border-right: none; }
        .clients-col::-webkit-scrollbar { width: 3px; }
        .clients-col::-webkit-scrollbar-track { background: transparent; }
        .clients-col::-webkit-scrollbar-thumb { background: var(--border-hi); }

        .edit-btn {
            background: transparent;
            border: 1px solid var(--border-hi);
            color: var(--text-ghost);
            padding: 4px 9px;
            cursor: pointer;
            font-size: 0.65rem;
            transition: color 0.15s, border-color 0.15s;
            flex-shrink: 0;
        }
        .edit-btn:hover { color: var(--text); border-color: var(--text-faint); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border-hi);
            width: 440px;
            max-width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-family: 'Orbitron', monospace;
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-ghost);
            font-size: 1.1rem;
            cursor: pointer;
            line-height: 1;
            padding: 2px 6px;
            transition: color 0.15s;
        }
        .modal-close:hover { color: var(--text); }

        .modal-body { padding: 20px; }
        .modal-footer { padding: 0 20px 20px; }

        .admin-panel-eyebrow {
            font-size: 0.58rem;
            color: var(--text-ghost);
            letter-spacing: 3px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .admin-panel-eyebrow::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .admin-panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 900;
            color: var(--text);
            letter-spacing: 2px;
            margin-bottom: 28px;
        }

        .admin-form-group { margin-bottom: 16px; }

        .admin-form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-ghost);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .admin-form-group input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg);
            border: 1px solid var(--border-hi);
            color: var(--text);
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .admin-form-group input:focus { border-color: var(--text-faint); }
        .admin-form-group input::placeholder { color: var(--border-hi); }

        .admin-create-btn {
            width: 100%;
            padding: 12px;
            background: var(--text);
            border: 1px solid var(--text);
            color: var(--bg);
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            margin-top: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .admin-create-btn:hover:not(:disabled) { background: var(--bg); color: var(--text); }
        .admin-create-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .create-msg {
            padding: 10px 12px;
            margin-bottom: 18px;
            font-size: 0.78rem;
            border: 1px solid;
            display: none;
        }
        .create-msg.success { background: rgba(110,231,183,0.07); color: #6ee7b7; border-color: rgba(110,231,183,0.2); }
        .create-msg.error   { background: rgba(239,68,68,0.07);   color: #f87171; border-color: rgba(239,68,68,0.2); }

        .clients-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .client-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 16px;
            padding: 14px 18px;
            background: var(--surface);
            border: 1px solid var(--border);
            transition: background 0.12s, border-color 0.12s;
        }
        .client-item:hover { background: #080808; border-color: var(--border-hi); }

        .client-name  { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 3px; }
        .client-email { font-size: 0.72rem; color: var(--text-faint); }

        .client-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        .client-ticket-count {
            font-family: 'Orbitron', monospace;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .client-last-seen { font-size: 0.6rem; color: var(--text-ghost); }

        .client-badges { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; }

        .role-badge {
            font-size: 0.56rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 2px 6px;
            border: 1px solid;
        }
        .role-standard { color: var(--text-ghost); border-color: var(--border-hi); }
        .role-premium  { color: #fbbf24; border-color: rgba(251,191,36,0.3); background: rgba(251,191,36,0.05); }

        .banned-badge {
            font-size: 0.56rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 2px 6px;
            border: 1px solid;
            color: #f87171;
            border-color: rgba(248,113,113,0.3);
            background: rgba(248,113,113,0.06);
        }
    </style>
</head>
<body>

    <!-- ══ LOGIN ═══════════════════════════════════════════ -->
    <div id="loginScreen">
        <div class="login-wrap">
            <div class="login-brand">
                <div class="login-brand-top">
                    <div class="login-eyebrow">Admin Portal</div>
                    <div class="login-logo">X-<span>ORBIT</span></div>
                    <div class="login-tagline">Support Dashboard</div>
                </div>
                <div class="login-brand-bottom">
                    <div class="login-feature">Manage support tickets</div>
                    <div class="login-feature">View authentication logs</div>
                    <div class="login-feature">Real-time messaging</div>
                </div>
            </div>
            <div class="login-form-panel">

                <!-- Panel 1: Email + Password -->
                <div id="loginPanel">
                    <div class="login-form-heading">Sign in</div>
                    <div class="error-message" id="loginError"></div>
                    <form onsubmit="handleLogin(event)" id="loginForm">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required placeholder="admin@example.com">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required placeholder="••••••••">
                        </div>
                        <button type="submit" class="login-btn" id="loginBtn">
                            <i class="fas fa-arrow-right"></i> Login
                        </button>
                    </form>
                </div>

                <!-- Panel 2: TOTP Verify -->
                <div id="totpPanel" style="display:none;">
                    <div class="login-form-heading">Two-Factor Auth</div>
                    <div class="error-message" id="totpError"></div>
                    <p style="font-size:0.72rem;color:var(--text-faint);margin-bottom:20px;">Enter the 6-digit code from your authenticator app.</p>
                    <div class="form-group">
                        <label for="totpCode">Verification Code</label>
                        <input type="text" id="totpCode" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" autocomplete="one-time-code">
                    </div>
                    <button type="button" class="login-btn" id="totpBtn" onclick="handleTotpVerify()">
                        <i class="fas fa-shield-alt"></i> Verify
                    </button>
                </div>

                <!-- Panel 3: TOTP Enrollment -->
                <div id="enrollPanel" style="display:none;">
                    <div class="login-form-heading">Set Up 2FA</div>
                    <div class="error-message" id="enrollError"></div>
                    <p style="font-size:0.72rem;color:var(--text-faint);margin-bottom:16px;">Scan the QR code with your authenticator app.</p>
                    <div style="text-align:center;margin-bottom:16px;">
                        <img id="enrollQr" src="" alt="TOTP QR Code" style="width:160px;height:160px;background:#fff;display:block;margin:0 auto 10px;">
                        <div style="font-size:0.6rem;color:var(--text-ghost);letter-spacing:1px;margin-bottom:4px;">MANUAL ENTRY CODE</div>
                        <div id="enrollSecret" style="font-size:0.72rem;color:var(--text-faint);word-break:break-all;padding:8px;border:1px solid var(--border-hi);background:var(--bg);"></div>
                    </div>
                    <div class="form-group">
                        <label for="enrollCode">Enter 6-Digit Code to Confirm</label>
                        <input type="text" id="enrollCode" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" autocomplete="one-time-code">
                    </div>
                    <button type="button" class="login-btn" id="enrollBtn" onclick="handleEnrollVerify()">
                        <i class="fas fa-check"></i> Activate 2FA
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ══ DASHBOARD ═══════════════════════════════════════ -->
    <div id="dashboard">

        <!-- TOP BAR -->
        <header class="top-bar">
            <div class="top-bar-brand">X-<span>ORBIT</span></div>

            <nav class="top-nav">
                <button class="nav-tab active" onclick="switchTab('tickets', event)">
                    <i class="fas fa-ticket-alt"></i> Tickets
                    <span class="nav-count" id="navTicketCount">0</span>
                </button>
                <button class="nav-tab" onclick="switchTab('logs', event)">
                    <i class="fas fa-clipboard-list"></i> Logs
                </button>
                <button class="nav-tab" onclick="switchTab('admins', event)">
                    <i class="fas fa-user-shield"></i> Admins
                </button>
            </nav>

            <div class="top-stats">
                <div class="top-stat">
                    <span class="top-stat-num" id="statOpen">0</span>
                    <span class="top-stat-lbl">Open</span>
                </div>
                <div class="top-stat">
                    <span class="top-stat-num" id="statInProgress">0</span>
                    <span class="top-stat-lbl">Prog</span>
                </div>
                <div class="top-stat">
                    <span class="top-stat-num" id="statWaiting">0</span>
                    <span class="top-stat-lbl">Wait</span>
                </div>
                <div class="top-stat">
                    <span class="top-stat-num" id="statTotal">0</span>
                    <span class="top-stat-lbl">Active</span>
                </div>
            </div>

            <div class="top-bar-spacer"></div>

            <div class="top-bar-right">
                <span class="top-bar-admin" id="adminName"></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- WORKSPACE -->
        <div class="workspace">

            <!-- TICKET LIST -->
            <aside class="ticket-panel" id="ticketPanel">
                <div class="panel-search">
                    <input type="text" placeholder="Search tickets…" id="searchInput" oninput="searchTickets()">
                    <i class="fas fa-search"></i>
                </div>
                <div class="ticket-list" id="ticketList"></div>
            </aside>

            <!-- CHAT / CONTENT -->
            <main class="chat-panel">

                <div class="empty-state" id="emptyState">
                    <i class="fas fa-comments"></i>
                    <p>Select a ticket to begin</p>
                </div>

                <div id="chatContent" style="display:none; flex-direction:column; height:100%; overflow:hidden;">

                    <div class="chat-info-bar">
                        <div class="chat-info-left">
                            <span class="chat-tid" id="chatTicketNumber"></span>
                            <span class="chat-sep">/</span>
                            <span class="chat-uname" id="chatUserName"></span>
                            <span class="chat-sep">·</span>
                            <span class="chat-email" id="chatUserEmail"></span>
                            <span class="chat-sep">·</span>
                            <span class="chat-cat" id="chatCategory"></span>
                        </div>
                        <div class="chat-info-right">
                            <select class="action-select" id="statusSelect" onchange="updateTicketStatus()">
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="waiting_response">Waiting Response</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                            <select class="action-select" id="prioritySelect" onchange="updateTicketPriority()">
                                <option value="low">Low Priority</option>
                                <option value="medium">Medium Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>

                    <div class="messages-container" id="messagesContainer"></div>

                    <div class="message-input-area">
                        <div class="input-hint">Enter to send · Shift+Enter for new line</div>
                        <div class="input-row">
                            <textarea
                                id="messageInput"
                                class="message-input"
                                placeholder="Type your response…"
                                rows="3"
                                onkeydown="handleMessageKeydown(event)"
                            ></textarea>
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Logs iframe container -->
                <div id="logsContent">
                    <iframe id="logsFrame" src="logs.html" style="width:100%;height:100%;border:none;background:rgba(0,0,0,0.2);"></iframe>
                </div>

                <!-- Admins panel -->
                <div id="adminsContent">
                    <div class="admins-layout">

                        <div class="admin-create-panel">
                            <div class="admin-panel-eyebrow">New Account</div>
                            <h3 class="admin-panel-title">Create User</h3>
                            <div class="create-msg" id="createAccountMsg"></div>
                            <form onsubmit="createXorbitUser(event)" id="createUserForm">
                                <div class="admin-form-group">
                                    <label>Full Name</label>
                                    <input type="text" id="newName" placeholder="Full name" required>
                                </div>
                                <div class="admin-form-group">
                                    <label>Email</label>
                                    <input type="email" id="newEmail" placeholder="email@example.com" required>
                                </div>
                                <div class="admin-form-group">
                                    <label>Password</label>
                                    <input type="password" id="newPassword" placeholder="••••••••" required>
                                </div>
                                <div class="admin-form-group">
                                    <label>Phone <span style="color:var(--text-ghost);font-size:0.58rem;">(optional)</span></label>
                                    <input type="tel" id="newPhone" placeholder="+1 555 000 0000">
                                </div>
                                <div class="admin-form-group">
                                    <label>Role</label>
                                    <select class="action-select" id="newRole" style="width:100%;padding:10px 12px;">
                                        <option value="standard">Standard</option>
                                        <option value="premium">Premium</option>
                                    </select>
                                </div>
                                <button type="submit" class="admin-create-btn" id="createUserBtn">
                                    <i class="fas fa-plus"></i> Create User
                                </button>
                            </form>
                        </div>

                        <div class="clients-panel">
                            <div class="clients-col">
                                <div class="admin-panel-eyebrow">Support Tickets</div>
                                <h3 class="admin-panel-title">Ticket Submitters</h3>
                                <div class="clients-list" id="submittersList">
                                    <div class="loading-spinner"><i class="fas fa-spinner"></i> Loading…</div>
                                </div>
                            </div>
                            <div class="clients-col">
                                <div class="admin-panel-eyebrow">Registered Accounts</div>
                                <h3 class="admin-panel-title">X-ORBIT Users</h3>
                                <div class="clients-list" id="xorbitUsersList">
                                    <div class="loading-spinner"><i class="fas fa-spinner"></i> Loading…</div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Edit client modal -->
    <div id="editClientModal" class="modal-overlay" style="display:none;">
        <div class="modal-box">
            <div class="modal-header">
                <span class="modal-title">Edit User</span>
                <button class="modal-close" onclick="closeEditModal()">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editClientId">
                <div class="admin-form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName" placeholder="Full name">
                </div>
                <div class="admin-form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail" placeholder="email@example.com">
                </div>
                <div class="admin-form-group">
                    <label>Phone <span style="color:var(--text-ghost);font-size:0.58rem;">(optional)</span></label>
                    <input type="tel" id="editPhone" placeholder="+1 555 000 0000">
                </div>
                <div class="admin-form-group">
                    <label>Role</label>
                    <select class="action-select" id="editRole" style="width:100%;padding:10px 12px;">
                        <option value="standard">Standard</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                <div class="admin-form-group">
                    <label>Blocked</label>
                    <select class="action-select" id="editBlocked" style="width:100%;padding:10px 12px;">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="admin-form-group">
                    <label>Block Reason <span style="color:var(--text-ghost);font-size:0.58rem;">(if blocked)</span></label>
                    <input type="text" id="editBanReason" placeholder="Reason…">
                </div>
            </div>
            <div class="modal-footer">
                <div class="create-msg" id="editClientMsg"></div>
                <button class="admin-create-btn" onclick="saveClientEdit()" id="saveClientBtn">
                    <i class="fas fa-check"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rujvmtvozorylfzsqppc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentAdmin = null;
        let currentTicket = null;
        let allTickets = [];
        let xorbitClients = [];
        let messagesSubscription = null;
        let currentView = 'tickets';
        let logsAuthToken = null;
        let pendingEnrollFactorId = null;

        function generateLogsAuthToken() {
            if (!currentAdmin) return null;
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(7);
            return `xorbit-admin-${currentAdmin.id}-${timestamp}-${random}`;
        }

        function showPanel(panelId) {
            ['loginPanel', 'totpPanel', 'enrollPanel'].forEach(id => {
                document.getElementById(id).style.display = id === panelId ? 'block' : 'none';
            });
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email    = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorMsg = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in…';
            errorMsg.classList.remove('show');

            try {
                const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;

                const { data: aalData } = await supabaseClient.auth.mfa.getAuthenticatorAssuranceLevel();

                if (aalData.nextLevel === 'aal2') {
                    showPanel('totpPanel');
                    document.getElementById('totpCode').value = '';
                    document.getElementById('totpCode').focus();
                } else {
                    await startEnrollment();
                }
            } catch (err) {
                console.error('Login error:', err);
                errorMsg.textContent = err.message || 'Login failed. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Login';
            }
        }

        async function startEnrollment() {
            const enrollError = document.getElementById('enrollError');
            enrollError.classList.remove('show');

            try {
                const { data, error } = await supabaseClient.auth.mfa.enroll({
                    factorType: 'totp',
                    issuer: 'X-ORBIT Admin'
                });
                if (error) throw error;

                pendingEnrollFactorId = data.id;
                document.getElementById('enrollQr').src = data.totp.qr_code;
                document.getElementById('enrollSecret').textContent = data.totp.secret;
                showPanel('enrollPanel');
                document.getElementById('enrollCode').value = '';
                document.getElementById('enrollCode').focus();
            } catch (err) {
                console.error('Enrollment error:', err);
                const loginError = document.getElementById('loginError');
                loginError.textContent = err.message || 'Failed to start 2FA setup.';
                loginError.classList.add('show');
                showPanel('loginPanel');
            }
        }

        async function handleTotpVerify() {
            const code     = document.getElementById('totpCode').value.trim();
            const totpBtn  = document.getElementById('totpBtn');
            const errorMsg = document.getElementById('totpError');

            if (!code) return;

            totpBtn.disabled = true;
            totpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying…';
            errorMsg.classList.remove('show');

            try {
                const { data: factors } = await supabaseClient.auth.mfa.listFactors();
                const totpFactor = factors.totp && factors.totp[0];
                if (!totpFactor) throw new Error('No TOTP factor found');

                const { error } = await supabaseClient.auth.mfa.challengeAndVerify({
                    factorId: totpFactor.id,
                    code
                });
                if (error) throw error;

                const { data: { session } } = await supabaseClient.auth.getSession();
                await enterDashboard(session.user);
            } catch (err) {
                console.error('TOTP verify error:', err);
                errorMsg.textContent = err.message || 'Invalid code. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                totpBtn.disabled = false;
                totpBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Verify';
            }
        }

        async function handleEnrollVerify() {
            const code      = document.getElementById('enrollCode').value.trim();
            const enrollBtn = document.getElementById('enrollBtn');
            const errorMsg  = document.getElementById('enrollError');

            if (!code || !pendingEnrollFactorId) return;

            enrollBtn.disabled = true;
            enrollBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activating…';
            errorMsg.classList.remove('show');

            try {
                const { error } = await supabaseClient.auth.mfa.challengeAndVerify({
                    factorId: pendingEnrollFactorId,
                    code
                });
                if (error) throw error;

                pendingEnrollFactorId = null;
                const { data: { session } } = await supabaseClient.auth.getSession();
                await enterDashboard(session.user);
            } catch (err) {
                console.error('Enrollment verify error:', err);
                errorMsg.textContent = err.message || 'Invalid code. Please try again.';
                errorMsg.classList.add('show');
            } finally {
                enrollBtn.disabled = false;
                enrollBtn.innerHTML = '<i class="fas fa-check"></i> Activate 2FA';
            }
        }

        async function enterDashboard(user) {
            currentAdmin = {
                id:        user.id,
                email:     user.email,
                full_name: user.user_metadata?.full_name || user.email
            };

            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            document.getElementById('adminName').textContent = currentAdmin.full_name;

            await loadTickets();
            loadStats();
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentAdmin = null;
            currentTicket = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            showPanel('loginPanel');
            document.getElementById('loginForm').reset();
        }

        async function loadTickets() {
            try {
                const { data, error } = await supabaseClient
                    .from('support_tickets')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allTickets = data;
                displayTickets(data);
            } catch (error) {
                console.error('Error loading tickets:', error);
            }
        }

        function displayTickets(tickets) {
            const listEl = document.getElementById('ticketList');
            const countEl = document.getElementById('navTicketCount');
            if (countEl) countEl.textContent = tickets.length;

            if (tickets.length === 0) {
                listEl.innerHTML = '<div class="no-tickets">No tickets found</div>';
                return;
            }

            listEl.innerHTML = tickets.map(ticket => `
                <div class="ticket-item ${currentTicket?.id === ticket.id ? 'active' : ''}" onclick="selectTicket('${ticket.id}')">
                    <div class="ticket-row-top">
                        <span class="ticket-id">${ticket.ticket_number}</span>
                        <span class="status-dot dot-${ticket.status}" title="${ticket.status.replace('_', ' ')}"></span>
                    </div>
                    <div class="ticket-name">${ticket.name}</div>
                    <div class="ticket-subject">${ticket.subject || ticket.message.substring(0, 48) + '…'}</div>
                    <div class="ticket-time">${formatTime(ticket.created_at)}</div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        async function selectTicket(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) return;

            currentTicket = ticket;

            document.getElementById('logsContent').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('chatContent').style.display = 'flex';

            document.getElementById('chatTicketNumber').textContent = ticket.ticket_number;
            document.getElementById('chatUserName').textContent = ticket.name;
            document.getElementById('chatUserEmail').textContent = ticket.email;
            document.getElementById('chatCategory').textContent = ticket.category;
            document.getElementById('statusSelect').value = ticket.status;
            document.getElementById('prioritySelect').value = ticket.priority;

            displayTickets(allTickets);
            await loadMessages(ticketId);
            subscribeToMessages(ticketId);
        }

        async function loadMessages(ticketId) {
            try {
                const { data: conversation, error: convError } = await supabaseClient
                    .from('conversations')
                    .select('id')
                    .eq('ticket_id', ticketId)
                    .single();

                if (convError) throw convError;

                const { data: messages, error: msgError } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .eq('conversation_id', conversation.id)
                    .order('created_at', { ascending: true });

                if (msgError) throw msgError;

                displayMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');

            container.innerHTML = messages.map(msg => {
                if (msg.sender_email === 'system@xorbit.org') {
                    return `
                        <div class="message system">
                            <div class="msg-bubble">${msg.message}</div>
                        </div>
                    `;
                }
                return `
                    <div class="message ${msg.is_staff ? 'staff' : 'user'}">
                        <div class="msg-sender">${msg.sender_name}</div>
                        <div class="msg-bubble">${msg.message}</div>
                        <div class="msg-time">${formatTime(msg.created_at)}</div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        function subscribeToMessages(ticketId) {
            if (messagesSubscription) messagesSubscription.unsubscribe();

            supabaseClient
                .from('conversations')
                .select('id')
                .eq('ticket_id', ticketId)
                .single()
                .then(({ data: conversation }) => {
                    if (conversation) {
                        messagesSubscription = supabaseClient
                            .channel('messages')
                            .on('postgres_changes', {
                                event: 'INSERT',
                                schema: 'public',
                                table: 'messages',
                                filter: `conversation_id=eq.${conversation.id}`
                            }, () => { loadMessages(ticketId); })
                            .subscribe();
                    }
                });
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message || !currentTicket) return;

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            try {
                const { data: conversation, error: convError } = await supabaseClient
                    .from('conversations')
                    .select('id')
                    .eq('ticket_id', currentTicket.id)
                    .single();

                if (convError) throw convError;

                const { error: msgError } = await supabaseClient
                    .from('messages')
                    .insert([{
                        conversation_id: conversation.id,
                        sender_name: currentAdmin.full_name,
                        sender_email: currentAdmin.email,
                        sender_admin_id: currentAdmin.id,
                        is_staff: true,
                        message: message
                    }]);

                if (msgError) throw msgError;

                messageInput.value = '';

                if (currentTicket.status === 'open') {
                    await supabaseClient
                        .from('support_tickets')
                        .update({ status: 'in_progress' })
                        .eq('id', currentTicket.id);

                    currentTicket.status = 'in_progress';
                    document.getElementById('statusSelect').value = 'in_progress';
                    await loadTickets();
                    await loadStats();
                }

                await loadMessages(currentTicket.id);

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            } finally {
                sendBtn.disabled = false;
            }
        }

        function handleMessageKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function updateTicketStatus() {
            if (!currentTicket) return;
            const newStatus = document.getElementById('statusSelect').value;
            try {
                const { error } = await supabaseClient
                    .from('support_tickets')
                    .update({ status: newStatus })
                    .eq('id', currentTicket.id);

                if (error) throw error;

                currentTicket.status = newStatus;
                await loadTickets();
                await loadStats();
                setTimeout(() => { loadMessages(currentTicket.id); }, 500);
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Failed to update status');
            }
        }

        async function updateTicketPriority() {
            if (!currentTicket) return;
            const newPriority = document.getElementById('prioritySelect').value;
            try {
                const { error } = await supabaseClient
                    .from('support_tickets')
                    .update({ priority: newPriority })
                    .eq('id', currentTicket.id);

                if (error) throw error;

                currentTicket.priority = newPriority;
                await loadTickets();
                setTimeout(() => { loadMessages(currentTicket.id); }, 500);
            } catch (error) {
                console.error('Error updating priority:', error);
                alert('Failed to update priority');
            }
        }

        async function loadStats() {
            try {
                const { data, error } = await supabaseClient
                    .from('support_tickets')
                    .select('status');

                if (error) throw error;

                const open       = data.filter(t => t.status === 'open').length;
                const inProgress = data.filter(t => t.status === 'in_progress').length;
                const waiting    = data.filter(t => t.status === 'waiting_response').length;
                const total      = data.filter(t => t.status !== 'resolved' && t.status !== 'closed').length;

                document.getElementById('statOpen').textContent       = open;
                document.getElementById('statInProgress').textContent = inProgress;
                document.getElementById('statWaiting').textContent    = waiting;
                document.getElementById('statTotal').textContent      = total;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function searchTickets() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) { displayTickets(allTickets); return; }

            const filtered = allTickets.filter(t =>
                t.ticket_number.toLowerCase().includes(query) ||
                t.name.toLowerCase().includes(query) ||
                t.email.toLowerCase().includes(query) ||
                t.subject?.toLowerCase().includes(query) ||
                t.message.toLowerCase().includes(query)
            );
            displayTickets(filtered);
        }

        function switchTab(tab, ev) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            ev.target.closest('.nav-tab').classList.add('active');
            currentView = tab;

            if (tab === 'tickets') {
                document.getElementById('ticketPanel').classList.remove('hidden');
                document.getElementById('logsContent').style.display = 'none';
                document.getElementById('adminsContent').style.display = 'none';

                if (currentTicket) {
                    document.getElementById('chatContent').style.display = 'flex';
                    document.getElementById('emptyState').style.display = 'none';
                } else {
                    document.getElementById('chatContent').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'flex';
                }
                loadTickets();

            } else if (tab === 'logs') {
                document.getElementById('ticketPanel').classList.add('hidden');
                document.getElementById('chatContent').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('logsContent').style.display = 'flex';
                document.getElementById('adminsContent').style.display = 'none';

                logsAuthToken = generateLogsAuthToken();
                setTimeout(() => {
                    const logsFrame = document.getElementById('logsFrame');
                    if (logsFrame && logsFrame.contentWindow) {
                        logsFrame.contentWindow.postMessage({
                            type: 'auth-token',
                            token: logsAuthToken
                        }, '*');
                    }
                }, 100);

            } else if (tab === 'admins') {
                document.getElementById('ticketPanel').classList.add('hidden');
                document.getElementById('chatContent').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('logsContent').style.display = 'none';
                document.getElementById('adminsContent').style.display = 'flex';
                loadClients();
            }
        }

        async function hashPassword(password) {
            const data = new TextEncoder().encode(password);
            const buf  = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateDmCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        }

        async function createXorbitUser(event) {
            event.preventDefault();
            const name     = document.getElementById('newName').value.trim();
            const email    = document.getElementById('newEmail').value.trim();
            const password = document.getElementById('newPassword').value;
            const phone    = document.getElementById('newPhone').value.trim() || null;
            const role     = document.getElementById('newRole').value;

            const btn   = document.getElementById('createUserBtn');
            const msgEl = document.getElementById('createAccountMsg');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating…';
            msgEl.style.display = 'none';
            msgEl.className = 'create-msg';

            try {
                const { data: existing } = await supabaseClient
                    .from('clients')
                    .select('id')
                    .eq('email', email)
                    .maybeSingle();

                if (existing) throw new Error(`An account with that email already exists`);

                const hashedPassword = await hashPassword(password);
                const dmCode = generateDmCode();

                const { error } = await supabaseClient
                    .from('clients')
                    .insert([{
                        name,
                        email,
                        password:   hashedPassword,
                        phone,
                        role,
                        blocked:    false,
                        ban_reason: null,
                        dm_code:    dmCode
                    }]);

                if (error) throw error;

                msgEl.className = 'create-msg success';
                msgEl.textContent = `User "${name}" created successfully.`;
                msgEl.style.display = 'block';
                document.getElementById('createUserForm').reset();
                loadClients();

            } catch (error) {
                console.error('Error creating user:', error);
                msgEl.className = 'create-msg error';
                msgEl.textContent = error.message || 'Failed to create user.';
                msgEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plus"></i> Create User';
            }
        }

        async function loadClients() {
            const submEl   = document.getElementById('submittersList');
            const usersEl  = document.getElementById('xorbitUsersList');

            submEl.innerHTML  = '<div class="loading-spinner"><i class="fas fa-spinner"></i> Loading…</div>';
            usersEl.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i> Loading…</div>';

            // ── Ticket submitters (from support_tickets) ──────────────
            try {
                const { data: tickets, error } = await supabaseClient
                    .from('support_tickets')
                    .select('name, email, created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const map = {};
                tickets.forEach(t => {
                    if (!map[t.email]) {
                        map[t.email] = { name: t.name, email: t.email, count: 0, last: t.created_at };
                    }
                    map[t.email].count++;
                });

                const submitters = Object.values(map);

                if (submitters.length === 0) {
                    submEl.innerHTML = '<div class="no-tickets">No ticket submitters found</div>';
                } else {
                    submEl.innerHTML = submitters.map(s => `
                        <div class="client-item">
                            <div>
                                <div class="client-name">${s.name}</div>
                                <div class="client-email">${s.email}</div>
                            </div>
                            <div class="client-meta">
                                <span class="client-ticket-count">${s.count} ticket${s.count !== 1 ? 's' : ''}</span>
                                <span class="client-last-seen">${formatTime(s.last)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading submitters:', err);
                submEl.innerHTML = '<div class="no-tickets">Failed to load submitters</div>';
            }

            // ── X-ORBIT users (from clients table) ───────────────────
            try {
                const { data: users, error } = await supabaseClient
                    .from('clients')
                    .select('id, name, email, phone, role, blocked, ban_reason, created_at')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!users || users.length === 0) {
                    usersEl.innerHTML = '<div class="no-tickets">No X-ORBIT users found</div>';
                } else {
                    xorbitClients = users;
                    usersEl.innerHTML = users.map(u => `
                        <div class="client-item">
                            <div>
                                <div class="client-name">${u.name}</div>
                                <div class="client-email">${u.email}</div>
                                <div class="client-badges">
                                    <span class="role-badge role-${u.role}">${u.role}</span>
                                    ${u.blocked ? `<span class="banned-badge" title="${u.ban_reason || ''}">blocked</span>` : ''}
                                </div>
                            </div>
                            <div class="client-meta">
                                <button class="edit-btn" onclick="openEditModal('${u.id}')"><i class="fas fa-pen"></i></button>
                                <span class="client-last-seen">${formatTime(u.created_at)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading X-ORBIT users:', err);
                usersEl.innerHTML = '<div class="no-tickets">Failed to load users</div>';
            }
        }

        function openEditModal(id) {
            const user = xorbitClients.find(u => String(u.id) === String(id));
            if (!user) return;

            document.getElementById('editClientId').value   = user.id;
            document.getElementById('editName').value       = user.name || '';
            document.getElementById('editEmail').value      = user.email || '';
            document.getElementById('editPhone').value      = user.phone || '';
            document.getElementById('editRole').value       = user.role || 'standard';
            document.getElementById('editBlocked').value    = user.blocked ? 'true' : 'false';
            document.getElementById('editBanReason').value  = user.ban_reason || '';

            const msgEl = document.getElementById('editClientMsg');
            msgEl.style.display = 'none';
            msgEl.className = 'create-msg';

            document.getElementById('editClientModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editClientModal').style.display = 'none';
        }

        async function saveClientEdit() {
            const id        = document.getElementById('editClientId').value;
            const name      = document.getElementById('editName').value.trim();
            const email     = document.getElementById('editEmail').value.trim();
            const phone     = document.getElementById('editPhone').value.trim() || null;
            const role      = document.getElementById('editRole').value;
            const blocked   = document.getElementById('editBlocked').value === 'true';
            const banReason = document.getElementById('editBanReason').value.trim() || null;

            const btn   = document.getElementById('saveClientBtn');
            const msgEl = document.getElementById('editClientMsg');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving…';
            msgEl.style.display = 'none';
            msgEl.className = 'create-msg';

            try {
                const { error } = await supabaseClient
                    .from('clients')
                    .update({ name, email, phone, role, blocked, ban_reason: banReason })
                    .eq('id', id);

                if (error) throw error;

                msgEl.className = 'create-msg success';
                msgEl.textContent = 'Changes saved.';
                msgEl.style.display = 'block';

                loadClients();

            } catch (err) {
                console.error('Error saving client:', err);
                msgEl.className = 'create-msg error';
                msgEl.textContent = err.message || 'Failed to save changes.';
                msgEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Save Changes';
            }
        }

        window.addEventListener('message', (event) => {
            if (event.data === 'logs-ready') {
                console.log('Logs viewer is ready and authenticated');
            } else if (event.data && event.data.type === 'request-auth') {
                if (!logsAuthToken) logsAuthToken = generateLogsAuthToken();

                const logsFrame = document.getElementById('logsFrame');
                if (logsFrame && logsFrame.contentWindow) {
                    logsFrame.contentWindow.postMessage({
                        type: 'auth-token',
                        token: logsAuthToken
                    }, '*');
                }
            }
        });

        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentAdmin = null;
                currentTicket = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                showPanel('loginPanel');
            }
        });

        window.addEventListener('load', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) return;

            const { data: aalData } = await supabaseClient.auth.mfa.getAuthenticatorAssuranceLevel();

            if (aalData.nextLevel === 'aal2' && aalData.currentLevel !== 'aal2') {
                // Session exists but TOTP not yet verified (e.g. refreshed mid-login)
                showPanel('totpPanel');
                document.getElementById('totpCode').value = '';
                document.getElementById('totpCode').focus();
                return;
            }

            await enterDashboard(session.user);
        });

        setInterval(() => {
            if (currentAdmin && currentView === 'tickets') {
                loadTickets();
                loadStats();
            }
        }, 30000);

        setInterval(() => {
            if (currentAdmin && currentTicket) {
                loadMessages(currentTicket.id);
            }
        }, 15000);
    </script>
</body>
</html>
