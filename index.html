<!DOCTYPE html>
<html lang="en">
  <head>
    <link
      rel="icon"
      href="https://codehs.com/uploads/7f204d91a682cb833441eb2fc59228b6"
      type="image/png"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>X-ORBIT Desktop</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <!-- Theme stylesheet will be loaded dynamically -->
    <link id="theme-stylesheet" rel="stylesheet" href="theme-dark.css" />
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: radial-gradient(
          ellipse at top,
          #1a0033 0%,
          #0d001a 50%,
          #000014 100%
        );
        background-attachment: fixed;
        color: #f8faff;
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        cursor: default;
        user-select: none;
        margin: 0;
        padding: 0;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 40, 255, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(60, 130, 255, 0.15) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 80%,
            rgba(180, 40, 255, 0.1) 0%,
            transparent 50%
          );
        pointer-events: none;
        z-index: 0;
      }

      body::after {
        content: "\f57d"; /* Font Awesome globe icon */
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 25rem;
        color: rgba(120, 80, 255, 0.08);
        pointer-events: none;
        z-index: 0;
        text-shadow: 0 0 100px rgba(120, 80, 255, 0.3),
          0 0 200px rgba(120, 80, 255, 0.2);
      }

      /* Halloween Theme - Pumpkin */
      body.halloween-theme::after {
        content: "ðŸŽƒ";
        font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
          "Noto Color Emoji";
        font-weight: normal;
        font-size: 30rem;
        color: transparent;
        text-shadow: none;
        filter: drop-shadow(0 0 100px rgba(255, 140, 0, 0.4))
          drop-shadow(0 0 200px rgba(255, 140, 0, 0.3));
      }

      .menu-bar {
        height: 32px;
        background: rgba(15, 15, 35, 0.6);
        backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        display: flex;
        align-items: center;
        padding: 0 16px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #e8f0ff;
        border-bottom: 1px solid rgba(120, 80, 255, 0.2);
        box-shadow: 0 1px 0 0 rgba(255, 255, 255, 0.1) inset,
          0 4px 16px rgba(0, 0, 0, 0.4);
        position: relative;
        z-index: 1000;
        justify-content: space-between;
      }

      .menu-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .menu-center {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .menu-right {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.8rem;
      }

      .menu-item {
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .menu-item:hover {
        background: rgba(120, 80, 255, 0.2);
      }

      .desktop {
        flex: 1;
        position: relative;
        overflow: hidden;
        background: transparent;
        width: 100%;
        height: 100vh;
      }

      .desktop-icons {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        z-index: 10;
      }

      .desktop-icon {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 12px;
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 80px;
        text-align: center;
      }

      .desktop-icon:hover {
        background: rgba(120, 80, 255, 0.2);
        transform: scale(1.05);
        box-shadow: 0 8px 32px rgba(120, 80, 255, 0.3);
      }

      .desktop-icon:active {
        transform: scale(0.95);
      }

      .desktop-icon i {
        font-size: 2rem;
        color: #d0d8ff;
        filter: drop-shadow(0 2px 8px rgba(120, 80, 255, 0.3));
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .desktop-icon:hover i {
        color: #ffffff;
        filter: drop-shadow(0 4px 12px rgba(120, 80, 255, 0.5));
      }

      .desktop-icon span {
        font-size: 0.75rem;
        color: #e8f0ff;
        font-weight: 500;
        max-width: 100%;
        word-wrap: break-word;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .desktop-icon:hover span {
        color: #ffffff;
      }
      .window {
        position: absolute;
        min-width: 400px;
        min-height: 300px;
        max-width: calc(100vw - 40px) !important;
        max-height: calc(100vh - 112px) !important;
        background: rgba(20, 15, 40, 0.4);
        backdrop-filter: blur(40px) saturate(1.8) brightness(1.1);
        -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.1);
        border-radius: 16px;
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.15) inset,
          0 12px 48px rgba(0, 0, 0, 0.4),
          0 24px 80px rgba(120, 80, 255, 0.15);
        border: 1px solid rgba(120, 80, 255, 0.15);
        display: flex;
        flex-direction: column;
        z-index: 100;
        resize: both;
        overflow: hidden;
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        transform-origin: center center;
        transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .window.window-visible {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      .window.active {
        z-index: 200;
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.2) inset,
          0 16px 64px rgba(0, 0, 0, 0.5),
          0 32px 96px rgba(120, 80, 255, 0.2);
      }

      .window.fullscreen {
        position: fixed !important;
        top: 32px !important;
        left: 0 !important;
        min-width: 100vw;
        min-height: calc(100vh - 32px);
        resize: none;
        border-radius: 0 !important;
        border-top: none !important;
        margin-top: 0 !important;
      }

      .window.fullscreen .window-titlebar {
        border-radius: 0 !important;
      }

      .window.fullscreen .window-content {
        border-radius: 0 !important;
      }

      .window-titlebar {
        height: 44px;
        background: rgba(30, 25, 50, 0.6);
        backdrop-filter: blur(20px);
        display: flex;
        align-items: center;
        padding: 0 16px;
        border-radius: 16px 16px 0 0;
        border-bottom: 1px solid rgba(120, 80, 255, 0.1);
        cursor: move;
        user-select: none;
      }

      .window-controls {
        display: flex;
        gap: 10px;
        margin-right: 16px;
      }

      .window-control {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .window-control.close {
        color: #ff5f57;
      }

      .window-control.close:hover {
        background: #ff5f57;
        color: white;
        border-color: #ff5f57;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(255, 95, 87, 0.4);
      }

      .window-control.close::before {
        content: "\f00d";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
      }

      .window-control.minimize {
        color: #ffbd2e;
      }

      .window-control.minimize:hover {
        background: #ffbd2e;
        color: white;
        border-color: #ffbd2e;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(255, 189, 46, 0.4);
      }

      .window-control.minimize::before {
        content: "\f2d1";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
      }

      .window-control.maximize {
        color: #28ca42;
      }

      .window-control.maximize:hover {
        background: #28ca42;
        color: white;
        border-color: #28ca42;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(40, 202, 66, 0.4);
      }

      .window-control.maximize::before {
        content: "\f2d0";
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
      }

      .window-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: #e8f0ff;
        flex: 1;
      }

      .window-content {
        flex: 1;
        background: rgba(10, 10, 25, 0.3);
        border-radius: 0 0 16px 16px;
        overflow: hidden;
      }

      .window-content iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: transparent;
      }

      .dock {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 15, 40, 0.5);
        backdrop-filter: blur(60px) saturate(2) brightness(1.3);
        -webkit-backdrop-filter: blur(60px) saturate(2) brightness(1.3);
        border-radius: 24px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.2) inset,
          0 12px 48px rgba(0, 0, 0, 0.4),
          0 24px 60px rgba(120, 80, 255, 0.25);
        border: 1px solid rgba(120, 80, 255, 0.2);
        z-index: 1000;
      }

      .dock-item {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        background: rgba(120, 80, 255, 0.1);
        border: 1px solid rgba(120, 80, 255, 0.2);
      }

      .dock-item:hover {
        transform: translateY(-8px) scale(1.15);
        box-shadow: 0 0 30px rgba(120, 80, 255, 0.4),
          0 12px 24px rgba(0, 0, 0, 0.4);
        background: rgba(120, 80, 255, 0.2);
      }

      .dock-item.active::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 6px;
        height: 6px;
        background: rgba(120, 80, 255, 0.8);
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(120, 80, 255, 0.6);
      }

      .dock-item i {
        font-size: 1.5rem;
        color: #d0d8ff;
        z-index: 1;
        position: relative;
      }

      .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-8px);
        background: rgba(30, 25, 50, 0.9);
        backdrop-filter: blur(20px);
        color: #e8f0ff;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(120, 80, 255, 0.2);
        z-index: 10002;
        margin-bottom: 8px;
      }

      .dock-item:hover .tooltip {
        opacity: 1;
        transform: translateX(-50%) translateY(-8px);
      }

      /* Startup Screen */
      @keyframes startupScreenFadeIn {
        from { opacity: 0; }
        to   { opacity: 1; }
      }

      #startupScreen {
        position: fixed;
        z-index: 10000;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #000014;
        display: flex;
        align-items: stretch;
        justify-content: flex-start;
        opacity: 1;
        animation: startupScreenFadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) both;
        transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #startupScreen::after {
        content: "";
        position: absolute;
        top: 0;
        left: 480px;
        right: 0;
        bottom: 0;
        background: url("https://codehs.com/uploads/4172b2f0b44709a295bd992b1757f9f4") center center / cover no-repeat;
        z-index: 0;
      }

      @media (max-width: 600px) {
        #startupScreen::after { display: none; }
      }

      #startupScreen.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      .startup-content {
        text-align: left;
        animation: startupFadeIn 1s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        padding: 4rem 3.5rem;
        width: 100%;
        max-width: 480px;
        min-height: 100vh;
        background: rgba(4, 1, 10, 0.88);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-right: 1px solid rgba(120, 80, 255, 0.15);
        box-shadow: 4px 0 40px rgba(0, 0, 0, 0.5);
        position: relative;
        z-index: 1;
      }

      .startup-icon {
        font-size: 4rem;
        color: #7d5cff;
        margin-bottom: 20px;
        display: block;
        animation: startupPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite,
          startupRotate 20s linear infinite;
        text-shadow: 0 0 30px rgba(120, 80, 255, 0.6),
          0 0 60px rgba(120, 80, 255, 0.4);
      }

      .startup-text {
        font-size: 2.8rem;
        font-weight: 700;
        color: #e8f0ff;
        margin-bottom: 6px;
        letter-spacing: 6px;
        text-shadow: 0 0 20px rgba(120, 80, 255, 0.5);
      }

      .startup-version {
        font-size: 0.85rem;
        color: #6b7a9e;
        margin-bottom: 3rem;
        letter-spacing: 2px;
      }

      .startup-progress-container {
        width: 100%;
        height: 4px;
        background: rgba(120, 80, 255, 0.2);
        border-radius: 2px;
        margin: 0 0 12px;
        overflow: hidden;
        box-shadow: 0 0 10px rgba(120, 80, 255, 0.3) inset;
      }

      .startup-progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #7d5cff 0%, #3c82ff 100%);
        border-radius: 2px;
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.8),
          0 0 40px rgba(120, 80, 255, 0.4);
        animation: progressGlow 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }

      .startup-status {
        font-size: 0.82rem;
        color: #6b7a9e;
        margin-bottom: 2.5rem;
        animation: statusBlink 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }

      .startup-continue-btn {
        width: 100%;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: none;
        color: #fff;
        font-size: 0.95rem;
        font-weight: 700;
        font-family: "Inter", -apple-system, sans-serif;
        letter-spacing: 1.5px;
        text-transform: uppercase;
        cursor: pointer;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 24px rgba(120, 80, 255, 0.45),
          0 8px 20px rgba(0, 0, 0, 0.2);
        animation: continueButtonPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }

      .startup-continue-btn:hover {
        transform: translateY(-2px);
        background: linear-gradient(135deg, #6d28d9 0%, #7c3aed 100%);
        box-shadow: 0 8px 36px rgba(120, 80, 255, 0.65),
          0 12px 30px rgba(0, 0, 0, 0.3);
      }

      .startup-continue-btn:active {
        transform: translateY(0);
      }

      @keyframes continueButtonPulse {
        0%, 100% {
          box-shadow: 0 4px 24px rgba(120, 80, 255, 0.45),
            0 8px 20px rgba(0, 0, 0, 0.2);
        }
        50% {
          box-shadow: 0 4px 36px rgba(120, 80, 255, 0.65),
            0 8px 24px rgba(0, 0, 0, 0.3);
        }
      }

      @media (max-width: 600px) {
        .startup-content {
          max-width: 100%;
          border-right: none;
          padding: 3rem 2rem;
        }
      }

      .fullscreen-prompt {
        margin-top: 32px;
        padding: 14px 28px;
        background: linear-gradient(
          135deg,
          rgba(120, 80, 255, 0.3) 0%,
          rgba(60, 130, 255, 0.3) 100%
        );
        border: 2px solid rgba(120, 80, 255, 0.5);
        border-radius: 14px;
        color: #e8f0ff;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: pulseGlow 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }

      .fullscreen-prompt:hover {
        background: linear-gradient(
          135deg,
          rgba(120, 80, 255, 0.5) 0%,
          rgba(60, 130, 255, 0.5) 100%
        );
        border-color: rgba(120, 80, 255, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(120, 80, 255, 0.4);
      }

      .fullscreen-prompt i {
        font-size: 1.1rem;
      }

      @keyframes pulseGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(120, 80, 255, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(120, 80, 255, 0.6);
        }
      }

      @keyframes startupFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes startupPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes startupRotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      @keyframes progressGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(120, 80, 255, 0.8),
            0 0 40px rgba(120, 80, 255, 0.4);
        }
        50% {
          box-shadow: 0 0 30px rgba(120, 80, 255, 1),
            0 0 60px rgba(120, 80, 255, 0.6);
        }
      }

      @keyframes statusBlink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      #welcomeOverlay {
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100vw;
        background: rgba(10, 5, 25, 0.9);
        backdrop-filter: blur(60px) saturate(2);
        -webkit-backdrop-filter: blur(60px) saturate(2);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #welcomeOverlay.fade-in {
        opacity: 1;
      }

      @media (max-width: 768px) {
        .desktop-icons {
          position: static;
          flex-direction: row;
          flex-wrap: wrap;
          margin: 20px;
          gap: 12px;
        }

        .dock {
          bottom: 8px;
          padding: 8px 12px;
          gap: 8px;
        }

        .dock-item {
          width: 48px;
          height: 48px;
        }

        .window {
          min-width: 280px;
          min-height: 200px;
        }
      }

      @keyframes windowOpen {
        0% {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        100% {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .window-opening {
        animation: windowOpen 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      /* Light mode styles */
      body.light-mode {
        background: linear-gradient(135deg, #f8faff 0%, #e8f0ff 100%);
        color: #1a1a2e;
      }

      body.light-mode::after {
        color: rgba(120, 80, 255, 0.12);
        text-shadow: 0 0 100px rgba(120, 80, 255, 0.2),
          0 0 200px rgba(120, 80, 255, 0.1);
      }

      body.light-mode::before {
        background: radial-gradient(
            circle at 20% 50%,
            rgba(120, 80, 255, 0.08) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(60, 130, 255, 0.08) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 80%,
            rgba(180, 40, 255, 0.06) 0%,
            transparent 50%
          );
      }

      body.light-mode .menu-bar {
        background: rgba(248, 250, 255, 0.8);
        color: #1a1a2e;
        border-bottom: 1px solid rgba(120, 80, 255, 0.3);
      }

      body.light-mode .window {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(120, 80, 255, 0.2);
        color: #1a1a2e;
      }

      body.light-mode .window-titlebar {
        background: rgba(248, 250, 255, 0.9);
        border-bottom: 1px solid rgba(120, 80, 255, 0.2);
      }

      body.light-mode .window-title {
        color: #1a1a2e;
      }

      body.light-mode .dock {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(120, 80, 255, 0.3);
      }

      body.light-mode .dock-item {
        background: rgba(120, 80, 255, 0.08);
        border: 1px solid rgba(120, 80, 255, 0.15);
      }

      body.light-mode .desktop-icon {
        color: #1a1a2e;
      }

      body.light-mode .desktop-icon i {
        color: #3c4560;
      }

      /* No transparency mode */
      body.no-transparency .window,
      body.no-transparency .dock,
      body.no-transparency .menu-bar {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }

      body.no-transparency .window {
        background: rgba(20, 15, 40, 0.95) !important;
      }

      body.no-transparency.light-mode .window {
        background: rgba(255, 255, 255, 0.95) !important;
      }

      /* No animations mode */
      body.no-animations * {
        transition: none !important;
        animation: none !important;
      }

      /* Dock auto-hide styles */
      .dock.dock-autohide {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
        pointer-events: none;
      }

      /* Hide dock based on position */
      .dock.dock-autohide[style*="bottom"] {
        transform: translateX(-50%) translateY(calc(100% + 20px));
      }

      .dock.dock-autohide[style*="top"] {
        transform: translateX(-50%) translateY(calc(-100% - 20px));
      }

      .dock.dock-autohide[style*="left"][style*="column"] {
        transform: translateY(-50%) translateX(calc(-100% - 20px));
      }

      .dock.dock-autohide[style*="right"][style*="column"] {
        transform: translateY(-50%) translateX(calc(100% + 20px));
      }

      /* Show dock when visible */
      .dock.dock-autohide.dock-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .dock.dock-autohide.dock-visible[style*="bottom"] {
        transform: translateX(-50%) translateY(0);
      }

      .dock.dock-autohide.dock-visible[style*="top"] {
        transform: translateX(-50%) translateY(0);
      }

      .dock.dock-autohide.dock-visible[style*="left"][style*="column"] {
        transform: translateY(-50%) translateX(0);
      }

      .dock.dock-autohide.dock-visible[style*="right"][style*="column"] {
        transform: translateY(-50%) translateX(0);
      }

      /* X-ORBIT Menu Dropdown */
      .xorbit-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: rgba(20, 15, 40, 0.9);
        backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        border-radius: 14px;
        border: 1px solid rgba(120, 80, 255, 0.2);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        min-width: 220px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        z-index: 10001;
        margin-top: 8px;
      }

      .xorbit-menu.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .xorbit-menu-item {
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 10px;
        margin: 6px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        color: #e8f0ff;
      }

      .xorbit-menu-item:first-child {
        margin-top: 6px;
      }

      .xorbit-menu-item:last-child {
        margin-bottom: 6px;
      }

      .xorbit-menu-item:hover {
        background: rgba(120, 80, 255, 0.2);
        color: #ffffff;
        transform: translateX(2px);
      }

      .xorbit-menu-item i {
        width: 16px;
        text-align: center;
        color: #a8b4d9;
      }

      .xorbit-menu-item:hover i {
        color: #7d5cff;
      }

      .xorbit-menu-divider {
        height: 1px;
        background: rgba(120, 80, 255, 0.2);
        margin: 6px 12px;
      }

      .xorbit-menu-item.danger {
        color: #ff6b6b;
      }

      .xorbit-menu-item.danger:hover {
        background: rgba(255, 107, 107, 0.2);
        color: #ff8a8a;
      }

      .xorbit-menu-item.danger i {
        color: #ff6b6b;
      }

      .menu-item.xorbit-title {
        position: relative;
      }

      /* Light mode menu */
      body.light-mode .xorbit-menu {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(120, 80, 255, 0.3);
      }

      body.light-mode .xorbit-menu-item {
        color: #1a1a2e;
      }

      body.light-mode .xorbit-menu-item:hover {
        background: rgba(120, 80, 255, 0.15);
        color: #000;
      }

      body.light-mode .xorbit-menu-item i {
        color: #64748b;
      }

      body.light-mode .xorbit-menu-item:hover i {
        color: #7d5cff;
      }

      body.light-mode .xorbit-menu-divider {
        background: rgba(120, 80, 255, 0.3);
      }

      /* Time/Weather Dropdown */
      .time-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: rgba(20, 15, 40, 0.9);
        backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        -webkit-backdrop-filter: blur(40px) saturate(1.8) brightness(1.2);
        border-radius: 16px;
        border: 1px solid rgba(120, 80, 255, 0.2);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        min-width: 320px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        z-index: 10001;
        margin-top: 8px;
        padding: 20px;
      }

      .time-menu.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .time-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(120, 80, 255, 0.2);
      }

      .time-display {
        font-size: 2rem;
        font-weight: 600;
        color: #e8f0ff;
        margin-bottom: 4px;
        font-family: "Inter", monospace;
      }

      .date-display {
        font-size: 1rem;
        color: #a8b4d9;
        margin-bottom: 8px;
      }

      .timezone-display {
        font-size: 0.85rem;
        color: #7d5cff;
        font-weight: 500;
      }

      .weather-section {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        padding: 16px;
        background: rgba(120, 80, 255, 0.1);
        border-radius: 14px;
        border: 1px solid rgba(120, 80, 255, 0.2);
      }

      .weather-icon {
        font-size: 2.5rem;
        width: 60px;
        text-align: center;
      }

      .weather-info {
        flex: 1;
      }

      .weather-temp {
        font-size: 1.5rem;
        font-weight: 600;
        color: #e8f0ff;
        margin-bottom: 2px;
      }

      .weather-desc {
        font-size: 0.9rem;
        color: #a8b4d9;
        margin-bottom: 4px;
      }

      .weather-location {
        font-size: 0.8rem;
        color: #7d5cff;
        font-weight: 500;
      }

      .weather-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .weather-detail {
        background: rgba(255, 255, 255, 0.03);
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(120, 80, 255, 0.1);
        text-align: center;
      }

      .weather-detail-label {
        font-size: 0.75rem;
        color: #a8b4d9;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .weather-detail-value {
        font-size: 0.95rem;
        color: #e8f0ff;
        font-weight: 600;
      }

      .location-section {
        text-align: center;
        padding-top: 12px;
        border-top: 1px solid rgba(120, 80, 255, 0.2);
      }

      .location-text {
        font-size: 0.85rem;
        color: #a8b4d9;
        margin-bottom: 8px;
      }

      .location-update {
        font-size: 0.75rem;
        color: #7d5cff;
        cursor: pointer;
        transition: color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .location-update:hover {
        color: #9d7cff;
      }

      .menu-item.time-item {
        position: relative;
        cursor: pointer;
      }

      /* Light mode time menu */
      body.light-mode .time-menu {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(120, 80, 255, 0.3);
      }

      body.light-mode .time-display {
        color: #1a1a2e;
      }

      body.light-mode .weather-temp {
        color: #1a1a2e;
      }

      body.light-mode .weather-detail-value {
        color: #1a1a2e;
      }

      body.light-mode .weather-section {
        background: rgba(120, 80, 255, 0.08);
      }

      body.light-mode .weather-detail {
        background: rgba(120, 80, 255, 0.05);
        border: 1px solid rgba(120, 80, 255, 0.15);
      }

      /* Tutorial/Guide Overlay - Simplified and Fixed */
      .tutorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 15000;
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .tutorial-overlay.show {
        display: flex;
        opacity: 1;
      }

      .tutorial-content {
        background: rgba(20, 15, 40, 0.95);
        backdrop-filter: blur(40px) saturate(1.8);
        -webkit-backdrop-filter: blur(40px) saturate(1.8);
        border-radius: 24px;
        border: 2px solid rgba(120, 80, 255, 0.5);
        box-shadow: 0 0 1px rgba(255, 255, 255, 0.1) inset,
          0 24px 80px rgba(0, 0, 0, 0.8),
          0 32px 96px rgba(120, 80, 255, 0.3);
        padding: 40px;
        max-width: 500px;
        width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        transform: scale(0.8) translateY(20px);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
      }

      .tutorial-overlay.show .tutorial-content {
        transform: scale(1) translateY(0);
      }

      .tutorial-header {
        text-align: center;
        margin-bottom: 24px;
      }

      .tutorial-icon {
        font-size: 3rem;
        color: #7d5cff;
        margin-bottom: 16px;
        display: block;
      }

      .tutorial-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #e8f0ff;
        margin-bottom: 8px;
      }

      .tutorial-step {
        font-size: 0.9rem;
        color: #a8b4d9;
        margin-bottom: 16px;
      }

      .tutorial-description {
        color: #e8f0ff;
        line-height: 1.6;
        margin-bottom: 24px;
        font-size: 0.95rem;
      }

      .tutorial-highlight {
        background: rgba(120, 80, 255, 0.2);
        padding: 16px;
        border-radius: 14px;
        border: 1px solid rgba(120, 80, 255, 0.3);
        margin-bottom: 24px;
      }

      .tutorial-highlight-title {
        color: #7d5cff;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 0.9rem;
      }

      .tutorial-highlight-text {
        color: #d0d8ff;
        font-size: 0.85rem;
        line-height: 1.4;
      }

      .tutorial-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
      }

      .tutorial-progress {
        display: flex;
        gap: 8px;
      }

      .tutorial-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(120, 80, 255, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .tutorial-dot.active {
        background: #7d5cff;
        transform: scale(1.2);
      }

      .tutorial-buttons {
        display: flex;
        gap: 12px;
      }

      .tutorial-btn {
        padding: 10px 20px;
        border-radius: 12px;
        border: none;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tutorial-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #a8b4d9;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .tutorial-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #e8f0ff;
      }

      .tutorial-btn.primary {
        background: linear-gradient(135deg, #7d5cff 0%, #3c82ff 100%);
        color: white;
        border: 1px solid rgba(120, 80, 255, 0.3);
      }

      .tutorial-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(120, 80, 255, 0.4);
      }

      .tutorial-config-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 20px;
        background: rgba(120, 80, 255, 0.15);
        border: 2px solid rgba(120, 80, 255, 0.3);
        border-radius: 14px;
        color: #e8f0ff;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        justify-content: center;
      }

      .tutorial-config-btn:hover {
        background: rgba(120, 80, 255, 0.25);
        border-color: rgba(120, 80, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(120, 80, 255, 0.3);
      }

      .tutorial-config-btn.selected {
        background: rgba(120, 80, 255, 0.4);
        border-color: rgba(120, 80, 255, 0.7);
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.4);
      }

      .tutorial-config-btn i {
        font-size: 1.2rem;
        color: #7d5cff;
      }

      /* Tutorial highlighting effects */
      .tutorial-highlight-element {
        position: relative;
        z-index: 14000;
      }

      .tutorial-highlight-element::before {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border: 2px solid #7d5cff;
        border-radius: inherit;
        box-shadow: 0 0 20px rgba(120, 80, 255, 0.6),
          0 0 40px rgba(120, 80, 255, 0.3);
        animation: tutorialPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        pointer-events: none;
      }

      @keyframes tutorialPulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.7;
          transform: scale(1.02);
        }
      }

      /* Light mode tutorial */
      body.light-mode .tutorial-overlay {
        background: rgba(255, 255, 255, 0.9);
      }

      body.light-mode .tutorial-content {
        background: rgba(255, 255, 255, 0.98);
        border: 2px solid rgba(120, 80, 255, 0.5);
        box-shadow: 0 0 1px rgba(120, 80, 255, 0.1) inset,
          0 24px 80px rgba(0, 0, 0, 0.2),
          0 32px 96px rgba(120, 80, 255, 0.2);
      }

      body.light-mode .tutorial-title {
        color: #1a1a2e;
      }

      body.light-mode .tutorial-description {
        color: #3c4560;
      }

      body.light-mode .tutorial-highlight {
        background: rgba(120, 80, 255, 0.1);
        border: 1px solid rgba(120, 80, 255, 0.3);
      }

      body.light-mode .tutorial-highlight-text {
        color: #1a1a2e;
      }

      /* Mobile tutorial adjustments */
      @media (max-width: 768px) {
        .tutorial-content {
          width: 95vw;
          padding: 30px 20px;
          max-height: 85vh;
        }

        .tutorial-icon {
          font-size: 2.5rem;
          margin-bottom: 16px;
        }

        .tutorial-title {
          font-size: 1.4rem;
          margin-bottom: 8px;
        }

        .tutorial-description {
          font-size: 0.95rem;
          margin-bottom: 20px;
          text-align: left;
        }

        .tutorial-highlight {
          padding: 16px;
          margin-bottom: 20px;
        }

        .tutorial-highlight-text {
          text-align: left;
        }

        .tutorial-controls {
          margin-top: 20px;
        }

        .tutorial-buttons {
          flex-wrap: wrap;
          gap: 8px;
        }

        .tutorial-btn {
          min-width: 100px;
          padding: 12px 16px;
        }

        .tutorial-btn span {
          font-size: 0.9rem;
        }
      }
      /* â”€â”€ Software Update: Download Progress Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .update-progress-overlay {
        position: absolute;
        inset: 0;
        background: rgba(14, 10, 30, 0.96);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 14px;
        display: none;
        flex-direction: column;
        align-items: stretch;
        justify-content: center;
        padding: 32px 28px 28px;
        z-index: 10;
        animation: updateFadeIn 0.25s ease;
      }
      .update-progress-overlay.show { display: flex; }

      /* Cancel button â€” macOS traffic-light style */
      .update-cancel-btn {
        position: absolute;
        top: 14px;
        left: 16px;
        width: 13px;
        height: 13px;
        border-radius: 50%;
        background: rgba(255, 87, 87, 0.85);
        border: none;
        cursor: pointer;
        transition: opacity 0.15s;
        display: flex; align-items: center; justify-content: center;
        font-size: 0px; /* hide icon by default */
        color: rgba(100,0,0,0.8);
        z-index: 11;
      }
      .update-cancel-btn:hover { opacity: 0.75; font-size: 8px; }

      /* App icon row */
      .update-progress-icon {
        display: block;
        font-size: 2rem;
        color: #8b6fff;
        text-align: center;
        margin-bottom: 12px;
      }
      @keyframes updateSpinPulse {
        0%, 100% { opacity: 1; }
        50%       { opacity: 0.6; }
      }

      /* Title + status */
      .update-progress-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #e8e0ff;
        text-align: center;
        margin-bottom: 4px;
        letter-spacing: -0.01em;
      }
      .update-progress-status {
        font-size: 0.78rem;
        color: rgba(160, 148, 210, 0.8);
        text-align: center;
        margin-bottom: 20px;
        min-height: 1.1em;
      }

      /* â”€â”€ The progress bar itself â”€â”€ */
      .update-progress-row {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 0;
      }
      .update-progress-bar-container {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 99px;
        overflow: hidden;
      }
      .update-progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #7d5cff 0%, #5b8fff 100%);
        border-radius: 99px;
        transition: width 0.45s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .update-progress-bar::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.28) 50%, transparent 100%);
        animation: progressShine 1.8s ease-in-out infinite;
      }
      @keyframes progressShine {
        0%   { transform: translateX(-100%); }
        100% { transform: translateX(300%); }
      }

      /* Percent + time row */
      .update-progress-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .update-progress-percent {
        font-size: 0.75rem;
        font-weight: 600;
        color: rgba(180, 168, 230, 0.9);
        font-variant-numeric: tabular-nums;
        min-width: 34px;
      }
      .update-progress-time {
        font-size: 0.72rem;
        color: rgba(140, 128, 190, 0.7);
        text-align: right;
      }

      /* Success state */
      .update-progress-icon.success {
        color: #34c759 !important;
        animation: successBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes successBounce {
        0%   { transform: scale(0.7); opacity: 0; }
        100% { transform: scale(1);   opacity: 1; }
      }

      /* Light mode */
      body.light-mode .update-progress-overlay { background: rgba(245, 243, 255, 0.97); }
      body.light-mode .update-progress-title   { color: #1c1830; }
      body.light-mode .update-progress-status  { color: rgba(80, 70, 120, 0.8); }
      body.light-mode .update-progress-bar-container { background: rgba(0,0,0,0.1); }
      body.light-mode .update-progress-percent { color: rgba(80, 70, 120, 0.9); }
      body.light-mode .update-progress-time    { color: rgba(100, 90, 140, 0.7); }
      /* Update Notification Badge */
      .update-notification-badge {
        position: fixed;
        top: 48px;
        right: -350px;
        background: linear-gradient(
          135deg,
          rgba(255, 87, 87, 0.95) 0%,
          rgba(255, 107, 107, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 14px;
        padding: 16px 20px;
        box-shadow: 0 12px 48px rgba(255, 87, 87, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        border: 1px solid rgba(255, 87, 87, 0.5);
        z-index: 9999;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 320px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .update-notification-badge.show {
        right: 20px;
      }

      .update-notification-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 56px rgba(255, 87, 87, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.3) inset;
      }

      .update-notification-icon {
        font-size: 1.5rem;
        color: #ffffff;
        flex-shrink: 0;
      }

      .update-notification-content {
        flex: 1;
      }

      .update-notification-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 4px;
      }

      .update-notification-text {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.3;
      }

      .update-notification-close {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #ffffff;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
      }

      .update-notification-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      /* Red indicator dot on System settings nav item */
      .settings-nav-item .update-indicator {
        width: 8px;
        height: 8px;
        background: #ff5757;
        border-radius: 50%;
        position: absolute;
        top: 14px;
        right: 12px;
        box-shadow: 0 0 12px rgba(255, 87, 87, 0.6);
        animation: updateIndicatorPulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      }

      @keyframes updateIndicatorPulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
      }

      /* Light mode notification */
      body.light-mode .update-notification-badge {
        background: linear-gradient(
          135deg,
          rgba(255, 87, 87, 0.98) 0%,
          rgba(255, 107, 107, 0.98) 100%
        );
        border: 1px solid rgba(255, 87, 87, 0.6);
      }

      body.light-mode .update-notification-title,
      body.light-mode .update-notification-text {
        color: #ffffff;
      }
      /* Update Notification Badge - Top Right Corner */
      .desktop-update-badge {
        position: fixed;
        top: 48px;
        right: 20px;
        background: linear-gradient(
          135deg,
          rgba(255, 87, 87, 0.95) 0%,
          rgba(255, 107, 107, 0.95) 100%
        );
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 14px;
        padding: 16px 20px;
        box-shadow: 0 12px 48px rgba(255, 87, 87, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        border: 1px solid rgba(255, 87, 87, 0.5);
        z-index: 9998;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 320px;
        display: none;
        flex-direction: column;
        gap: 0;
        animation: badgeSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1), badgePulse 2s cubic-bezier(0.4, 0, 0.2, 1) infinite 1s;
      }

      .desktop-update-badge.show {
        display: flex;
      }

      .desktop-update-badge:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 16px 56px rgba(255, 87, 87, 0.5),
          0 0 0 1px rgba(255, 255, 255, 0.3) inset;
      }

      .desktop-update-badge-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .desktop-update-badge-dismiss {
        width: 100%;
        margin-top: 10px;
        padding: 5px 0 1px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        background: none;
        border-left: none;
        border-right: none;
        border-bottom: none;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.75rem;
        text-align: center;
        cursor: pointer;
        opacity: 0;
        max-height: 0;
        overflow: hidden;
        transition: opacity 0.2s ease, max-height 0.2s ease, margin-top 0.2s ease;
        pointer-events: none;
        font-family: inherit;
      }

      .desktop-update-badge-dismiss:hover {
        color: #ffffff;
        text-decoration: underline;
      }

      .desktop-update-badge:hover .desktop-update-badge-dismiss {
        opacity: 1;
        max-height: 32px;
        pointer-events: all;
      }

      .desktop-update-badge-icon {
        font-size: 1.5rem;
        color: #ffffff;
        flex-shrink: 0;
        animation: badgeIconSpin 3s linear infinite;
      }

      .desktop-update-badge-content {
        flex: 1;
      }

      .desktop-update-badge-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 4px;
      }

      .desktop-update-badge-text {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.3;
      }

      .desktop-update-badge-close {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #ffffff;
        font-size: 0.7rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
      }

      .desktop-update-badge-close:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.1);
      }

      @keyframes badgeSlideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes badgePulse {
        0%,
        100% {
          box-shadow: 0 12px 48px rgba(255, 87, 87, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.2) inset;
        }
        50% {
          box-shadow: 0 16px 56px rgba(255, 87, 87, 0.6),
            0 0 0 1px rgba(255, 255, 255, 0.3) inset;
        }
      }

      @keyframes badgeIconSpin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      /* Light mode badge */
      body.light-mode .desktop-update-badge {
        background: linear-gradient(
          135deg,
          rgba(255, 87, 87, 0.98) 0%,
          rgba(255, 107, 107, 0.98) 100%
        );
        border: 1px solid rgba(255, 87, 87, 0.6);
      }

      /* === CUSTOM MODIFICATIONS === */
      /* Hide minimize button */
      .window-control.minimize {
        display: none !important;
      }

      /* Hide dock */
      .dock {
        display: none !important;
      }

      /* Menu Bar Auto-hide */
      .menu-bar.menu-bar-autohide {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
        transform: translateY(-100%) !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      .menu-bar.menu-bar-autohide:hover,
      .menu-bar.menu-bar-autohide.menu-bar-visible {
        transform: translateY(0) !important;
        opacity: 1 !important;
        pointer-events: auto !important;
      }

      /* Menu Bar Hidden */
      .menu-bar.menu-bar-hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Startup Screen -->
    <div id="startupScreen">
      <div class="startup-content">
        <i class="fas fa-globe startup-icon"></i>
        <div class="startup-text">X-ORBIT</div>
        <div class="startup-version">v5.2.3B Ventas</div>
        <div class="startup-progress-container">
          <div class="startup-progress-bar" id="startupProgress"></div>
        </div>
        <div class="startup-status" id="startupStatus">
          Initializing system...
        </div>
        <button
          class="startup-continue-btn"
          id="startupContinueBtn"
          style="display: none"
        >
          <i class="fas fa-rocket"></i> Launch X-ORBIT
        </button>
      </div>
    </div>

    <div id="welcomeOverlay">
      <iframe
        id="authFrame"
        src="auth.html"
        style="width: 100%; height: 100%; border: none"
      ></iframe>
    </div>

    <div class="menu-bar">
      <div class="menu-left">
        <div
          class="menu-item xorbit-title"
          style="font-weight: 600"
          id="xorbitMenu"
        >
          X-ORBIT
          <div class="xorbit-menu" id="xorbitDropdown">
            <div class="xorbit-menu-item" onclick="showAccountInfo()">
              <i class="fas fa-user-circle"></i>
              <span>Account Information</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="showAboutDialog()">
              <i class="fas fa-info-circle"></i>
              <span>About X-ORBIT Desktop</span>
            </div>
            <div class="xorbit-menu-item" onclick="openSettingsWindow()">
              <i class="fas fa-cog"></i>
              <span>Preferences...</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="showSystemInfo()">
              <i class="fas fa-desktop"></i>
              <span>System Information</span>
            </div>
            <div class="xorbit-menu-item" onclick="checkForUpdates()">
              <i class="fas fa-download"></i>
              <span>Check for Updates</span>
            </div>
            <div
              class="xorbit-menu-item"
              onclick="openWindow('Help & Support', 'support.html', 'fas fa-question-circle')"
            >
              <i class="fas fa-question-circle"></i>
              <span>Help & Support</span>
            </div>
            <div class="xorbit-menu-item" onclick="restartTutorial()">
              <i class="fas fa-graduation-cap"></i>
              <span>Desktop Tour</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="restartDesktop()">
              <i class="fas fa-sync"></i>
              <span>Restart Desktop</span>
            </div>
            <div class="xorbit-menu-item danger" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </div>
          </div>
        </div>
        <div class="menu-item" title="Settings" onclick="openSettingsWindow()">
          <i class="fas fa-cog"></i>
        </div>
        <div class="menu-item" title="Terms of Service" onclick="openWindow('Terms of Service', 'tos.html', 'fas fa-file-contract')">
          <i class="fas fa-file-contract"></i>
        </div>
        <div class="menu-item" title="Privacy Policy" onclick="openWindow('Privacy Policy', 'privacy-policy.html', 'fas fa-shield-alt')">
          <i class="fas fa-shield-alt"></i>
        </div>
        <div class="menu-item" title="Changelogs" onclick="openWindow('Changelog', 'changelogs.html', 'fas fa-list-alt')">
          <i class="fas fa-list-alt"></i>
        </div>
      </div>
      <div class="menu-center">
        <div class="menu-item time-item" id="timeMenu">
          <span id="currentTime"></span>
          <div class="time-menu" id="timeDropdown">
            <div class="time-header">
              <div class="time-display" id="fullTime"></div>
              <div class="date-display" id="fullDate"></div>
              <div class="timezone-display" id="timezone"></div>
            </div>
            <div class="weather-section">
              <div class="weather-icon" id="weatherIcon">ðŸŒ¤ï¸</div>
              <div class="weather-info">
                <div class="weather-temp" id="weatherTemp">22Â°C</div>
                <div class="weather-desc" id="weatherDesc">Partly Cloudy</div>
                <div class="weather-location" id="weatherLocation">Casper, Wyoming</div>
              </div>
            </div>
            <div class="weather-details">
              <div class="weather-detail">
                <div class="weather-detail-label">Humidity</div>
                <div class="weather-detail-value" id="humidity">65%</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">Wind</div>
                <div class="weather-detail-value" id="wind">12 mph</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">Pressure</div>
                <div class="weather-detail-value" id="pressure">1013 mb</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">UV Index</div>
                <div class="weather-detail-value" id="uvIndex">3</div>
              </div>
            </div>
            <div class="location-section">
              <div class="location-text">Location services enabled</div>
              <div class="location-update" onclick="updateLocation()">ðŸ“ Update location</div>
            </div>
          </div>
        </div>
      </div>
      <div class="menu-right">
        <div
          class="menu-item"
          id="userNameplate"
          style="cursor: pointer; position: relative"
        >
          <i class="fas fa-user-circle" style="margin-right: 6px"></i>
          <span id="userNameDisplay">User</span>
          <div class="xorbit-menu" id="userDropdown">
            <div class="xorbit-menu-item" onclick="showAccountInfo()">
              <i class="fas fa-id-card"></i>
              <span>Account Information</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="openSettingsWindow()">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </div>
            <div class="xorbit-menu-item" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </div>
          </div>
        </div>
        <div
          class="menu-item"
          id="wifiMenu"
          style="cursor: pointer; position: relative"
        >
          <i class="fas fa-wifi" id="wifiIcon"></i>
          <div
            class="xorbit-menu"
            id="wifiDropdown"
            style="min-width: 280px; left: auto; right: 0"
          >
            <div
              style="
                padding: 16px;
                border-bottom: 1px solid rgba(120, 80, 255, 0.2);
              "
            >
              <div
                style="
                  color: #7d5cff;
                  font-weight: 600;
                  font-size: 0.95rem;
                  margin-bottom: 12px;
                "
              >
                <i class="fas fa-network-wired" style="margin-right: 8px"></i>
                Network Status
              </div>
              <div
                style="color: #e8f0ff; font-size: 0.85rem; margin-bottom: 8px"
              >
                <span style="color: #a8b4d9">Connection:</span>
                <span
                  id="networkStatus"
                  style="margin-left: 8px; color: #28ca42"
                >
                  <i class="fas fa-check-circle"></i> Online
                </span>
              </div>
              <div style="color: #e8f0ff; font-size: 0.85rem">
                <span style="color: #a8b4d9">Type:</span>
                <span id="networkType" style="margin-left: 8px">Unknown</span>
              </div>
            </div>

            <div
              style="
                padding: 16px;
                border-bottom: 1px solid rgba(120, 80, 255, 0.2);
              "
            >
              <div
                style="
                  color: #7d5cff;
                  font-weight: 600;
                  font-size: 0.95rem;
                  margin-bottom: 12px;
                "
              >
                <i class="fas fa-server" style="margin-right: 8px"></i>
                X-ORBIT Server Status
              </div>
              <div style="display: grid; gap: 8px">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <span style="color: #a8b4d9; font-size: 0.85rem"
                    >Ping Latency:</span
                  >
                  <span
                    id="pingLatency"
                    style="color: #e8f0ff; font-weight: 600; font-size: 0.9rem"
                  >
                    <i class="fas fa-spinner fa-spin"></i> Testing...
                  </span>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <span style="color: #a8b4d9; font-size: 0.85rem"
                    >Jitter:</span
                  >
                  <span
                    id="jitterValue"
                    style="color: #e8f0ff; font-weight: 600; font-size: 0.9rem"
                  >
                    <i class="fas fa-spinner fa-spin"></i> Testing...
                  </span>
                </div>
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                  "
                >
                  <span style="color: #a8b4d9; font-size: 0.85rem"
                    >Server Location:</span
                  >
                  <span style="color: #e8f0ff; font-size: 0.85rem"
                    >London, GB</span
                  >
                </div>
              </div>
            </div>

            <div style="padding: 12px 16px">
              <button
                class="wallpaper-button"
                onclick="testNetworkSpeed()"
                style="width: 100%; font-size: 0.85rem; padding: 8px"
              >
                <i class="fas fa-sync-alt"></i>
                Refresh Connection Test
              </button>
            </div>
          </div>
        </div>
        <div class="menu-item time-item" id="timeMenu">
          <span id="currentTime"></span>
          <div class="time-menu" id="timeDropdown">
            <div class="time-header">
              <div class="time-display" id="fullTime"></div>
              <div class="date-display" id="fullDate"></div>
              <div class="timezone-display" id="timezone"></div>
            </div>

            <div class="weather-section">
              <div class="weather-icon" id="weatherIcon">ðŸŒ¤ï¸</div>
              <div class="weather-info">
                <div class="weather-temp" id="weatherTemp">22Â°C</div>
                <div class="weather-desc" id="weatherDesc">Partly Cloudy</div>
                <div class="weather-location" id="weatherLocation">
                  Casper, Wyoming
                </div>
              </div>
            </div>

            <div class="weather-details">
              <div class="weather-detail">
                <div class="weather-detail-label">Humidity</div>
                <div class="weather-detail-value" id="humidity">65%</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">Wind</div>
                <div class="weather-detail-value" id="wind">12 mph</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">Pressure</div>
                <div class="weather-detail-value" id="pressure">1013 mb</div>
              </div>
              <div class="weather-detail">
                <div class="weather-detail-label">UV Index</div>
                <div class="weather-detail-value" id="uvIndex">3</div>
              </div>
            </div>

            <div class="location-section">
              <div class="location-text">Location services enabled</div>
              <div class="location-update" onclick="updateLocation()">
                ðŸ“ Update location
              </div>
            </div>
          </div>
        </div>
        <div
          class="menu-item"
          id="utilitiesMenu"
          style="cursor: pointer; position: relative"
        >
          <i class="fas fa-ellipsis-h"></i>
          <div
            class="xorbit-menu"
            id="utilitiesDropdown"
            style="left: auto; right: 0"
          >
            <div class="xorbit-menu-item" onclick="toggleFullscreen()">
              <i class="fas fa-expand" id="fullscreenIcon"></i>
              <span id="fullscreenText">Enter Fullscreen</span>
            </div>
            <div class="xorbit-menu-item" onclick="refreshDesktop()">
              <i class="fas fa-sync"></i>
              <span>Refresh Desktop</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="openTaskManager()">
              <i class="fas fa-tasks"></i>
              <span>Task Manager</span>
            </div>
            <div class="xorbit-menu-item" onclick="openSettingsWindow()">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </div>
            <div class="xorbit-menu-divider"></div>
            <div class="xorbit-menu-item" onclick="restartDesktop()">
              <i class="fas fa-redo"></i>
              <span>Restart Desktop</span>
            </div>
            <div class="xorbit-menu-item" onclick="logout()">
              <i class="fas fa-power-off"></i>
              <span>Shut Down</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="desktop" id="desktop">
      <div class="desktop-icons">
        <div
          class="desktop-icon"
          data-app="Browser"
          data-src="browser.html"
          data-icon="fas fa-globe"
        >
          <i class="fas fa-globe"></i>
          <span>Browser</span>
        </div>
        <div
          class="desktop-icon"
          data-app="Settings"
          data-src="settings.html"
          data-icon="fas fa-cog"
        >
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </div>
        <div
          class="desktop-icon"
          data-app="Minecraft"
          data-src="minecraft.html"
          data-icon="fas fa-tree"
        >
          <i class="fas fa-tree"></i>
          <span>Minecraft</span>
        </div>
        <div
          class="desktop-icon"
          data-app="Music"
          data-src="spotify-player.html"
          data-icon="fa-solid fa-music"
        >
          <i class="fa-solid fa-music"></i>
          <span>Music</span>
        </div>
      </div>
    </div>
    <!-- Update Notification Badge - Desktop Corner -->
    <div class="desktop-update-badge" id="desktopUpdateBadge">
      <div class="desktop-update-badge-row">
        <i class="fas fa-sync-alt desktop-update-badge-icon"></i>
        <div class="desktop-update-badge-content">
          <div class="desktop-update-badge-title">Update Available</div>
          <div class="desktop-update-badge-text">
            Go to Settings â†’ System to install the latest version
          </div>
        </div>
        <div
          class="desktop-update-badge-close"
          onclick="hideDesktopUpdateBadge(event)"
        >
          <i class="fas fa-times"></i>
        </div>
      </div>
      <button
        class="desktop-update-badge-dismiss"
        onclick="hideDesktopUpdateBadge(event)"
      >
        Don't remind me again this session
      </button>
    </div>
    <div class="dock">
      <div
        class="dock-item"
        data-app="Home"
        data-src="render.html"
        data-icon="fas fa-home"
      >
        <i class="fas fa-home"></i>
        <div class="tooltip">Home</div>
      </div>
      <div
        class="dock-item"
        data-app="Browser"
        data-src="browser.html"
        data-icon="fas fa-globe"
      >
        <i class="fas fa-globe"></i>
        <div class="tooltip">Browser</div>
      </div>
      <div
        class="dock-item"
        data-app="Privacy Policy"
        data-src="privacy-policy.html"
        data-icon="fas fa-shield-alt"
      >
        <i class="fas fa-shield-alt"></i>
        <div class="tooltip">Privacy</div>
      </div>
      <div
        class="dock-item"
        data-app="Terms of Service"
        data-src="tos.html"
        data-icon="fas fa-file-contract"
      >
        <i class="fas fa-file-contract"></i>
        <div class="tooltip">Terms</div>
      </div>
      <div
        class="dock-item"
        data-app="Pricing"
        data-src="pricing.html"
        data-icon="fas fa-tags"
      >
        <i class="fas fa-tags"></i>
        <div class="tooltip">Pricing</div>
      </div>
      <div
        class="dock-item"
        data-app="Team"
        data-src="team.html"
        data-icon="fas fa-users"
      >
        <i class="fas fa-users"></i>
        <div class="tooltip">Team</div>
      </div>
      <div
        class="dock-item"
        data-app="Support"
        data-src="support.html"
        data-icon="fas fa-headset"
      >
        <i class="fas fa-headset"></i>
        <div class="tooltip">Support</div>
      </div>
      <div
        class="dock-item"
        data-app="Changelog"
        data-src="changelogs.html"
        data-icon="fas fa-list-alt"
      >
        <i class="fas fa-list-alt"></i>
        <div class="tooltip">Changes</div>
      </div>
      <div
        class="dock-item"
        data-app="Settings"
        data-src="settings.html"
        data-icon="fas fa-cog"
      >
        <i class="fas fa-cog"></i>
        <div class="tooltip">Settings</div>
      </div>
      <div
        class="dock-item"
        data-app="Music"
        data-src="spotify-player.html"
        data-icon="fa-solid fa-music"
      >
        <i class="fa-solid fa-music"></i>
        <div class="tooltip">Music</div>
      </div>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay">
      <div class="tutorial-content" id="tutorialContent">
        <div class="tutorial-header">
          <i class="tutorial-icon" id="tutorialIcon">ðŸš€</i>
          <div class="tutorial-title" id="tutorialTitle">
            Welcome to X-ORBIT!
          </div>
          <div class="tutorial-step" id="tutorialStep">Step 1 of 6</div>
        </div>

        <div class="tutorial-description" id="tutorialDescription">
          Welcome to your new desktop environment! Let's take a quick tour to
          help you get started with X-ORBIT's features.
        </div>

        <div class="tutorial-highlight" id="tutorialHighlight">
          <div class="tutorial-highlight-title" id="tutorialHighlightTitle">
            ðŸ’¡ Quick Tip
          </div>
          <div class="tutorial-highlight-text" id="tutorialHighlightText">
            This tour will only show once. You can skip it anytime or restart it
            from the Help menu.
          </div>
        </div>

        <div class="tutorial-controls">
          <div class="tutorial-progress" id="tutorialProgress">
            <div class="tutorial-dot active"></div>
            <div class="tutorial-dot"></div>
            <div class="tutorial-dot"></div>
            <div class="tutorial-dot"></div>
            <div class="tutorial-dot"></div>
            <div class="tutorial-dot"></div>
          </div>

          <div class="tutorial-buttons">
            <button class="tutorial-btn secondary" id="tutorialSkip">
              <i class="fas fa-times"></i>
              <span>Skip Tour</span>
            </button>
            <button
              class="tutorial-btn secondary"
              id="tutorialPrev"
              style="display: none"
            >
              <i class="fas fa-arrow-left"></i>
              <span>Previous</span>
            </button>
            <button class="tutorial-btn primary" id="tutorialNext">
              <span>Next</span>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

  <!-- X-ORBIT Modal â€” must be before the script so getElementById works immediately -->
  <div id="xModal" class="xmodal-overlay">
    <div class="xmodal-card">
      <div class="xmodal-icon"  id="xModalIcon"></div>
      <div class="xmodal-title" id="xModalTitle"></div>
      <div class="xmodal-message" id="xModalMessage"></div>
      <div class="xmodal-actions" id="xModalActions"></div>
    </div>
  </div>

    <script>
      // Global variable to track update check interval
      let updateCheckInterval = null;
      let desktopUpdateBadgeShown = false;
      let updateDismissedThisSession = false;

      // Start automatic update checking every 30 seconds
      function startAutomaticUpdateChecking() {
        console.log("Starting automatic update checking (every 30 seconds)");

        // Check immediately on start
        checkForUpdatesQuietly();

        // Then check every 30 seconds
        if (updateCheckInterval) {
          clearInterval(updateCheckInterval);
        }

        updateCheckInterval = setInterval(() => {
          checkForUpdatesQuietly();
        }, 30000); // 30 seconds
      }

      // Stop automatic update checking
      function stopAutomaticUpdateChecking() {
        if (updateCheckInterval) {
          clearInterval(updateCheckInterval);
          updateCheckInterval = null;
          console.log("Automatic update checking stopped");
        }
      }

      // Quiet update check (doesn't show UI, just checks and shows badge if needed)
      async function checkForUpdatesQuietly() {
        try {
          console.log("[Auto-Check] Checking for updates...");

          // Initialize Supabase if not already done
          if (!supabaseClient) {
            const initialized = initSupabaseClient();
            if (!initialized) {
              console.error(
                "[Auto-Check] Cannot check updates: Supabase not initialized"
              );
              return;
            }
          }

          // Query the update_check table
          const { data, error } = await supabaseClient
            .from("update_check")
            .select("*")
            .single();

          if (error) {
            console.error("[Auto-Check] Error checking for updates:", error);
            return;
          }

          if (!data) {
            console.error("[Auto-Check] No update data found");
            return;
          }

          // Compare versions
          const latestVersion = data.version;
          const latestVersionName =
            data.version_name || `X-ORBIT Desktop ${latestVersion}`;
          const updateSize = data.update_size || "Unknown";

          if (latestVersion !== CURRENT_VERSION) {
            // Update available
            console.log("[Auto-Check] âœ… Update available:", latestVersion);
            latestUpdateData = {
              version: latestVersion,
              versionName: latestVersionName,
              size: updateSize,
            };

            // Show desktop badge if not already shown and not dismissed this session
            if (!desktopUpdateBadgeShown && !updateDismissedThisSession) {
              showDesktopUpdateBadge();
            }
          } else {
            // Up to date
            console.log("[Auto-Check] âœ… System is up to date");
            // Hide badge if it's showing
            if (desktopUpdateBadgeShown) {
              hideDesktopUpdateBadge();
            }
          }
        } catch (e) {
          console.error("[Auto-Check] Error in checkForUpdatesQuietly:", e);
        }
      }

      // Show the desktop update badge
      function showDesktopUpdateBadge() {
        const badge = document.getElementById("desktopUpdateBadge");
        if (badge && !desktopUpdateBadgeShown) {
          badge.classList.add("show");
          desktopUpdateBadgeShown = true;

          // Play preloaded notification sound
          _updateNotifSound.currentTime = 0;
          _updateNotifSound.play().catch(() => {});

          // Make badge clickable to open settings
          badge.onclick = function (e) {
            if (e.target.closest(".desktop-update-badge-close")) return;
            openSettingsToSystemSection();
          };

          console.log("Desktop update badge shown");
        }
      }

      // Hide the desktop update badge
      function hideDesktopUpdateBadge(event) {
        if (event) {
          event.stopPropagation();
        }

        const badge = document.getElementById("desktopUpdateBadge");
        if (badge) {
          badge.classList.remove("show");
          desktopUpdateBadgeShown = false;
          if (event) {
            updateDismissedThisSession = true;
          }
          console.log("Desktop update badge hidden");
        }
      }

      // Open settings window directly to System section
      function openSettingsToSystemSection() {
        console.log("Opening settings to System section...");

        // Check if settings window is already open
        const settingsWindowId = activeWindows.get("Settings");
        if (settingsWindowId) {
          // Focus existing window and switch to System section
          focusWindow(settingsWindowId);
          const settingsWindow = document.getElementById(settingsWindowId);
          if (settingsWindow) {
            // Click on System nav item
            const systemNavItem = settingsWindow.querySelector(
              '[data-section="general"]'
            );
            if (systemNavItem) {
              systemNavItem.click();
            }
          }
        } else {
          // Open new settings window
          openSettingsWindow();

          // Wait for window to load, then switch to System section
          setTimeout(() => {
            const settingsWindowId = activeWindows.get("Settings");
            if (settingsWindowId) {
              const settingsWindow = document.getElementById(settingsWindowId);
              if (settingsWindow) {
                const systemNavItem = settingsWindow.querySelector(
                  '[data-section="general"]'
                );
                if (systemNavItem) {
                  systemNavItem.click();
                }
              }
            }
          }, 500);
        }

        // Hide the badge
        hideDesktopUpdateBadge();
      }
      // Global variables
      let windowCounter = 0;
      let activeWindows = new Map();
      let isAuthenticated = false;
      let zIndexCounter = 100;
      let currentUser = {
        username: "",
        email: "",
      };
      let userLocation = {
        city: "Casper",
        state: "Wyoming",
        country: "US",
        lat: 42.8666,
        lon: -106.313,
        timezone: "America/Denver",
      };
      let weatherData = {
        temp: 22,
        description: "Partly Cloudy",
        icon: "ðŸŒ¤ï¸",
        humidity: 65,
        wind: 12,
        pressure: 1013,
        uvIndex: 3,
      };
      // Preload update notification sound so it plays instantly
      const _updateNotifSound = new Audio("https://codehs.com/uploads/3cf37b71b40a03d66818483c82d3d4a3");
      _updateNotifSound.preload = "auto";

      let settings = {
        theme: "dark",
        transparency: true,
        animations: true,
        backgroundOpacity: 80,
        showMenuBar: true,
        autohideMenuBar: false,
        menuBarOpacity: 80,
        menuBarBlur: 40,
        dockAutohide: false,
        dockPosition: "bottom",
        dockSize: 56,
        dockMagnification: true,
        dockTooltips: true,
        windowSnapping: true,
        windowShadows: true,
        jellyMode: false,
        launchFullscreen: false,
        customWallpaper: null,
        startupWindows: "welcome", // Options: 'welcome', 'none', 'browser', 'terminal', 'settings'
      };

      // Tutorial system
      let currentTutorialStep = 0;
      let tutorialSteps = [
        {
          icon: "fas fa-rocket",
          title: "Welcome to X-ORBIT!",
          description:
            "Welcome to your new desktop environment! Let's take a quick tour to help you get started and personalize X-ORBIT to your preferences.",
          highlightTitle: "Quick Tip",
          highlightText:
            "Use arrow keys or spacebar to navigate this tour. Press Escape to skip anytime.",
          highlightElement: null,
        },
        {
          icon: "fas fa-palette",
          title: "Choose Your Theme",
          description:
            "X-ORBIT offers multiple beautiful themes. Which style do you prefer?",
          highlightTitle: "Available Themes",
          highlightText:
            "Dark Mode, Light Mode, or Halloween 2025. You can change this anytime in Settings.",
          highlightElement: null,
          isConfig: true,
          configType: "theme",
        },
        {
          icon: "fas fa-grip-horizontal",
          title: "Dock Configuration",
          description:
            "Customize how your dock behaves. Choose the position and whether it should auto-hide.",
          highlightTitle: "Dock Options",
          highlightText:
            "Bottom or Left position. Enable auto-hide to maximize screen space.",
          highlightElement: null,
          isConfig: true,
          configType: "dock",
        },
        {
          icon: "fas fa-expand",
          title: "Fullscreen Mode",
          description:
            "Would you like X-ORBIT to launch in fullscreen mode by default?",
          highlightTitle: "Immersive Experience",
          highlightText:
            "Fullscreen mode hides browser UI for a true desktop experience.",
          highlightElement: null,
          isConfig: true,
          configType: "fullscreen",
        },
        {
          icon: "fas fa-mouse-pointer",
          title: "Desktop & Windows",
          description:
            "This is your desktop workspace. You can open multiple windows, move them around, resize them, and organize your workspace however you like.",
          highlightTitle: "Try This",
          highlightText:
            "Click and drag window titlebars to move them. Use the colored buttons to close, minimize, or maximize windows.",
          highlightElement: ".desktop",
        },
        {
          icon: "fas fa-bars",
          title: "Menu Bar & Controls",
          description:
            'The top menu bar gives you access to system controls. Click "X-ORBIT" for system options like logout and settings, or click the time for weather info.',
          highlightTitle: "Time & Weather",
          highlightText:
            "Click the time to see detailed weather information and timezone data for your location.",
          highlightElement: ".menu-bar",
        },
        {
          icon: "fas fa-th-large",
          title: "The Dock",
          description:
            "Your dock provides quick access to applications. Hover over icons to see names, and click to launch apps instantly.",
          highlightTitle: "Pro Tips",
          highlightText:
            "Icons show a dot when apps are running. You can customize dock settings anytime.",
          highlightElement: ".dock",
        },
        {
          icon: "fas fa-check-circle",
          title: "You're All Set!",
          description:
            "Congratulations! You now know the basics of X-ORBIT. Explore the applications, customize your settings, and make this desktop your own.",
          highlightTitle: "Ready to Explore",
          highlightText:
            "Your desktop is ready! Open some apps, try the settings, and enjoy your new workspace.",
          highlightElement: null,
        },
      ];

      // Load user data from session storage
      function loadUserData() {
        try {
          const authData =
            sessionStorage.getItem("xorbit_auth_session") ||
            localStorage.getItem("xorbit_auth_session");
          if (authData) {
            const authSession = JSON.parse(authData);
            currentUser.username = authSession.username || "";
            currentUser.email = authSession.email || "";
            console.log("âœ… User data loaded:", currentUser.username);
            updateUserDisplay();
          }
        } catch (e) {
          console.warn("Could not load user data:", e);
        }
      }

      // Update the user display in the menu bar
      function updateUserDisplay() {
        const menuRight = document.querySelector(".menu-right");

        if (!menuRight) return;

        // Check if user display already exists
        let userDisplay = document.getElementById("userDisplay");

        if (!userDisplay && currentUser.username) {
          // Create user display element
          userDisplay = document.createElement("div");
          userDisplay.id = "userDisplay";
          userDisplay.className = "menu-item";
          userDisplay.style.cssText = `
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(120, 80, 255, 0.1);
      border: 1px solid rgba(120, 80, 255, 0.2);
      border-radius: 8px;
      cursor: default;
    `;

          userDisplay.innerHTML = `
      <i class="fas fa-user" style="color: #7d5cff;"></i>
      <span style="font-weight: 500;">${currentUser.username}</span>
    `;

          // Insert before the time menu
          const timeMenu = document.getElementById("timeMenu");
          if (timeMenu) {
            menuRight.insertBefore(userDisplay, timeMenu);
          } else {
            menuRight.appendChild(userDisplay);
          }
        } else if (userDisplay && currentUser.username) {
          // Update existing display
          const usernameSpan = userDisplay.querySelector("span");
          if (usernameSpan) {
            usernameSpan.textContent = currentUser.username;
          }
        }
      }

      // Wallpaper management
      function handleWallpaperUpload(event) {
        event.preventDefault();
        event.stopPropagation();

        const file = event.target.files[0];
        if (!file) return;

        // Check if it's an image
        if (!file.type.startsWith("image/")) {
          xModal.alert("Please select a valid image file (JPEG, PNG, GIF, etc.).", { title: "Invalid File", icon: '<i class="fas fa-exclamation-triangle" style="color:#ff453a"></i>' });
          return;
        }

        // Read the file and convert to base64
        const reader = new FileReader();
        reader.onload = function (e) {
          const imageData = e.target.result;

          // Save to settings
          settings.customWallpaper = imageData;
          localStorage.setItem("xorbit-settings", JSON.stringify(settings));

          // Apply wallpaper
          applyWallpaper(imageData);

          // Update preview in settings
          updateWallpaperPreview(imageData);

          // Clear the file input
          event.target.value = "";
        };
        reader.readAsDataURL(file);
      }

      function setPresetWallpaper(url) {
        settings.customWallpaper = url;
        localStorage.setItem("xorbit-settings", JSON.stringify(settings));
        applyWallpaper(url);
        const preview = document.getElementById("wallpaperPreview");
        if (preview) { preview.src = url; preview.style.display = "block"; }
      }

      function resetWallpaper() {
        event.preventDefault();
        event.stopPropagation();

        settings.customWallpaper = null;
        localStorage.setItem("xorbit-settings", JSON.stringify(settings));
        applyWallpaper(null);

        // Hide preview
        const preview = document.getElementById("wallpaperPreview");
        if (preview) preview.style.display = "none";
      }

      function applyWallpaper(imageData) {
        if (imageData) {
          // Show custom wallpaper
          document.body.style.backgroundImage = `url(${imageData})`;
          document.body.style.backgroundSize = "cover";
          document.body.style.backgroundPosition = "center";
          document.body.style.backgroundRepeat = "no-repeat";

          // Hide globe icon
          const style = document.createElement("style");
          style.id = "custom-wallpaper-style";
          style.textContent = "body::after { display: none !important; }";

          // Remove old style if exists
          const oldStyle = document.getElementById("custom-wallpaper-style");
          if (oldStyle) oldStyle.remove();

          document.head.appendChild(style);
        } else {
          // Reset to default (globe background)
          document.body.style.backgroundImage = "";

          // Remove hide globe style
          const oldStyle = document.getElementById("custom-wallpaper-style");
          if (oldStyle) oldStyle.remove();
        }
      }

      function updateWallpaperPreview(imageData) {
        const preview = document.getElementById("wallpaperPreview");
        const previewImg = document.getElementById("wallpaperPreviewImg");

        if (preview && previewImg && imageData) {
          previewImg.src = imageData;
          preview.style.display = "block";
        }
      }

      // Load settings from localStorage
      function loadSettings() {
        const saved = localStorage.getItem("xorbit-settings");
        if (saved) {
          try {
            settings = { ...settings, ...JSON.parse(saved) };
          } catch (e) {
            console.warn("Failed to load settings");
          }
        }
        // Load the theme stylesheet
        loadTheme(settings.theme);
        applySettings();

        // Apply custom wallpaper if set, otherwise pick a random preset
        if (settings.customWallpaper) {
          applyWallpaper(settings.customWallpaper);
        } else {
          const presets = [
            "https://codehs.com/uploads/d91102c835effc9c3856c7daef320895",
            "https://codehs.com/uploads/33f4df933a540b5e1647a28a506c8e79",
            "https://codehs.com/uploads/d94bb7b7aa8af986990f1fa97215c813",
            "https://codehs.com/uploads/e2f2a83d14c5aee58f6ab7f474918fe0",
            "https://codehs.com/uploads/889639ce12e33851cc220a16dcdc8644",
            "https://codehs.com/uploads/3ecd035b21f16d948c4dc9bcbfc97348",
            "https://codehs.com/uploads/84055eb5a4bb26ebb3c8bb1ae9776efb"
          ];
          applyWallpaper(presets[Math.floor(Math.random() * presets.length)]);
        }
      }

      // Load theme stylesheet dynamically
      function loadTheme(theme) {
        const existingTheme = document.getElementById("theme-stylesheet");
        if (existingTheme) {
          existingTheme.remove();
        }

        const link = document.createElement("link");
        link.id = "theme-stylesheet";
        link.rel = "stylesheet";

        // Select the appropriate theme file
        if (theme === "light") {
          link.href = "theme-light.css";
          document.body.classList.remove("halloween-theme");
        } else if (theme === "orange") {
          link.href = "theme-orange.css";
          document.body.classList.add("halloween-theme");
        } else {
          link.href = "theme-dark.css";
          document.body.classList.remove("halloween-theme");
        }

        document.head.appendChild(link);

        console.log("Theme loaded:", theme);
      }

      // Apply settings to the desktop
      function applySettings() {
        // Theme is now handled by loadTheme() function with external stylesheets

        // Apply menu bar settings
        const menuBar = document.querySelector(".menu-bar");
        if (menuBar) {
          console.log("Applying menu bar settings:", {
            showMenuBar: settings.showMenuBar,
            autohideMenuBar: settings.autohideMenuBar,
            opacity: settings.menuBarOpacity,
            blur: settings.menuBarBlur
          });

          // Show/hide menu bar
          if (settings.showMenuBar === false) {
            console.log("Hiding menu bar");
            menuBar.classList.add("menu-bar-hidden");
          } else {
            console.log("Showing menu bar");
            menuBar.classList.remove("menu-bar-hidden");
          }

          // Auto-hide menu bar
          if (settings.autohideMenuBar === true) {
            console.log("Enabling menu bar auto-hide");
            menuBar.classList.add("menu-bar-autohide");
            setupMenuBarAutohide();
          } else {
            console.log("Disabling menu bar auto-hide");
            menuBar.classList.remove("menu-bar-autohide");
            menuBar.classList.remove("menu-bar-visible");
          }

          // Apply opacity
          const opacity = (settings.menuBarOpacity || 80) / 100;
          const baseColor = `rgba(15, 15, 35, ${opacity * 0.6})`;
          menuBar.style.background = baseColor;

          // Apply blur
          const blur = settings.menuBarBlur || 40;
          menuBar.style.backdropFilter = `blur(${blur}px) saturate(1.8) brightness(1.2)`;
          menuBar.style.webkitBackdropFilter = `blur(${blur}px) saturate(1.8) brightness(1.2)`;
        }

        // Apply dock settings
        const dock = document.querySelector(".dock");
        if (dock) {
          // Reset dock positioning
          dock.style.cssText = "";
          dock.className = "dock";

          switch (settings.dockPosition) {
            case "bottom":
              dock.style.bottom = "16px";
              dock.style.left = "50%";
              dock.style.transform = "translateX(-50%)";
              dock.style.flexDirection = "row";
              break;
            case "top":
              dock.style.top = "48px";
              dock.style.left = "50%";
              dock.style.transform = "translateX(-50%)";
              dock.style.flexDirection = "row";
              break;
            case "left":
              dock.style.left = "16px";
              dock.style.top = "50%";
              dock.style.transform = "translateY(-50%)";
              dock.style.flexDirection = "column";
              break;
            case "right":
              dock.style.right = "16px";
              dock.style.top = "50%";
              dock.style.transform = "translateY(-50%)";
              dock.style.flexDirection = "column";
              break;
          }

          // Apply dock size
          const dockItems = document.querySelectorAll(".dock-item");
          dockItems.forEach((item) => {
            if (item) {
              item.style.width = settings.dockSize + "px";
              item.style.height = settings.dockSize + "px";
            }
          });

          // Auto-hide functionality
          if (settings.dockAutohide) {
            dock.classList.add("dock-autohide");
            setupDockAutohide();
          }
        }

        // Apply other settings
        if (!settings.transparency) {
          document.body.classList.add("no-transparency");
        } else {
          document.body.classList.remove("no-transparency");
        }

        if (!settings.animations) {
          document.body.classList.add("no-animations");
        } else {
          document.body.classList.remove("no-animations");
        }
      }

      // Setup dock auto-hide
      function setupDockAutohide() {
        const dock = document.querySelector(".dock");
        if (!dock) return;

        let hideTimeout;
        let showTimeout;
        const PROXIMITY_THRESHOLD = 100; // pixels from edge to trigger show
        const SHOW_DELAY = 1000; // ms to hover before showing (1 second)
        const HIDE_DELAY = 1000; // ms before hiding

        function showDock() {
          clearTimeout(hideTimeout);
          clearTimeout(showTimeout);
          dock.classList.add("dock-visible");
        }

        function scheduleDockShow() {
          clearTimeout(showTimeout);
          showTimeout = setTimeout(() => {
            dock.classList.add("dock-visible");
          }, SHOW_DELAY);
        }

        function cancelDockShow() {
          clearTimeout(showTimeout);
        }

        function scheduleDockHide() {
          clearTimeout(hideTimeout);
          clearTimeout(showTimeout);
          hideTimeout = setTimeout(() => {
            dock.classList.remove("dock-visible");
          }, HIDE_DELAY);
        }

        function checkMouseProximity(e) {
          const mouseX = e.clientX;
          const mouseY = e.clientY;
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;

          // Determine dock position from computed style
          const dockStyle = dock.style;
          const isBottom = dockStyle.bottom && dockStyle.bottom !== "auto";
          const isTop = dockStyle.top && dockStyle.top !== "auto" && !isBottom;
          const isLeft = dockStyle.left && dockStyle.flexDirection === "column";
          const isRight =
            dockStyle.right && dockStyle.flexDirection === "column";

          let shouldShow = false;

          if (isBottom) {
            // Mouse near bottom edge
            shouldShow = mouseY > windowHeight - PROXIMITY_THRESHOLD;
          } else if (isTop) {
            // Mouse near top edge (below menu bar)
            shouldShow = mouseY < PROXIMITY_THRESHOLD + 32; // 32px for menu bar
          } else if (isLeft) {
            // Mouse near left edge
            shouldShow = mouseX < PROXIMITY_THRESHOLD;
          } else if (isRight) {
            // Mouse near right edge
            shouldShow = mouseX > windowWidth - PROXIMITY_THRESHOLD;
          } else {
            // Default to bottom if position unclear
            shouldShow = mouseY > windowHeight - PROXIMITY_THRESHOLD;
          }

          if (shouldShow) {
            // Mouse is in proximity zone - start the 2 second timer if not already showing
            if (!dock.classList.contains("dock-visible")) {
              scheduleDockShow();
            } else {
              // Already visible, keep it visible
              clearTimeout(hideTimeout);
            }
          } else {
            // Mouse left proximity zone
            cancelDockShow();
            if (dock.classList.contains("dock-visible")) {
              scheduleDockHide();
            }
          }
        }

        // Listen for mouse movement globally
        document.addEventListener("mousemove", checkMouseProximity);

        // Show dock immediately when hovering over it (override the 2 second delay)
        dock.addEventListener("mouseenter", showDock);

        // Hide dock when leaving it
        dock.addEventListener("mouseleave", scheduleDockHide);

        // Start with dock hidden
        dock.classList.remove("dock-visible");
      }

      // Setup menu bar auto-hide
      function setupMenuBarAutohide() {
        const menuBar = document.querySelector(".menu-bar");
        if (!menuBar) return;

        let hideTimeout;
        const HIDE_DELAY = 1000; // ms before hiding

        function showMenuBar() {
          clearTimeout(hideTimeout);
          menuBar.classList.add("menu-bar-visible");
        }

        function scheduleMenuBarHide() {
          clearTimeout(hideTimeout);
          hideTimeout = setTimeout(() => {
            menuBar.classList.remove("menu-bar-visible");
          }, HIDE_DELAY);
        }

        function checkMouseProximity(e) {
          const mouseY = e.clientY;
          const PROXIMITY_THRESHOLD = 50; // pixels from top edge

          if (mouseY < PROXIMITY_THRESHOLD) {
            showMenuBar();
          } else {
            if (menuBar.classList.contains("menu-bar-visible")) {
              scheduleMenuBarHide();
            }
          }
        }

        // Listen for mouse movement
        document.addEventListener("mousemove", checkMouseProximity);

        // Show menu bar when hovering over it
        menuBar.addEventListener("mouseenter", showMenuBar);

        // Hide menu bar when leaving it
        menuBar.addEventListener("mouseleave", scheduleMenuBarHide);

        // Start with menu bar hidden
        menuBar.classList.remove("menu-bar-visible");
      }

      // Listen for messages
      window.addEventListener("message", async function (event) {
        if (event.data === "session-timeout") {
          console.log("ðŸš« Received session timeout message from auth.html");
          stopBanChecking(); // Stop checking on timeout
          window.location.href = "timeout.html";
        } else if (event.data === "auth-success") {
          console.log("âœ… Received auth success message");
          isAuthenticated = true;

          // Check ban status before proceeding
          const isBanned = await checkAccountBanStatus();
          if (isBanned) {
            return;
          }

          const welcomeOverlay = document.getElementById("welcomeOverlay");
          if (welcomeOverlay) {
            welcomeOverlay.style.display = "none";
          }
          loadUserData();
          initDesktop();

          // Start periodic ban checking
          startBanChecking();
        } else if (event.data && event.data.type === "settings-updated") {
          settings = { ...settings, ...event.data.settings };
          applySettings();
        }
      });

      // Initialize desktop
      function initDesktop() {
        loadSettings();
        loadUserData();
        updateTime();
        setInterval(updateTime, 1000);

        // Update detailed time every second when menu is open
        setInterval(() => {
          const timeDropdown = document.getElementById("timeDropdown");
          if (timeDropdown && timeDropdown.classList.contains("show")) {
            updateDetailedTime();
          }
        }, 1000);

        const dockItems = document.querySelectorAll(".dock-item");
        dockItems.forEach(function (item, index) {
          if (item) {
            item.style.opacity = "0";
            item.style.transform = "translateY(20px)";
            setTimeout(function () {
              item.style.transition = "all 0.4s ease";
              item.style.opacity = "1";
              item.style.transform = "translateY(0)";
            }, index * 100);
          }
        });

        // Check if this is first time and show tutorial
        setTimeout(function () {
          console.log("Checking if first time user...");
          if (isFirstTimeUser()) {
            console.log("First time user detected, showing tutorial");
            showTutorial();
          } else {
            console.log("Returning user, checking startup windows setting");
            openStartupWindow();
          }
        }, 1500);
        startAutomaticUpdateChecking();
      }

      // Open startup window based on settings
      function openStartupWindow() {
        const startupOption = settings.startupWindows || "welcome";

        switch (startupOption) {
          case "welcome":
            openWindow("Welcome to X-ORBIT", "render.html", "fas fa-rocket");
            break;
          case "browser":
            openWindow("Browser", "browser.html", "fas fa-globe");
            break;
          case "terminal":
            openWindow("Minecraft", "minecraft.html", "fas fa-tree");
            break;
          case "settings":
            openSettingsWindow();
            break;
          case "files":
            openWindow("File Manager", "files.html", "fas fa-folder");
            break;
          case "none":
            // Do nothing - no startup window
            console.log("Startup windows disabled");
            break;
          default:
            openWindow("Welcome to X-ORBIT", "render.html", "fas fa-rocket");
        }
      }

      // Tutorial System Functions
      function isFirstTimeUser() {
        const completed = localStorage.getItem("xorbit-tutorial-completed");
        console.log("Tutorial completed status:", completed);
        return !completed;
      }

      function markTutorialCompleted() {
        localStorage.setItem("xorbit-tutorial-completed", "true");
        console.log("Tutorial marked as completed");
      }

      function showTutorial() {
        console.log("Attempting to show tutorial...");
        const tutorialOverlay = document.getElementById("tutorialOverlay");

        if (!tutorialOverlay) {
          console.error("Tutorial overlay not found!");
          return;
        }

        // Close any open menus
        document
          .querySelectorAll(".xorbit-menu.show, .time-menu.show")
          .forEach((menu) => {
            menu.classList.remove("show");
          });

        currentTutorialStep = 0;
        console.log("Starting tutorial at step:", currentTutorialStep);

        // Show overlay first
        tutorialOverlay.style.display = "flex";

        // Then update content and show with animation
        setTimeout(() => {
          updateTutorialStep();
          tutorialOverlay.classList.add("show");
          setupTutorialEventListeners();
          console.log("Tutorial should now be visible");
        }, 50);
      }

      function hideTutorial() {
        console.log("Hiding tutorial...");
        const tutorialOverlay = document.getElementById("tutorialOverlay");
        if (tutorialOverlay) {
          tutorialOverlay.classList.remove("show");
          clearTutorialHighlight();
          markTutorialCompleted();

          // Hide overlay after animation
          setTimeout(() => {
            tutorialOverlay.style.display = "none";
            // Open welcome window after tutorial
            openWindow("Welcome to X-ORBIT", "render.html", "fas fa-rocket");
          }, 500);
        }
      }

      function setupTutorialEventListeners() {
        const nextBtn = document.getElementById("tutorialNext");
        const prevBtn = document.getElementById("tutorialPrev");
        const skipBtn = document.getElementById("tutorialSkip");

        if (nextBtn) {
          nextBtn.onclick = function () {
            if (currentTutorialStep < tutorialSteps.length - 1) {
              currentTutorialStep++;
              updateTutorialStep();
            } else {
              hideTutorial();
            }
          };
        }

        if (prevBtn) {
          prevBtn.onclick = function () {
            if (currentTutorialStep > 0) {
              currentTutorialStep--;
              updateTutorialStep();
            }
          };
        }

        if (skipBtn) {
          skipBtn.onclick = function () {
            xModal.confirm(
              "You can restart it anytime from X-ORBIT â†’ Desktop Tour.",
              () => hideTutorial(),
              { title: "Skip Tour?", icon: '<i class="fas fa-graduation-cap" style="color:#9070ff"></i>', confirmText: "Skip Tour" }
            );
          };
        }

        // Prevent clicks outside tutorial from closing it
        const tutorialOverlay = document.getElementById("tutorialOverlay");
        if (tutorialOverlay) {
          tutorialOverlay.addEventListener("click", function (e) {
            if (e.target === tutorialOverlay) {
              // Don't close on background click - user should use skip or complete
              return;
            }
          });
        }

        // Add keyboard navigation for tutorial
        document.addEventListener("keydown", function (e) {
          const tutorialOverlay = document.getElementById("tutorialOverlay");
          if (tutorialOverlay && tutorialOverlay.classList.contains("show")) {
            if (
              e.key === "ArrowRight" ||
              e.key === "Space" ||
              e.key === "Enter"
            ) {
              e.preventDefault();
              const nextBtn = document.getElementById("tutorialNext");
              if (nextBtn) nextBtn.click();
            } else if (e.key === "ArrowLeft") {
              e.preventDefault();
              if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
              }
            } else if (e.key === "Escape") {
              e.preventDefault();
              const skipBtn = document.getElementById("tutorialSkip");
              if (skipBtn) skipBtn.click();
            }
          }
        });
      }

      function updateTutorialStep() {
        const step = tutorialSteps[currentTutorialStep];
        const tutorialContent = document.getElementById("tutorialContent");

        if (!step || !tutorialContent) return;

        // Update content
        const iconEl = document.getElementById("tutorialIcon");
        const titleEl = document.getElementById("tutorialTitle");
        const stepEl = document.getElementById("tutorialStep");
        const descEl = document.getElementById("tutorialDescription");
        const highlightTitleEl = document.getElementById(
          "tutorialHighlightTitle"
        );
        const highlightTextEl = document.getElementById(
          "tutorialHighlightText"
        );
        const highlightBox = document.getElementById("tutorialHighlight");
        const nextBtn = document.getElementById("tutorialNext");
        const prevBtn = document.getElementById("tutorialPrev");

        // Update icon to use Font Awesome
        if (iconEl) {
          iconEl.textContent = "";
          iconEl.className = "tutorial-icon " + step.icon;
        }
        if (titleEl) titleEl.textContent = step.title;
        if (stepEl)
          stepEl.textContent = `Step ${currentTutorialStep + 1} of ${
            tutorialSteps.length
          }`;
        if (descEl) descEl.textContent = step.description;
        if (highlightTitleEl)
          highlightTitleEl.textContent = step.highlightTitle;
        if (highlightTextEl) highlightTextEl.textContent = step.highlightText;

        // Show configuration UI if this is a config step
        if (step.isConfig && highlightBox) {
          highlightBox.innerHTML = renderConfigUI(step.configType);
        } else if (highlightBox) {
          highlightBox.innerHTML = `
      <div class="tutorial-highlight-title">${step.highlightTitle}</div>
      <div class="tutorial-highlight-text">${step.highlightText}</div>
    `;
        }

        // Update button text for last step
        if (nextBtn) {
          const nextSpan = nextBtn.querySelector("span");
          const nextIcon = nextBtn.querySelector("i");
          if (currentTutorialStep === tutorialSteps.length - 1) {
            if (nextSpan) nextSpan.textContent = "Get Started!";
            if (nextIcon) nextIcon.className = "fas fa-rocket";
          } else {
            if (nextSpan) nextSpan.textContent = "Next";
            if (nextIcon) nextIcon.className = "fas fa-arrow-right";
          }
        }

        // Show/hide previous button
        if (prevBtn) {
          prevBtn.style.display = currentTutorialStep > 0 ? "flex" : "none";
        }

        // Update progress dots
        const dots = document.querySelectorAll(".tutorial-dot");
        dots.forEach((dot, index) => {
          dot.classList.toggle("active", index === currentTutorialStep);
        });

        // Highlight element if specified
        clearTutorialHighlight();
        if (step.highlightElement) {
          highlightTutorialElement(step.highlightElement);
        }
      }

      function renderConfigUI(configType) {
        switch (configType) {
          case "theme":
            return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Select Your Theme:</div>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'dark')" data-theme="dark">
            <i class="fas fa-moon"></i>
            <span>Dark Mode</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'light')" data-theme="light">
            <i class="fas fa-sun"></i>
            <span>Light Mode</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('theme', 'orange')" data-theme="orange">
            <i class="fas fa-ghost"></i>
            <span>Halloween 2025</span>
          </button>
        </div>
      `;
          case "dock":
            return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Dock Settings:</div>
          <div style="display: flex; gap: 12px;">
            <button class="tutorial-config-btn" onclick="applyTutorialConfig('dockPosition', 'bottom')" data-dock="bottom">
              <i class="fas fa-arrows-alt-h"></i>
              <span>Bottom</span>
            </button>
            <button class="tutorial-config-btn" onclick="applyTutorialConfig('dockPosition', 'left')" data-dock="left">
              <i class="fas fa-arrows-alt-v"></i>
              <span>Left</span>
            </button>
          </div>
          <label style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(120, 80, 255, 0.1); border-radius: 10px; cursor: pointer;">
            <input type="checkbox" id="tutorialAutohide" onchange="applyTutorialConfig('dockAutohide', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="color: #e8f0ff;">Enable Auto-hide Dock</span>
          </label>
        </div>
      `;
          case "fullscreen":
            return `
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <div style="font-weight: 600; color: #e8f0ff; margin-bottom: 8px;">Fullscreen Launch:</div>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('launchFullscreen', true)" data-fullscreen="true">
            <i class="fas fa-expand"></i>
            <span>Yes, Launch Fullscreen</span>
          </button>
          <button class="tutorial-config-btn" onclick="applyTutorialConfig('launchFullscreen', false)" data-fullscreen="false">
            <i class="fas fa-compress"></i>
            <span>No, Normal Window</span>
          </button>
        </div>
      `;
          default:
            return "";
        }
      }

      function applyTutorialConfig(setting, value) {
        // Apply the setting immediately
        if (setting === "theme") {
          settings.theme = value;
          loadTheme(value);
        } else if (setting === "dockPosition") {
          settings.dockPosition = value;
        } else if (setting === "dockAutohide") {
          settings.dockAutohide = value;
        } else if (setting === "launchFullscreen") {
          settings.launchFullscreen = value;
        }

        // Save settings
        localStorage.setItem("xorbit-settings", JSON.stringify(settings));
        applySettings();

        // Visual feedback on button
        const buttons = document.querySelectorAll(".tutorial-config-btn");
        buttons.forEach((btn) => btn.classList.remove("selected"));
        event.target.closest(".tutorial-config-btn")?.classList.add("selected");
      }

      function highlightTutorialElement(selector) {
        try {
          const element = document.querySelector(selector);
          if (element) {
            element.classList.add("tutorial-highlight-element");
          }
        } catch (e) {
          console.warn("Could not highlight element:", selector);
        }
      }

      function clearTutorialHighlight() {
        try {
          document
            .querySelectorAll(".tutorial-highlight-element")
            .forEach((el) => {
              el.classList.remove("tutorial-highlight-element");
            });
        } catch (e) {
          console.warn("Error clearing highlights");
        }
      }

      // Add restart tutorial function to help menu
      function restartTutorial() {
        document.getElementById("xorbitDropdown").classList.remove("show");

        xModal.confirm(
          "This will walk you through X-ORBIT's features from the beginning.",
          () => {
            console.log("Restarting tutorial...");
            localStorage.removeItem("xorbit-tutorial-completed");
            showTutorial();
          },
          { title: "Restart Tour?", icon: '<i class="fas fa-graduation-cap" style="color:#9070ff"></i>', confirmText: "Restart" }
        );
      }

      // Temporary function for testing - remove in production
      function forceShowTutorial() {
        console.log("Force showing tutorial for testing...");
        localStorage.removeItem("xorbit-tutorial-completed");
        showTutorial();
      }

      // Make forceShowTutorial available globally for testing
      window.forceShowTutorial = forceShowTutorial;

      // Update time with full date
      function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
        const dayName = now.toLocaleDateString([], { weekday: "long" });
        const monthName = now.toLocaleDateString([], { month: "short" });
        const day = now.getDate();
        const fullDisplay = `${dayName}, ${monthName} ${day} â€¢ ${timeStr}`;
        const timeEl = document.getElementById("currentTime");
        if (timeEl) timeEl.textContent = fullDisplay;

        // Update detailed time info
        updateDetailedTime(now);
      }

      // Update detailed time information
      function updateDetailedTime(now = new Date()) {
        const fullTimeEl = document.getElementById("fullTime");
        const fullDateEl = document.getElementById("fullDate");
        const timezoneEl = document.getElementById("timezone");

        if (fullTimeEl) {
          const timeStr = now.toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
          fullTimeEl.textContent = timeStr;
        }

        if (fullDateEl) {
          const dateStr = now.toLocaleDateString([], {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
          fullDateEl.textContent = dateStr;
        }

        if (timezoneEl) {
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          const offset = now.getTimezoneOffset();
          const offsetHours = Math.floor(Math.abs(offset) / 60);
          const offsetMins = Math.abs(offset) % 60;
          const offsetStr = `${offset > 0 ? '-' : '+'}${String(offsetHours).padStart(2, '0')}:${String(offsetMins).padStart(2, '0')}`;
          timezoneEl.textContent = `${timezone} (UTC${offsetStr})`;
        }
      }

      // Open window function
      function openWindow(title, src, icon) {
        if (!isAuthenticated) return;

        if (activeWindows.has(title)) {
          focusWindow(activeWindows.get(title));
          return;
        }

        windowCounter++;
        const windowId = "win" + windowCounter;
        const windowEl = document.createElement("div");
        windowEl.className = "window";
        if (settings.animations) {
          windowEl.classList.add("window-opening");
        }
        windowEl.id = windowId;

        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const leftMargin = 50;
        const rightMargin = 50;
        const topMargin = 80;
        const bottomMargin = 120;
        const windowWidth = 800;
        const windowHeight = 600;
        const availableWidth = vw - leftMargin - rightMargin;
        const availableHeight = vh - topMargin - bottomMargin;
        const actualWidth = Math.min(windowWidth, availableWidth);
        const actualHeight = Math.min(windowHeight, availableHeight);

        // Calculate safe position range
        const minX = leftMargin;
        const maxX = vw - actualWidth - rightMargin;
        const minY = topMargin;
        const maxY = vh - actualHeight - bottomMargin;

        // Generate position (centered with slight randomness)
        const centerX = (vw - actualWidth) / 2;
        const centerY = (vh - actualHeight) / 2;
        const randomOffsetX = (Math.random() - 0.5) * 100;
        const randomOffsetY = (Math.random() - 0.5) * 100;

        let x = centerX + randomOffsetX;
        let y = centerY + randomOffsetY;

        // Clamp to bounds
        x = Math.max(minX, Math.min(x, maxX));
        y = Math.max(minY, Math.min(y, maxY));

        windowEl.style.left = Math.floor(x) + "px";
        windowEl.style.top = Math.floor(y) + "px";
        windowEl.style.width = Math.floor(actualWidth) + "px";
        windowEl.style.height = Math.floor(actualHeight) + "px";

        // Get username and update window title if it's the Browser
        let displayTitle = title;
        if (title === "Browser" && currentUser.username) {
          displayTitle = `Browser - ${currentUser.username}`;
          // Also append username to iframe src as URL parameter
          src = `${src}?username=${encodeURIComponent(currentUser.username)}`;
        }

        windowEl.innerHTML =
          '<div class="window-titlebar">' +
          '<div class="window-controls">' +
          '<div class="window-control close"></div>' +
          '<div class="window-control minimize"></div>' +
          '<div class="window-control maximize"></div>' +
          "</div>" +
          '<div class="window-title">' +
          '<i class="' +
          icon +
          '" style="margin-right: 8px;"></i>' +
          displayTitle +
          "</div>" +
          "</div>" +
          '<div class="window-content">' +
          '<iframe src="' +
          src +
          '"></iframe>' +
          "</div>";

        const desktop = document.getElementById("desktop");
        if (desktop) {
          desktop.appendChild(windowEl);
        }
        activeWindows.set(title, windowId);
        focusWindow(windowId);

        setupWindowEvents(windowEl, windowId, title);

        // Add resize observer to prevent overflow
        constrainWindowSize(windowEl);

        // Force immediate position check
        setTimeout(() => {
          forceWindowInBounds(windowEl);
          // Trigger smooth animation like weather UI
          windowEl.classList.add("window-visible");
        }, 0);
      }

      // Setup window events
      function setupWindowEvents(windowEl, windowId, title) {
        const titlebar = windowEl.querySelector(".window-titlebar");
        const closeBtn = windowEl.querySelector(".window-control.close");
        const minBtn = windowEl.querySelector(".window-control.minimize");
        const maxBtn = windowEl.querySelector(".window-control.maximize");

        if (closeBtn) {
          closeBtn.onclick = function () {
            if (settings.animations) {
              windowEl.classList.remove("window-visible");
              setTimeout(function () {
                windowEl.remove();
                activeWindows.delete(title);
              }, 400);
            } else {
              windowEl.remove();
              activeWindows.delete(title);
            }
          };
        }

        if (minBtn) {
          minBtn.onclick = function () {
            windowEl.style.display = "none";
          };
        }

        if (maxBtn) {
          maxBtn.onclick = function () {
            // Check if already fullscreen
            if (windowEl.classList.contains("fullscreen")) {
              // Restore to previous size
              windowEl.classList.remove("fullscreen");
              windowEl.style.position = "absolute";
              windowEl.style.left = windowEl.dataset.prevLeft || "100px";
              windowEl.style.top = windowEl.dataset.prevTop || "100px";
              windowEl.style.width = windowEl.dataset.prevWidth || "600px";
              windowEl.style.height = windowEl.dataset.prevHeight || "450px";
              windowEl.style.borderRadius = "16px";
            } else {
              // Save current position/size
              windowEl.dataset.prevLeft = windowEl.style.left;
              windowEl.dataset.prevTop = windowEl.style.top;
              windowEl.dataset.prevWidth = windowEl.style.width;
              windowEl.dataset.prevHeight = windowEl.style.height;

              // Go fullscreen (CSS handles positioning)
              windowEl.classList.add("fullscreen");
              windowEl.style.width = "100vw";
              windowEl.style.height = "calc(100vh - 32px)";
              windowEl.style.borderRadius = "0";
            }
          };
        }

        // Window dragging
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let lastMouseX = 0;
        let lastMouseY = 0;

        if (titlebar) {
          titlebar.onmousedown = function (e) {
            if (e.target.closest(".window-control")) return;
            // Don't allow dragging if fullscreen
            if (windowEl.classList.contains("fullscreen")) return;

            isDragging = true;
            focusWindow(windowId);

            const rect = windowEl.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;

            document.onmousemove = function (e) {
              if (!isDragging) return;

              const rect = windowEl.getBoundingClientRect();
              const windowWidth = rect.width;
              const windowHeight = rect.height;

              let newX = e.clientX - dragOffset.x;
              let newY = e.clientY - dragOffset.y;

              // Constrain to screen bounds
              const minX = 0;
              const minY = 32; // Below menu bar
              const maxX = window.innerWidth - windowWidth;
              const maxY = window.innerHeight - 50; // Keep some visible at bottom

              newX = Math.max(minX, Math.min(newX, maxX));
              newY = Math.max(minY, Math.min(newY, maxY));

              windowEl.style.left = newX + "px";
              windowEl.style.top = newY + "px";

              // Jelly Mode: skew proportional to drag velocity
              if (settings.jellyMode) {
                const vx = e.clientX - lastMouseX;
                const vy = e.clientY - lastMouseY;
                const skewX = Math.max(-22, Math.min(22, vx * 3.5));
                const skewY = Math.max(-12, Math.min(12, vy * 2.0));
                windowEl.style.transition = "transform 0.04s linear";
                windowEl.style.transform = `skew(${skewX}deg, ${skewY}deg)`;
              }

              lastMouseX = e.clientX;
              lastMouseY = e.clientY;
            };

            document.onmouseup = function () {
              isDragging = false;
              document.onmousemove = null;
              document.onmouseup = null;
              if (settings.jellyMode) {
                // Spring bounce back to neutral
                windowEl.style.transition = "transform 0.9s cubic-bezier(0.34, 1.8, 0.64, 1)";
                windowEl.style.transform = "skew(0deg, 0deg)";
                setTimeout(() => { windowEl.style.transition = ""; windowEl.style.transform = ""; }, 900);
              }
            };
          };
        }
      }

      // Focus window
      function focusWindow(windowId) {
        const windows = document.querySelectorAll(".window");
        windows.forEach(function (w) {
          w.classList.remove("active");
        });

        const windowEl = document.getElementById(windowId);
        if (windowEl) {
          windowEl.classList.add("active");
          windowEl.style.zIndex = ++zIndexCounter;
        }
      }

      // Click event handlers
      document.addEventListener("click", function (e) {
        const dockItem = e.target.closest(".dock-item");
        const desktopIcon = e.target.closest(".desktop-icon");

        if (dockItem) {
          const title = dockItem.dataset.app;
          const src = dockItem.dataset.src;
          const icon = dockItem.dataset.icon;

          if (title === "Settings") {
            openSettingsWindow();
          } else {
            openWindow(title, src, icon);
          }
        }

        if (desktopIcon) {
          const title = desktopIcon.dataset.app;
          const src = desktopIcon.dataset.src;
          const icon = desktopIcon.dataset.icon;

          if (title === "Settings") {
            openSettingsWindow();
          } else {
            openWindow(title, src, icon);
          }
        }
      });
      function openSettingsWindow() {
        if (!isAuthenticated) return;

        const title = "Settings";
        if (activeWindows.has(title)) {
          focusWindow(activeWindows.get(title));
          return;
        }

        windowCounter++;
        const windowId = "win" + windowCounter;

        const windowEl = document.createElement("div");
        windowEl.className = "window";
        if (settings.animations) {
          windowEl.classList.add("window-opening");
        }
        windowEl.id = windowId;

        const x = Math.random() * (window.innerWidth - 800) + 50;
        const y = Math.random() * (window.innerHeight - 700) + 80;

        windowEl.style.left = x + "px";
        windowEl.style.top = y + "px";
        windowEl.style.width = "800px";
        windowEl.style.height = "700px";

        windowEl.innerHTML =
          '<div class="window-titlebar">' +
          '<div class="window-controls">' +
          '<div class="window-control close"></div>' +
          '<div class="window-control minimize"></div>' +
          '<div class="window-control maximize"></div>' +
          "</div>" +
          '<div class="window-title">' +
          '<i class="fas fa-cog" style="margin-right: 8px;"></i>' +
          "Settings" +
          "</div>" +
          "</div>" +
          '<div class="window-content" style="padding: 0; background: transparent;">' +
          createSettingsContent() +
          "</div>";

        const desktop = document.getElementById("desktop");
        if (desktop) {
          desktop.appendChild(windowEl);
        }
        activeWindows.set(title, windowId);
        focusWindow(windowId);

        setupWindowEvents(windowEl, windowId, title);
        setupSettingsEvents(windowEl);

        // Make window visible (fallback for when animations are off)
        setTimeout(() => {
          windowEl.classList.add("window-visible");
        }, 0);
      }

      // Create settings content
      function createSettingsContent() {
        return `
    <style>
      /* X-ORBIT Settings â€” Grouped Layout */
      .xorbit-settings-container {
        height: 100%;
        display: flex;
        background: #080414;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      
      /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .settings-sidebar {
        width: 210px;
        min-width: 210px;
        background: rgba(7, 3, 18, 0.97);
        border-right: 1px solid rgba(90, 50, 200, 0.15);
        padding: 0 0 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .settings-logo {
        padding: 18px 16px 16px;
        border-bottom: 1px solid rgba(90, 50, 200, 0.13);
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 9px;
      }

      .settings-logo i {
        font-size: 1rem;
        color: #7d5cff;
      }

      .settings-group-label {
        font-size: 0.6rem;
        font-weight: 700;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(160, 140, 230, 0.38);
        padding: 14px 16px 4px;
      }

      .settings-logo-text {
        font-size: 0.88rem;
        font-weight: 600;
        color: #b8b0d8;
        letter-spacing: 0.02em;
      }

      .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 9px;
        padding: 8px 10px;
        margin: 1px 8px;
        border-radius: 7px;
        cursor: pointer;
        transition: color 0.15s, background 0.15s;
        color: #9890b8;
        font-size: 0.85rem;
        font-weight: 500;
        position: relative;
      }
      
      .settings-nav-item i {
        width: 16px;
        text-align: center;
        font-size: 0.82rem;
        color: inherit;
        flex-shrink: 0;
      }

      .settings-nav-item:hover { background: rgba(100, 60, 220, 0.1); color: #ccc4ec; }
      .settings-nav-item.active { background: rgba(100, 60, 220, 0.16); color: #baaeff; font-weight: 600; }
      .settings-nav-item.active i { color: #9070f0; }

      .settings-nav-item .update-indicator {
        width: 6px; height: 6px; background: #ff5757; border-radius: 50%;
        margin-left: auto;
        animation: updateIndicatorPulse 2s cubic-bezier(0.4,0,0.2,1) infinite;
      }

      /* Main */
      .settings-main {
        flex: 1; overflow-y: auto; padding: 30px 32px 40px;
        background: linear-gradient(160deg, rgba(10,5,26,0.99) 0%, rgba(14,8,38,0.99) 100%);
      }

      .settings-section { display: none; }
      .settings-section.active { display: block; animation: settingsFadeIn 0.22s ease; }

      @keyframes settingsFadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to   { opacity: 1; transform: translateY(0); }
      }

      .settings-header { margin-bottom: 26px; padding-bottom: 18px; border-bottom: 1px solid rgba(90,50,200,0.13); }
      .settings-header h1 { font-size: 1.5rem; font-weight: 700; color: #e4dcff; margin: 0 0 5px; display: flex; align-items: center; gap: 11px; }
      .settings-header h1 i { color: #7d5cff; font-size: 1.2rem; }
      .settings-header p { font-size: 0.82rem; color: #6860a0; margin: 0; }

      .settings-subsection { margin-bottom: 22px; }
      .settings-subsection-title {
        font-size: 0.63rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
        color: rgba(150,130,220,0.45); padding-bottom: 9px; margin-bottom: 11px;
        border-bottom: 1px solid rgba(90,50,200,0.1);
      }
      .settings-subsection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      .settings-subsection-grid.single { grid-template-columns: 1fr; }

      .setting-card {
        background: rgba(18,10,42,0.75); border: 1px solid rgba(90,50,200,0.14);
        border-radius: 10px; padding: 14px 16px; position: relative;
        transition: border-color 0.18s, background 0.18s; overflow: hidden;
      }
      .setting-card:hover { border-color: rgba(110,70,240,0.28); background: rgba(22,13,50,0.85); }
      .setting-card::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(110,70,240,0.35), transparent);
        opacity: 0; transition: opacity 0.18s;
      }
      .setting-card:hover::before { opacity: 1; }

      .setting-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
      .setting-card-title { display: flex; align-items: center; gap: 9px; }
      .setting-card-icon {
        width: 30px; height: 30px;
        background: linear-gradient(135deg, rgba(110,70,240,0.22), rgba(50,120,240,0.13));
        border-radius: 7px; display: flex; align-items: center; justify-content: center;
        color: #9070f0; font-size: 0.8rem; flex-shrink: 0; border: 1px solid rgba(110,70,240,0.18);
      }
      .setting-card-label { font-size: 0.87rem; font-weight: 600; color: #d4ccf0; }
      .setting-card-desc { font-size: 0.75rem; color: #5850a0; margin-bottom: 10px; line-height: 1.4; }

      .xorbit-toggle {
        width: 38px; height: 21px; background: rgba(70,50,130,0.4); border-radius: 11px;
        position: relative; cursor: pointer; transition: background 0.22s cubic-bezier(0.4,0,0.2,1);
        border: 1px solid rgba(90,60,180,0.28); flex-shrink: 0;
      }
      .xorbit-toggle::before {
        content: ''; position: absolute; width: 15px; height: 15px; background: #c0b8e0;
        border-radius: 50%; top: 2px; left: 2px;
        transition: transform 0.22s cubic-bezier(0.68,-0.55,0.265,1.55), background 0.22s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      }
      .xorbit-toggle.active { background: linear-gradient(135deg,#7d5cff,#5a3fd0); border-color: rgba(120,80,255,0.45); }
      .xorbit-toggle.active::before { transform: translateX(17px); background: #fff; }

      .xorbit-select { position: relative; margin-top: 3px; }
      .xorbit-select select {
        width: 100%; background: rgba(12,7,30,0.85); border: 1px solid rgba(90,50,200,0.22);
        border-radius: 7px; color: #c0b8e0; padding: 7px 28px 7px 10px; font-size: 0.82rem;
        appearance: none; cursor: pointer; outline: none; transition: border-color 0.18s; font-family: inherit;
      }
      .xorbit-select select:focus { border-color: rgba(110,70,240,0.45); box-shadow: 0 0 0 2px rgba(110,70,240,0.09); }
      .xorbit-select::after { content: 'â–¾'; position: absolute; right: 9px; top: 50%; transform: translateY(-50%); color: #6860a0; pointer-events: none; font-size: 0.7rem; }

      .xorbit-slider-container { display: flex; align-items: center; gap: 9px; margin-top: 7px; }
      .xorbit-slider { flex: 1; -webkit-appearance: none; height: 3px; background: rgba(90,60,180,0.22); border-radius: 3px; outline: none; cursor: pointer; }
      .xorbit-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: linear-gradient(135deg,#9070f0,#7050d0); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(110,70,240,0.4); transition: transform 0.14s; }
      .xorbit-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
      .xorbit-slider::-moz-range-thumb { width: 14px; height: 14px; background: linear-gradient(135deg,#9070f0,#7050d0); border-radius: 50%; border: none; cursor: pointer; }
      .xorbit-slider-value { font-size: 0.75rem; color: #9070f0; font-weight: 600; min-width: 34px; text-align: right; }

      .xorbit-button {
        background: linear-gradient(135deg,rgba(110,70,240,0.22),rgba(50,120,240,0.16));
        border: 1px solid rgba(110,70,240,0.3); border-radius: 7px; color: #baaeff;
        padding: 8px 14px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.18s;
        display: flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit;
      }
      .xorbit-button:hover { background: linear-gradient(135deg,rgba(110,70,240,0.38),rgba(50,120,240,0.28)); border-color: rgba(110,70,240,0.55); transform: translateY(-1px); }
      .xorbit-button.danger { background: rgba(255,60,60,0.12); border-color: rgba(255,60,60,0.28); color: #ff7878; }
      .xorbit-button.danger:hover { background: rgba(255,60,60,0.24); border-color: rgba(255,60,60,0.5); }

      .wallpaper-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
      .wallpaper-preview { width: 100%; height: 76px; border-radius: 7px; border: 1px solid rgba(90,50,200,0.18); object-fit: cover; display: none; margin-top: 5px; }
      .wallpaper-presets-label { font-size: 0.75rem; color: rgba(180,160,255,0.7); margin: 10px 0 6px; text-transform: uppercase; letter-spacing: 0.05em; }
      .wallpaper-presets { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
      .wallpaper-preset-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: border-color 0.15s, transform 0.15s; }
      .wallpaper-preset-thumb:hover { border-color: rgba(120,80,255,0.7); transform: scale(1.04); }

      .backup-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
      .backup-note { font-size: 0.72rem; color: rgba(140,128,190,0.65); margin-top: 8px; line-height: 1.5; }

      /* â”€â”€ X-ORBIT Modal System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .xmodal-overlay {
        position: fixed; inset: 0;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 99999;
        display: none;
        align-items: center;
        justify-content: center;
      }
      .xmodal-overlay.show { display: flex; }
      .xmodal-card {
        background: rgba(14, 9, 32, 0.97);
        border: 1px solid rgba(120, 80, 255, 0.22);
        border-radius: 16px;
        padding: 28px 26px 22px;
        width: 340px;
        max-width: calc(100vw - 40px);
        box-shadow: 0 32px 80px rgba(0,0,0,0.65), 0 0 0 1px rgba(120,80,255,0.08) inset;
        animation: xmodalIn 0.22s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes xmodalIn {
        from { opacity: 0; transform: scale(0.90) translateY(10px); }
        to   { opacity: 1; transform: scale(1)    translateY(0);    }
      }
      .xmodal-icon {
        text-align: center; font-size: 1.8rem; margin-bottom: 13px;
      }
      .xmodal-title {
        font-size: 0.94rem; font-weight: 700; color: #ede6ff;
        text-align: center; margin-bottom: 7px; letter-spacing: -0.01em;
      }
      .xmodal-message {
        font-size: 0.80rem; color: rgba(180, 165, 220, 0.82);
        text-align: center; line-height: 1.65; margin-bottom: 22px;
      }
      .xmodal-actions { display: flex; gap: 8px; }
      .xmodal-actions button { flex: 1; }
      .xmodal-btn-primary {
        background: rgba(120, 80, 255, 0.22) !important;
        border-color: rgba(120, 80, 255, 0.42) !important;
        color: #b090ff !important;
      }
      .xmodal-btn-primary:hover {
        background: rgba(120, 80, 255, 0.34) !important;
        border-color: rgba(120, 80, 255, 0.6) !important;
      }

      .reset-all-button {
        width: 100%; background: rgba(255,50,50,0.09); border: 1px solid rgba(255,50,50,0.22);
        border-radius: 8px; color: #ff6868; padding: 11px 18px; font-size: 0.82rem; font-weight: 600;
        cursor: pointer; transition: all 0.18s; display: flex; align-items: center; justify-content: center;
        gap: 7px; font-family: inherit;
      }
      .reset-all-button:hover { background: rgba(255,50,50,0.18); border-color: rgba(255,50,50,0.42); transform: translateY(-1px); }

      /* About */
      .about-hero { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 28px 0 26px; border-bottom: 1px solid rgba(90,50,200,0.11); margin-bottom: 24px; }
      .about-logo-ring { width: 72px; height: 72px; border-radius: 20px; background: linear-gradient(135deg,rgba(110,70,240,0.25),rgba(50,120,240,0.15)); border: 1px solid rgba(110,70,240,0.3); display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 6px 24px rgba(110,70,240,0.2); }
      .about-logo-ring i { font-size: 2rem; color: #9070f0; }
      .about-os-name { font-size: 1.7rem; font-weight: 800; color: #e4dcff; letter-spacing: -0.02em; margin-bottom: 3px; }
      .about-version-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(110,70,240,0.13); border: 1px solid rgba(110,70,240,0.28); border-radius: 18px; padding: 3px 12px; font-size: 0.76rem; color: #9a80f0; font-weight: 600; margin-top: 7px; }
      .about-description { max-width: 400px; font-size: 0.82rem; color: #5850a0; line-height: 1.6; margin: 12px auto 0; }
      .about-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 22px; }
      .about-info-card { background: rgba(18,10,42,0.75); border: 1px solid rgba(90,50,200,0.13); border-radius: 9px; padding: 12px 14px; }
      .about-info-label { font-size: 0.62rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(150,130,220,0.42); margin-bottom: 4px; }
      .about-info-value { font-size: 0.85rem; font-weight: 600; color: #c0b8e0; }
      .about-credits-title { font-size: 0.62rem; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(150,130,220,0.42); padding-bottom: 9px; margin-bottom: 10px; border-bottom: 1px solid rgba(90,50,200,0.1); }
      .about-credit-item { display: flex; align-items: center; gap: 11px; padding: 9px 0; border-bottom: 1px solid rgba(90,50,200,0.07); }
      .about-credit-item:last-child { border-bottom: none; }
      .about-credit-avatar { width: 34px; height: 34px; border-radius: 9px; background: linear-gradient(135deg,rgba(110,70,240,0.25),rgba(50,120,240,0.15)); border: 1px solid rgba(110,70,240,0.22); display: flex; align-items: center; justify-content: center; color: #9070f0; font-size: 0.85rem; flex-shrink: 0; }
      .about-credit-name { font-size: 0.87rem; font-weight: 600; color: #c0b8e0; }
      .about-credit-role { font-size: 0.72rem; color: #5850a0; }
      .about-copyright { text-align: center; font-size: 0.72rem; color: rgba(110,90,170,0.38); margin-top: 22px; padding-top: 14px; border-top: 1px solid rgba(90,50,200,0.09); }

      /* Save indicator */
      .xorbit-save-indicator { position: fixed; bottom: 22px; right: 22px; background: linear-gradient(135deg,rgba(40,202,66,0.92),rgba(28,158,52,0.92)); color: #fff; padding: 9px 16px; border-radius: 22px; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 7px; opacity: 0; transform: translateY(8px); transition: opacity 0.25s, transform 0.25s; pointer-events: none; box-shadow: 0 4px 14px rgba(40,202,66,0.35); z-index: 100; }
      .xorbit-save-indicator.show { opacity: 1; transform: translateY(0); }

      /* Keyframes */
      @keyframes updatePulse { 0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.5} 50%{transform:translate(-50%,-50%) scale(1.1);opacity:1} }
      @keyframes updateSpin  { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
      @keyframes updateSuccess { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
      @keyframes updateIndicatorPulse { 0%,100%{opacity:1} 50%{opacity:0.38} }
      @keyframes updateFadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

      /* â”€â”€ Software Update: Settings Panel States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .upd-panel {
        border-radius: 12px;
        padding: 22px 20px;
        position: relative;
        overflow: hidden;
        animation: updateFadeIn 0.28s ease;
      }
      .upd-panel-glow {
        position: absolute; inset: 0; border-radius: inherit;
        background: radial-gradient(ellipse at 50% -10%, rgba(110,70,240,0.14) 0%, transparent 65%);
        pointer-events: none;
      }
      .upd-body { position: relative; display: flex; flex-direction: column; align-items: center; }

      /* Icon circle */
      .upd-icon {
        width: 52px; height: 52px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 14px; font-size: 1.25rem; flex-shrink: 0;
      }
      .upd-icon-checking {
        background: rgba(120, 80, 255, 0.12);
        border: 1px solid rgba(120, 80, 255, 0.22);
        color: #9070ff;
      }
      .upd-icon-ok {
        background: rgba(52, 199, 89, 0.12);
        border: 1px solid rgba(52, 199, 89, 0.25);
        color: #34c759;
      }
      .upd-icon-available {
        background: rgba(120, 80, 255, 0.14);
        border: 1px solid rgba(120, 80, 255, 0.28);
        color: #9070ff;
      }
      .upd-icon-error {
        background: rgba(255, 69, 58, 0.1);
        border: 1px solid rgba(255, 69, 58, 0.22);
        color: #ff453a;
      }

      /* Text */
      .upd-title {
        font-size: 0.92rem; font-weight: 600; margin-bottom: 4px; letter-spacing: -0.01em;
      }
      .upd-title-checking { color: #c8bcf5; }
      .upd-title-ok       { color: #34c759; }
      .upd-title-available{ color: #9d80ff; }
      .upd-title-error    { color: #ff453a; }
      .upd-subtitle {
        font-size: 0.76rem; color: rgba(160, 148, 200, 0.7); margin-top: 2px; text-align: center; line-height: 1.5;
      }

      /* Panel backgrounds */
      .upd-panel-checking {
        background: rgba(120, 80, 255, 0.06);
        border: 1px solid rgba(120, 80, 255, 0.14);
      }
      .upd-panel-ok {
        background: rgba(52, 199, 89, 0.06);
        border: 1px solid rgba(52, 199, 89, 0.16);
      }
      .upd-panel-available {
        background: rgba(120, 80, 255, 0.07);
        border: 1px solid rgba(120, 80, 255, 0.18);
        margin-bottom: 12px;
      }

      /* â”€â”€ Update available: compact horizontal card â”€â”€ */
      .upd-avail-card {
        position: relative;
        background: rgba(120, 80, 255, 0.07);
        border: 1px solid rgba(120, 80, 255, 0.18);
        border-radius: 12px;
        padding: 14px 16px;
        overflow: hidden;
        animation: updateFadeIn 0.28s ease;
      }
      .upd-avail-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      /* Square OS icon */
      .upd-app-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(100, 60, 220, 0.45);
        overflow: hidden;
        flex-shrink: 0;
      }
      .upd-avail-info {
        flex: 1;
        min-width: 0;
      }
      .upd-avail-name {
        font-size: 0.86rem;
        font-weight: 600;
        color: #e0d8ff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        letter-spacing: -0.01em;
      }
      .upd-avail-meta {
        font-size: 0.72rem;
        color: rgba(160, 148, 210, 0.7);
        margin-top: 2px;
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .upd-avail-dot { opacity: 0.4; }
      .upd-avail-btns {
        display: flex;
        gap: 7px;
        flex-shrink: 0;
      }
      .upd-btn-later {
        font-size: 0.76rem !important;
        padding: 5px 12px !important;
        color: rgba(160, 148, 210, 0.8) !important;
      }
      .upd-btn-now {
        font-size: 0.76rem !important;
        padding: 5px 13px !important;
        background: rgba(120, 80, 255, 0.2) !important;
        border-color: rgba(120, 80, 255, 0.4) !important;
        color: #b090ff !important;
      }
      .upd-btn-now:hover {
        background: rgba(120, 80, 255, 0.32) !important;
        border-color: rgba(120, 80, 255, 0.6) !important;
      }

      /* Inline progress section */
      .upd-inline-progress {
        margin-top: 14px;
        padding-top: 12px;
        border-top: 1px solid rgba(120, 80, 255, 0.14);
        animation: updateFadeIn 0.25s ease;
      }
      .upd-inline-status-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 7px;
      }
      .upd-inline-status {
        font-size: 0.74rem;
        color: rgba(170, 155, 225, 0.85);
      }
      .upd-inline-pct {
        font-size: 0.72rem;
        font-weight: 600;
        color: rgba(160, 140, 220, 0.9);
        font-variant-numeric: tabular-nums;
      }
      .upd-inline-track {
        width: 100%;
        height: 5px;
        background: rgba(255, 255, 255, 0.07);
        border-radius: 99px;
        overflow: hidden;
      }
      .upd-inline-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #7d5cff 0%, #5b8fff 100%);
        border-radius: 99px;
        transition: width 0.45s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }
      .upd-inline-bar::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: progressShine 1.8s ease-in-out infinite;
      }
      .upd-inline-time {
        font-size: 0.68rem;
        color: rgba(130, 118, 180, 0.6);
        margin-top: 5px;
        text-align: right;
      }
      .upd-panel-error {
        background: rgba(255, 69, 58, 0.06);
        border: 1px solid rgba(255, 69, 58, 0.16);
      }

      /* Version name + badges */
      .upd-version-name {
        font-size: 0.84rem; font-weight: 600; color: #ddd4ff; margin-top: 10px; margin-bottom: 8px;
      }
      .upd-version-row {
        display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;
      }
      .upd-badge {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 3px 9px; border-radius: 99px; font-size: 0.72rem; font-weight: 600;
      }
      .upd-badge-version {
        background: rgba(120, 80, 255, 0.14); border: 1px solid rgba(120, 80, 255, 0.22); color: #a888ff;
      }
      .upd-badge-size {
        background: rgba(50, 120, 255, 0.12); border: 1px solid rgba(50, 120, 255, 0.22); color: #6e9eff;
      }

      /* Action buttons */
      .upd-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 14px; }
      .upd-actions-single { display: block; margin-top: 12px; }
      .upd-btn-update {
        background: rgba(52, 199, 89, 0.14) !important;
        border-color: rgba(52, 199, 89, 0.3) !important;
        color: #34c759 !important;
      }
      .upd-btn-update:hover {
        background: rgba(52, 199, 89, 0.24) !important;
        border-color: rgba(52, 199, 89, 0.45) !important;
      }

      .settings-sidebar::-webkit-scrollbar,.settings-main::-webkit-scrollbar{width:4px}
      .settings-sidebar::-webkit-scrollbar-track,.settings-main::-webkit-scrollbar-track{background:transparent}
      .settings-sidebar::-webkit-scrollbar-thumb,.settings-main::-webkit-scrollbar-thumb{background:rgba(110,70,240,0.22);border-radius:4px}
    </style>

    <div class="xorbit-settings-container">
      <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="settings-sidebar">
        <div class="settings-logo">
          <i class="fas fa-sliders-h"></i>
          <div class="settings-logo-text">Settings</div>
        </div>

        <div class="settings-group-label">System</div>
        <div class="settings-nav-item active" data-section="general">
          <i class="fas fa-gear"></i><span>General</span>
        </div>
        <div class="settings-nav-item" data-section="about">
          <i class="fas fa-info-circle"></i><span>About</span>
        </div>

        <div class="settings-group-label">Customize</div>
        <div class="settings-nav-item" data-section="personalization">
          <i class="fas fa-paint-brush"></i><span>Personalization</span>
        </div>
        <div class="settings-nav-item" data-section="other">
          <i class="fas fa-layer-group"></i><span>Other</span>
        </div>
      </div>
      
      <!-- â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
      <div class="settings-main">
        <!-- â•â• GENERAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="settings-section active" id="general-section">
          <div class="settings-header">
            <h1><i class="fas fa-gear"></i> General</h1>
            <p>Core system settings and software management</p>
          </div>

          <!-- Software Update -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Software Update</div>
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon"><i class="fas fa-sync-alt"></i></div>
                  <div><div class="setting-card-label">Software Update</div></div>
                </div>
              </div>
              <div class="setting-card-desc">Keep X-ORBIT Desktop up to date with the latest features and fixes</div>
              <div id="updateCheckContainer" style="margin-top:16px;">

                <!-- Checking state -->
                <div id="updateCheckStatus" class="upd-panel upd-panel-checking">
                  <div class="upd-panel-glow"></div>
                  <div class="upd-body">
                    <div class="upd-icon upd-icon-checking">
                      <i class="fas fa-sync-alt" style="animation:updateSpin 1.6s linear infinite;"></i>
                    </div>
                    <div class="upd-title upd-title-checking">Checking for Updates</div>
                    <div class="upd-subtitle">Connecting to update servers&hellip;</div>
                  </div>
                </div>

                <!-- Update available state -->
                <div id="updateAvailable" style="display:none;">
                  <div class="upd-avail-card">
                    <div class="upd-panel-glow"></div>
                    <!-- Row: icon + info + buttons -->
                    <div class="upd-avail-row">
                      <div class="upd-app-icon">
                        <img src="https://codehs.com/uploads/42ce6a1e246002918d2346eb0a2ce1ce" alt="X-ORBIT" style="width:100%;height:100%;object-fit:cover;border-radius:10px;">
                      </div>
                      <div class="upd-avail-info">
                        <div class="upd-avail-name" id="updateVersionName">X-ORBIT Desktop</div>
                        <div class="upd-avail-meta">
                          <span id="updateVersionNumber"></span>
                          <span class="upd-avail-dot">Â·</span>
                          <span id="updateSize">Loadingâ€¦</span>
                        </div>
                      </div>
                      <div class="upd-avail-btns">
                        <button class="xorbit-button upd-btn-later" id="updateLaterBtn">Later</button>
                        <button class="xorbit-button upd-btn-now" id="updateNowBtn"><i class="fas fa-arrow-down"></i> Update</button>
                      </div>
                    </div>
                    <!-- Inline progress â€” hidden until Update is clicked -->
                    <div id="updateInlineProgress" class="upd-inline-progress" style="display:none;">
                      <div class="upd-inline-status-row">
                        <span class="upd-inline-status" id="updateProgressStatus">Preparingâ€¦</span>
                        <span class="upd-inline-pct" id="updateProgressPercent">0%</span>
                      </div>
                      <div class="upd-inline-track">
                        <div class="upd-inline-bar" id="updateProgressBar"></div>
                      </div>
                      <div class="upd-inline-time" id="updateProgressTime"></div>
                    </div>
                  </div>
                </div>

                <!-- Up to date state -->
                <div id="upToDate" style="display:none;">
                  <div class="upd-panel upd-panel-ok">
                    <div class="upd-panel-glow"></div>
                    <div class="upd-body">
                      <div class="upd-icon upd-icon-ok">
                        <i class="fas fa-check" style="animation:updateSuccess 2.5s ease-in-out infinite;"></i>
                      </div>
                      <div class="upd-title upd-title-ok">You're up to date!</div>
                      <div class="upd-subtitle">X-ORBIT Desktop v5.2.3B Ventas &mdash; latest version installed</div>
                    </div>
                  </div>
                  <div class="upd-actions-single">
                    <button class="xorbit-button" id="recheckUpdateBtn" style="width:100%;"><i class="fas fa-sync"></i> Check Again</button>
                  </div>
                </div>

                <!-- Error state -->
                <div id="updateError" style="display:none;">
                  <div class="upd-panel upd-panel-error">
                    <div class="upd-body">
                      <div class="upd-icon upd-icon-error">
                        <i class="fas fa-exclamation-triangle"></i>
                      </div>
                      <div class="upd-title upd-title-error">Update Check Failed</div>
                      <div class="upd-subtitle">Unable to reach update servers</div>
                    </div>
                  </div>
                  <div class="upd-actions-single">
                    <button class="xorbit-button danger" id="retryUpdateBtn" style="width:100%;"><i class="fas fa-redo"></i> Retry</button>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Startup & Launch -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Startup &amp; Launch</div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-expand-arrows-alt"></i></div>
                    <div><div class="setting-card-label">Launch Fullscreen</div></div>
                  </div>
                  <div class="xorbit-toggle" id="launchFullscreenToggle"></div>
                </div>
                <div class="setting-card-desc">Start X-ORBIT in fullscreen mode for an immersive experience</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-window-maximize"></i></div>
                    <div><div class="setting-card-label">Startup Window</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Choose what opens automatically when X-ORBIT launches</div>
                <div class="xorbit-select">
                  <select id="startupWindowsSelect">
                    <option value="welcome">Welcome Screen</option>
                    <option value="none">None (Disabled)</option>
                    <option value="browser">Browser</option>
                    <option value="terminal">Minecraft</option>
                    <option value="settings">Settings</option>
                    <option value="files">File Manager</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Performance</div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-bolt"></i></div>
                    <div><div class="setting-card-label">Animations</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="animationsToggle"></div>
                </div>
                <div class="setting-card-desc">Enable smooth transitions throughout the interface</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-layer-group"></i></div>
                    <div><div class="setting-card-label">Transparency</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="transparencyToggle"></div>
                </div>
                <div class="setting-card-desc">Glass morphism and backdrop blur for windows and dock</div>
              </div>
            </div>
          </div>
        </div>

        <!-- â•â• PERSONALIZATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="settings-section" id="personalization-section">
          <div class="settings-header">
            <h1><i class="fas fa-paint-brush"></i> Personalization</h1>
            <p>Customize the look and feel of your X-ORBIT desktop</p>
          </div>

          <!-- Theme & Color -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Theme &amp; Color</div>
            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon"><i class="fas fa-moon"></i></div>
                  <div><div class="setting-card-label">Color Theme</div></div>
                </div>
              </div>
              <div class="setting-card-desc">Choose your preferred color scheme for the desktop environment</div>
              <div class="xorbit-select">
                <select id="themeSelect">
                  <option value="dark">Dark Mode</option>
                  <option value="light">Light Mode</option>
                  <option value="orange">Halloween 2025</option>
                  <option value="auto">Auto (System)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Desktop placeholder; wallpaper card below -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Desktop</div>
            
            <!-- Wallpaper -->
            <div class="setting-card" style="margin-bottom:12px;">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon"><i class="fas fa-image"></i></div>
                  <div><div class="setting-card-label">Desktop Wallpaper</div></div>
                </div>
              </div>
              <div class="setting-card-desc">Upload a custom background image or restore the default</div>
              <div class="wallpaper-controls">
                <button class="xorbit-button" onclick="document.getElementById('wallpaperUpload').click()"><i class="fas fa-upload"></i> Upload Image</button>
                <button class="xorbit-button danger" onclick="resetWallpaper()"><i class="fas fa-undo"></i> Reset Default</button>
              </div>
              <input type="file" id="wallpaperUpload" accept="image/*" style="display:none;">
              <img id="wallpaperPreview" class="wallpaper-preview" alt="Wallpaper preview">
              <div class="wallpaper-presets-label">Default Wallpapers</div>
              <div class="wallpaper-presets">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/d91102c835effc9c3856c7daef320895" onclick="setPresetWallpaper(this.src)" title="Preset 1">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/33f4df933a540b5e1647a28a506c8e79" onclick="setPresetWallpaper(this.src)" title="Preset 2">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/d94bb7b7aa8af986990f1fa97215c813" onclick="setPresetWallpaper(this.src)" title="Preset 3">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/e2f2a83d14c5aee58f6ab7f474918fe0" onclick="setPresetWallpaper(this.src)" title="Preset 4">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/889639ce12e33851cc220a16dcdc8644" onclick="setPresetWallpaper(this.src)" title="Preset 5">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/3ecd035b21f16d948c4dc9bcbfc97348" onclick="setPresetWallpaper(this.src)" title="Preset 6">
                <img class="wallpaper-preset-thumb" src="https://codehs.com/uploads/84055eb5a4bb26ebb3c8bb1ae9776efb" onclick="setPresetWallpaper(this.src)" title="Preset 7">
              </div>
            </div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-adjust"></i></div>
                    <div><div class="setting-card-label">Background Opacity</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Adjust window and element transparency levels</div>
                <div class="xorbit-slider-container">
                  <input type="range" class="xorbit-slider" id="opacityRange" min="20" max="100" value="80">
                  <span class="xorbit-slider-value" id="opacityValue">80%</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Menu Bar -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Menu Bar</div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-bars"></i></div>
                    <div><div class="setting-card-label">Show Menu Bar</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="showMenuBarToggle"></div>
                </div>
                <div class="setting-card-desc">Display or hide the menu bar at the top of the screen</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-eye-slash"></i></div>
                    <div><div class="setting-card-label">Auto-hide</div></div>
                  </div>
                  <div class="xorbit-toggle" id="autohideMenuBarToggle"></div>
                </div>
                <div class="setting-card-desc">Automatically hide the menu bar, show on hover</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-sun"></i></div>
                    <div><div class="setting-card-label">Bar Opacity</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Opacity of the menu bar background</div>
                <div class="xorbit-slider-container">
                  <input type="range" class="xorbit-slider" id="menuBarOpacityRange" min="20" max="100" value="80">
                  <span class="xorbit-slider-value" id="menuBarOpacityValue">80%</span>
                </div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-wind"></i></div>
                    <div><div class="setting-card-label">Bar Blur</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Backdrop blur intensity of the menu bar</div>
                <div class="xorbit-slider-container">
                  <input type="range" class="xorbit-slider" id="menuBarBlurRange" min="0" max="60" value="40">
                  <span class="xorbit-slider-value" id="menuBarBlurValue">40px</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Windows -->
          <div class="settings-subsection">
            <div class="settings-subsection-title">Windows</div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-th-large"></i></div>
                    <div><div class="setting-card-label">Window Snapping</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="snappingToggle"></div>
                </div>
                <div class="setting-card-desc">Snap windows to screen edges for organized layouts</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-clone"></i></div>
                    <div><div class="setting-card-label">Window Shadows</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="shadowsToggle"></div>
                </div>
                <div class="setting-card-desc">Enable drop shadows to add depth to windows</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-water"></i></div>
                    <div><div class="setting-card-label">Jelly Mode</div></div>
                  </div>
                  <div class="xorbit-toggle" id="jellyModeToggle"></div>
                </div>
                <div class="setting-card-desc">Windows wobble and jiggle as they are dragged</div>
              </div>
            </div>
          </div>
        </div>

        <!-- â•â• OTHER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="settings-section" id="other-section">
          <div class="settings-header">
            <h1><i class="fas fa-layer-group"></i> Other</h1>
            <p>Dock configuration and advanced maintenance options</p>
          </div>

          <div class="settings-subsection">
            <div class="settings-subsection-title">Dock</div>
            <div class="settings-subsection-grid">
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-eye-slash"></i></div>
                    <div><div class="setting-card-label">Auto-hide Dock</div></div>
                  </div>
                  <div class="xorbit-toggle" id="autohideToggle"></div>
                </div>
                <div class="setting-card-desc">Hide the dock when not in use, show on hover</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-search-plus"></i></div>
                    <div><div class="setting-card-label">Magnification</div></div>
                  </div>
                  <div class="xorbit-toggle active" id="magnificationToggle"></div>
                </div>
                <div class="setting-card-desc">Enlarge dock icons when hovered for easier targeting</div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-compass"></i></div>
                    <div><div class="setting-card-label">Dock Position</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Set where the dock appears on the screen</div>
                <div class="xorbit-select" style="margin-top:8px;">
                  <select id="dockPositionSelect">
                    <option value="bottom">Bottom</option>
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                  </select>
                </div>
              </div>
              <div class="setting-card">
                <div class="setting-card-header">
                  <div class="setting-card-title">
                    <div class="setting-card-icon"><i class="fas fa-ruler-horizontal"></i></div>
                    <div><div class="setting-card-label">Dock Size</div></div>
                  </div>
                </div>
                <div class="setting-card-desc">Adjust the size of dock icons</div>
                <div class="xorbit-slider-container">
                  <input type="range" class="xorbit-slider" id="dockSizeRange" min="32" max="80" value="56">
                  <span class="xorbit-slider-value" id="dockSizeValue">56px</span>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-subsection">
            <div class="settings-subsection-title">Maintenance</div>

            <!-- Data & Backup -->
            <div class="setting-card" style="margin-bottom:12px;">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon"><i class="fas fa-box-archive"></i></div>
                  <div><div class="setting-card-label">Data &amp; Backup</div></div>
                </div>
              </div>
              <div class="setting-card-desc">Export your settings and wallpaper as a backup file, or import one to restore them instantly.</div>
              <div class="backup-actions">
                <button class="xorbit-button" onclick="exportBackup()"><i class="fas fa-download"></i> Export Backup</button>
                <button class="xorbit-button" onclick="document.getElementById('backupImportInput').click()"><i class="fas fa-upload"></i> Import Backup</button>
              </div>
              <input type="file" id="backupImportInput" accept=".json" style="display:none;" onchange="importBackup(event)">
              <div class="backup-note"><i class="fas fa-shield-alt" style="color:#7d5cff;margin-right:4px;"></i>Device ID and login session are never exported &mdash; those stay computer-specific.</div>
            </div>

            <div class="setting-card">
              <div class="setting-card-header">
                <div class="setting-card-title">
                  <div class="setting-card-icon" style="background:rgba(255,50,50,0.13);border-color:rgba(255,50,50,0.18);color:#ff6868;">
                    <i class="fas fa-undo-alt"></i>
                  </div>
                  <div><div class="setting-card-label" style="color:#ff6868;">Reset All Settings</div></div>
                </div>
              </div>
              <div class="setting-card-desc">Restore all settings to their factory defaults. This cannot be undone.</div>
              <div style="margin-top:10px;">
                <button class="reset-all-button" id="resetButton">
                  <i class="fas fa-undo-alt"></i> Reset All Settings to Default
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- â•â• ABOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="settings-section" id="about-section">
          <div class="settings-header">
            <h1><i class="fas fa-info-circle"></i> About X-ORBIT Desktop</h1>
            <p>Version information and credits</p>
          </div>

          <div class="about-hero">
            <div class="about-logo-ring"><i class="fas fa-globe"></i></div>
            <div class="about-os-name">X-ORBIT Desktop</div>
            <div class="about-version-badge"><i class="fas fa-tag"></i> v5.2.3B Ventas</div>
            <div class="about-description">
              X-ORBIT Desktop is a web-based proxy OS built for students. X-ORBIT allows students and people around the world to browse the world wide web without restrictions or data leaks.
            </div>
          </div>

          <div class="about-info-grid">
            <div class="about-info-card">
              <div class="about-info-label">Version</div>
              <div class="about-info-value">v5.2.3B Ventas</div>
            </div>
            <div class="about-info-card">
              <div class="about-info-label">Build</div>
              <div class="about-info-value">v5.1 Beta</div>
            </div>
            <div class="about-info-card">
              <div class="about-info-label">Platform</div>
              <div class="about-info-value">Web / Portable</div>
            </div>
            <div class="about-info-card">
              <div class="about-info-label">Engine</div>
              <div class="about-info-value">Supabase + Vanilla JS</div>
            </div>
          </div>

          <div class="about-credits-title">Credits</div>
          <div class="about-credit-item">
            <div class="about-credit-avatar"><i class="fas fa-code"></i></div>
            <div>
              <div class="about-credit-name">Demitri Burns</div>
              <div class="about-credit-role">Creator &amp; Lead Developer</div>
            </div>
          </div>
          <div class="about-credit-item">
            <div class="about-credit-avatar"><i class="fas fa-palette"></i></div>
            <div>
              <div class="about-credit-name">Demitri Burns</div>
              <div class="about-credit-role">UI/UX &amp; Visual Design</div>
            </div>
          </div>
          <div class="about-credit-item">
            <div class="about-credit-avatar"><i class="fas fa-database"></i></div>
            <div>
              <div class="about-credit-name">Supabase</div>
              <div class="about-credit-role">Backend &amp; Authentication Infrastructure</div>
            </div>
          </div>
          <div class="about-credit-item">
            <div class="about-credit-avatar"><i class="fab fa-font-awesome"></i></div>
            <div>
              <div class="about-credit-name">Font Awesome</div>
              <div class="about-credit-role">Icon Library</div>
            </div>
          </div>
          <div class="about-copyright">&copy; 2025 X-ORBIT. All rights reserved. Built with care for the web.</div>
        </div>

        <div class="xorbit-save-indicator" id="saveIndicator">
          <i class="fas fa-check-circle"></i> Settings saved!
        </div>
      </div>
    </div>
  `;
      }

      // Setup settings event handlers
      // Setup settings event handlers
      function setupSettingsEvents(windowEl) {
        const settingsContent = windowEl.querySelector(".window-content");

        // Navigation
        const navItems = settingsContent.querySelectorAll(".settings-nav-item");
        navItems.forEach((item) => {
          item.addEventListener("click", function () {
            // Update active state
            navItems.forEach((nav) => nav.classList.remove("active"));
            this.classList.add("active");

            // Show corresponding section
            const section = this.dataset.section;
            const sections =
              settingsContent.querySelectorAll(".settings-section");
            sections.forEach((sec) => sec.classList.remove("active"));
            settingsContent
              .querySelector(`#${section}-section`)
              .classList.add("active");

            // If General section, check for updates
            if (section === "general") {
              setTimeout(() => {
                checkForSystemUpdates();
              }, 300);
            }
          });
        });

        // Load current settings into UI
        function loadSettingsUI() {
          const themeSelect = settingsContent.querySelector("#themeSelect");
          const transparencyToggle = settingsContent.querySelector(
            "#transparencyToggle"
          );
          const animationsToggle =
            settingsContent.querySelector("#animationsToggle");
          const opacityRange = settingsContent.querySelector("#opacityRange");
          const opacityValue = settingsContent.querySelector("#opacityValue");
          const autohideToggle =
            settingsContent.querySelector("#autohideToggle");
          const dockPositionSelect = settingsContent.querySelector(
            "#dockPositionSelect"
          );
          const dockSizeRange = settingsContent.querySelector("#dockSizeRange");
          const dockSizeValue = settingsContent.querySelector("#dockSizeValue");
          const magnificationToggle = settingsContent.querySelector(
            "#magnificationToggle"
          );
          const snappingToggle =
            settingsContent.querySelector("#snappingToggle");
          const shadowsToggle = settingsContent.querySelector("#shadowsToggle");
          const jellyModeToggle = settingsContent.querySelector("#jellyModeToggle");
          const launchFullscreenToggle = settingsContent.querySelector(
            "#launchFullscreenToggle"
          );
          const startupWindowsSelect = settingsContent.querySelector(
            "#startupWindowsSelect"
          );

          if (themeSelect) themeSelect.value = settings.theme;
          if (transparencyToggle)
            transparencyToggle.classList.toggle(
              "active",
              settings.transparency
            );
          if (animationsToggle)
            animationsToggle.classList.toggle("active", settings.animations);
          if (opacityRange) {
            opacityRange.value = settings.backgroundOpacity;
            if (opacityValue)
              opacityValue.textContent = settings.backgroundOpacity + "%";
          }
          if (autohideToggle)
            autohideToggle.classList.toggle("active", settings.dockAutohide);
          if (dockPositionSelect)
            dockPositionSelect.value = settings.dockPosition;
          if (dockSizeRange) {
            dockSizeRange.value = settings.dockSize;
            if (dockSizeValue)
              dockSizeValue.textContent = settings.dockSize + "px";
          }
          if (magnificationToggle)
            magnificationToggle.classList.toggle(
              "active",
              settings.dockMagnification
            );
          if (snappingToggle)
            snappingToggle.classList.toggle("active", settings.windowSnapping);
          if (shadowsToggle)
            shadowsToggle.classList.toggle("active", settings.windowShadows);
          if (jellyModeToggle)
            jellyModeToggle.classList.toggle("active", settings.jellyMode);
          if (launchFullscreenToggle)
            launchFullscreenToggle.classList.toggle(
              "active",
              settings.launchFullscreen
            );
          if (startupWindowsSelect)
            startupWindowsSelect.value = settings.startupWindows || "welcome";

          // Menu Bar settings
          const showMenuBarToggle = settingsContent.querySelector("#showMenuBarToggle");
          const autohideMenuBarToggle = settingsContent.querySelector("#autohideMenuBarToggle");
          const menuBarOpacityRange = settingsContent.querySelector("#menuBarOpacityRange");
          const menuBarOpacityValue = settingsContent.querySelector("#menuBarOpacityValue");
          const menuBarBlurRange = settingsContent.querySelector("#menuBarBlurRange");
          const menuBarBlurValue = settingsContent.querySelector("#menuBarBlurValue");

          if (showMenuBarToggle)
            showMenuBarToggle.classList.toggle("active", settings.showMenuBar !== false);
          if (autohideMenuBarToggle)
            autohideMenuBarToggle.classList.toggle("active", settings.autohideMenuBar || false);
          if (menuBarOpacityRange) {
            menuBarOpacityRange.value = settings.menuBarOpacity || 80;
            if (menuBarOpacityValue)
              menuBarOpacityValue.textContent = (settings.menuBarOpacity || 80) + "%";
          }
          if (menuBarBlurRange) {
            menuBarBlurRange.value = settings.menuBarBlur || 40;
            if (menuBarBlurValue)
              menuBarBlurValue.textContent = (settings.menuBarBlur || 40) + "px";
          }

          // Update wallpaper preview if custom wallpaper is set
          if (settings.customWallpaper) {
            updateWallpaperPreview(settings.customWallpaper);
          }
        }

        // Save settings
        function saveSettings() {
          localStorage.setItem("xorbit-settings", JSON.stringify(settings));
          applySettings();
          showSaveIndicator();
        }

        // Show save indicator
        function showSaveIndicator() {
          const indicator = settingsContent.querySelector("#saveIndicator");
          if (indicator) {
            indicator.classList.add("show");
            setTimeout(() => {
              indicator.classList.remove("show");
            }, 2000);
          }
        }

        // Load initial settings
        loadSettingsUI();

        // Theme select
        const themeSelect = settingsContent.querySelector("#themeSelect");
        if (themeSelect) {
          themeSelect.addEventListener("change", function () {
            settings.theme = this.value;
            loadTheme(this.value);
            saveSettings();
          });
        }

        // Toggle switches
        settingsContent.querySelectorAll(".xorbit-toggle").forEach((toggle) => {
          toggle.addEventListener("click", function () {
            const isActive = this.classList.contains("active");
            this.classList.toggle("active", !isActive);

            const setting = this.id.replace("Toggle", "");
            console.log("Toggle clicked:", this.id, "â†’", setting, "| was active:", isActive, "â†’ will be:", !isActive);
            
            switch (setting) {
              case "transparency":
                settings.transparency = !isActive;
                break;
              case "animations":
                settings.animations = !isActive;
                break;
              case "autohide":
                settings.dockAutohide = !isActive;
                break;
              case "magnification":
                settings.dockMagnification = !isActive;
                break;
              case "snapping":
                settings.windowSnapping = !isActive;
                break;
              case "shadows":
                settings.windowShadows = !isActive;
                break;
              case "jellyMode":
                settings.jellyMode = !isActive;
                break;
              case "launchFullscreen":
                settings.launchFullscreen = !isActive;
                console.log("Updated launchFullscreen to:", settings.launchFullscreen);
                break;
              case "showMenuBar":
                settings.showMenuBar = !isActive;
                console.log("Updated showMenuBar to:", settings.showMenuBar);
                break;
              case "autohideMenuBar":
                settings.autohideMenuBar = !isActive;
                console.log("Updated autohideMenuBar to:", settings.autohideMenuBar);
                break;
              default:
                console.warn("Unknown setting toggle:", setting);
                break;
            }

            console.log("Calling saveSettings...");
            saveSettings();
          });
        });

        // Dock position select
        const dockPositionSelect = settingsContent.querySelector(
          "#dockPositionSelect"
        );
        if (dockPositionSelect) {
          dockPositionSelect.addEventListener("change", function () {
            settings.dockPosition = this.value;
            saveSettings();
          });
        }

        // Startup windows select
        const startupWindowsSelect = settingsContent.querySelector(
          "#startupWindowsSelect"
        );
        if (startupWindowsSelect) {
          startupWindowsSelect.addEventListener("change", function () {
            settings.startupWindows = this.value;
            saveSettings();
          });
        }

        // Range sliders
        const opacityRange = settingsContent.querySelector("#opacityRange");
        const opacityValue = settingsContent.querySelector("#opacityValue");
        if (opacityRange && opacityValue) {
          opacityRange.addEventListener("input", function () {
            settings.backgroundOpacity = parseInt(this.value);
            opacityValue.textContent = this.value + "%";
            saveSettings();
          });
        }

        const dockSizeRange = settingsContent.querySelector("#dockSizeRange");
        const dockSizeValue = settingsContent.querySelector("#dockSizeValue");
        if (dockSizeRange && dockSizeValue) {
          dockSizeRange.addEventListener("input", function () {
            settings.dockSize = parseInt(this.value);
            dockSizeValue.textContent = this.value + "px";
            saveSettings();
          });
        }

        // Menu Bar sliders
        const menuBarOpacityRange = settingsContent.querySelector("#menuBarOpacityRange");
        const menuBarOpacityValue = settingsContent.querySelector("#menuBarOpacityValue");
        if (menuBarOpacityRange && menuBarOpacityValue) {
          menuBarOpacityRange.addEventListener("input", function () {
            settings.menuBarOpacity = parseInt(this.value);
            menuBarOpacityValue.textContent = this.value + "%";
            saveSettings();
          });
        }

        const menuBarBlurRange = settingsContent.querySelector("#menuBarBlurRange");
        const menuBarBlurValue = settingsContent.querySelector("#menuBarBlurValue");
        if (menuBarBlurRange && menuBarBlurValue) {
          menuBarBlurRange.addEventListener("input", function () {
            settings.menuBarBlur = parseInt(this.value);
            menuBarBlurValue.textContent = this.value + "px";
            saveSettings();
          });
        }

        // Reset button
        const resetButton = settingsContent.querySelector("#resetButton");
        if (resetButton) {
          resetButton.addEventListener("click", function () {
            xModal.confirm(
              "This will restore all settings to factory defaults. This cannot be undone.",
              () => {
              settings = {
                theme: "dark",
                transparency: true,
                animations: true,
                backgroundOpacity: 80,
                showMenuBar: true,
                autohideMenuBar: false,
                menuBarOpacity: 80,
                menuBarBlur: 40,
                dockAutohide: false,
                dockPosition: "bottom",
                dockSize: 56,
                dockMagnification: true,
                dockTooltips: true,
                windowSnapping: true,
                windowShadows: true,
                jellyMode: false,
                launchFullscreen: false,
                customWallpaper: null,
                startupWindows: "welcome",
              };
              loadSettingsUI();
              saveSettings();
            },
            { title: "Reset All Settings?", icon: '<i class="fas fa-undo-alt" style="color:#ff453a"></i>', confirmText: "Reset", danger: true }
            );
          });
        }

        // Wallpaper upload listener
        const wallpaperUpload =
          settingsContent.querySelector("#wallpaperUpload");
        if (wallpaperUpload) {
          wallpaperUpload.addEventListener("change", function (event) {
            event.preventDefault();
            event.stopPropagation();
            handleWallpaperUpload(event);
          });
        }

        // Setup update handlers - THIS IS THE KEY FIX
        setupUpdateHandlers(settingsContent);

        // Check for updates immediately if System section is visible
        const systemSection = settingsContent.querySelector("#general-section");
        if (systemSection && systemSection.classList.contains("active")) {
          setTimeout(() => {
            checkForSystemUpdates();
          }, 500);
        }
      }

      // Helper function to enter fullscreen with browser compatibility
      function enterFullscreen() {
        const elem = document.documentElement;

        if (elem.requestFullscreen) {
          elem.requestFullscreen().catch((err) => {
            console.log("Fullscreen request failed:", err);
          });
        } else if (elem.webkitRequestFullscreen) {
          // Safari
          elem.webkitRequestFullscreen().catch((err) => {
            console.log("Webkit fullscreen request failed:", err);
          });
        } else if (elem.msRequestFullscreen) {
          // IE11
          elem.msRequestFullscreen().catch((err) => {
            console.log("MS fullscreen request failed:", err);
          });
        } else if (elem.mozRequestFullScreen) {
          // Firefox
          elem.mozRequestFullScreen().catch((err) => {
            console.log("Moz fullscreen request failed:", err);
          });
        } else {
          console.log("Fullscreen API not supported by this browser");
        }
      }

      // Startup Sequence
      function playStartupSequence() {
        const startupScreen = document.getElementById("startupScreen");
        const welcomeOverlay = document.getElementById("welcomeOverlay");
        const progressBar = document.getElementById("startupProgress");
        const statusText = document.getElementById("startupStatus");

        // Show startup screen
        if (startupScreen) startupScreen.style.display = "flex";
        if (welcomeOverlay) welcomeOverlay.style.display = "none";

        // Create audio elements for startup sounds
        // Replace these URLs with your actual audio file URLs, or leave as-is to use generated sounds
        const STARTUP_SOUND_URL =
          "https://codehs.com/uploads/a65c34b976260e021c991377c09738d7";
        const COMPLETION_SOUND_URL =
          "https://codehs.com/uploads/08141181768ff6fbd3e7d9afe655e00b";

        const useGeneratedSounds =
          STARTUP_SOUND_URL.includes("your-audio-url.com");

        // Web Audio API for generated sounds (fallback)
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();

        function playGeneratedStartupSound() {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
          oscillator.frequency.exponentialRampToValueAtTime(
            880,
            audioContext.currentTime + 0.5
          ); // A5

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 1.2
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 1.2);
        }

        function playGeneratedCompletionSound() {
          // Create a pleasant three-note chime
          const times = [0, 0.15, 0.3];
          const frequencies = [523.25, 659.25, 783.99]; // C5, E5, G5

          times.forEach((time, i) => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(
              frequencies[i],
              audioContext.currentTime + time
            );

            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + time);
            gainNode.gain.exponentialRampToValueAtTime(
              0.01,
              audioContext.currentTime + time + 0.4
            );

            oscillator.start(audioContext.currentTime + time);
            oscillator.stop(audioContext.currentTime + time + 0.4);
          });
        }

        // Play startup sound
        if (useGeneratedSounds) {
          // Use generated sound
          try {
            playGeneratedStartupSound();
          } catch (e) {
            console.log("Generated audio playback failed:", e);
          }
        } else {
          // Use MP3 files
          const startupAudio = new Audio(STARTUP_SOUND_URL);
          startupAudio.volume = 0.5;
          startupAudio.onerror = function () {
            console.log(
              "Failed to load startup audio from:",
              STARTUP_SOUND_URL
            );
            // Fallback to generated sound
            try {
              playGeneratedStartupSound();
            } catch (e) {
              console.log("Fallback audio also failed:", e);
            }
          };
          startupAudio.play().catch((e) => {
            console.log("Startup audio playback failed:", e);
          });
        }

        // Simulate loading sequence (minimum 5 seconds, max 30 seconds)
        const loadingSteps = [
          { progress: 10, text: "Initializing system...", delay: 500 },
          { progress: 20, text: "Loading core systems...", delay: 600 },
          { progress: 35, text: "Initializing graphics engine...", delay: 700 },
          { progress: 50, text: "Loading user interface...", delay: 800 },
          {
            progress: 65,
            text: "Configuring desktop environment...",
            delay: 700,
          },
          { progress: 80, text: "Loading applications...", delay: 600 },
          { progress: 95, text: "Finalizing startup...", delay: 500 },
          { progress: 100, text: "Ready!", delay: 600 },
        ];

        let currentStep = 0;

        function nextStep() {
          if (currentStep >= loadingSteps.length) {
            // Startup complete - play completion sound and show continue button
            setTimeout(() => {
              if (useGeneratedSounds) {
                // Use generated sound
                try {
                  playGeneratedCompletionSound();
                } catch (e) {
                  console.log("Generated completion audio failed:", e);
                }
              } else {
                // Use MP3 file
                const completionAudio = new Audio(COMPLETION_SOUND_URL);
                completionAudio.volume = 0.5;
                completionAudio.onerror = function () {
                  console.log(
                    "Failed to load completion audio from:",
                    COMPLETION_SOUND_URL
                  );
                  // Fallback to generated sound
                  try {
                    playGeneratedCompletionSound();
                  } catch (e) {
                    console.log("Fallback audio also failed:", e);
                  }
                };
                completionAudio.play().catch((e) => {
                  console.log("Completion audio playback failed:", e);
                });
              }

              // Show the continue button
              const continueBtn = document.getElementById("startupContinueBtn");
              if (continueBtn) {
                statusText.textContent = "System ready!";
                setTimeout(() => {
                  continueBtn.style.display = "flex";
                }, 300);
              }

              // Set up continue button click handler
              continueBtn.onclick = function () {
                // Enter fullscreen with user interaction
                enterFullscreen();

                // Fade out startup screen
                startupScreen.classList.add("fade-out");

                setTimeout(() => {
                  startupScreen.style.display = "none";

                  // Show and fade in the login page
                  if (welcomeOverlay) {
                    welcomeOverlay.style.display = "flex";

                    // Trigger fade-in after a brief delay
                    setTimeout(() => {
                      welcomeOverlay.classList.add("fade-in");
                    }, 50);
                  }
                }, 800);
              };
            }, 500);
            return;
          }

          const step = loadingSteps[currentStep];
          progressBar.style.width = step.progress + "%";
          statusText.textContent = step.text;

          currentStep++;
          setTimeout(nextStep, step.delay);
        }

        // Start loading sequence after a brief delay
        setTimeout(nextStep, 800);
      }

      // DOM Content Loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Load settings first
        loadSettings();

        // Start startup sequence
        playStartupSequence();

        setupXORBITMenu();
        setupUserMenu();
        setupWifiMenu();
        setupUtilitiesMenu();
        setupTimeMenu();
        getUserLocation();

        // Setup dock hover effects
        const dockItems = document.querySelectorAll(".dock-item");
        dockItems.forEach(function (item) {
          if (item) {
            item.addEventListener("mouseenter", function () {
              if (settings.dockMagnification) {
                this.style.transform = "translateY(-8px) scale(1.15)";
              }
            });

            item.addEventListener("mouseleave", function () {
              if (!this.classList.contains("active")) {
                this.style.transform = "translateY(0) scale(1)";
              }
            });
          }
        });
      });

      // Setup time menu functionality
      function setupTimeMenu() {
        const timeMenuButton = document.getElementById("timeMenu");
        const timeDropdown = document.getElementById("timeDropdown");

        if (timeMenuButton && timeDropdown) {
          timeMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = timeDropdown.classList.contains("show");

            // Hide all other menus first
            document
              .querySelectorAll(".xorbit-menu.show, .time-menu.show")
              .forEach((menu) => {
                menu.classList.remove("show");
              });

            if (!isVisible) {
              timeDropdown.classList.add("show");
              updateWeatherDisplay();
            }
          });

          // Close menu when clicking outside
          document.addEventListener("click", function () {
            timeDropdown.classList.remove("show");
            // Also close X-ORBIT menu if open
            const xorbitDropdown = document.getElementById("xorbitDropdown");
            if (xorbitDropdown) {
              xorbitDropdown.classList.remove("show");
            }
          });

          // Prevent menu from closing when clicking inside
          timeDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
      }

      // Get user location â€” uses default location, no browser prompt
      function getUserLocation() {
        getWeatherData();
      }

      // Simplified reverse geocoding (you would use a real service)
      function reverseGeocode(lat, lon) {
        // This is a simplified example. In production, use a real geocoding service
        const locations = [
          { lat: 42.8666, lon: -106.313, city: "Casper", state: "Wyoming" },
          { lat: 40.7128, lon: -74.006, city: "New York", state: "New York" },
          {
            lat: 34.0522,
            lon: -118.2437,
            city: "Los Angeles",
            state: "California",
          },
          { lat: 41.8781, lon: -87.6298, city: "Chicago", state: "Illinois" },
          { lat: 29.7604, lon: -95.3698, city: "Houston", state: "Texas" },
        ];

        // Find closest location (simplified)
        let closestLocation = locations[0];
        let minDistance = getDistance(
          lat,
          lon,
          closestLocation.lat,
          closestLocation.lon
        );

        locations.forEach((location) => {
          const distance = getDistance(lat, lon, location.lat, location.lon);
          if (distance < minDistance) {
            minDistance = distance;
            closestLocation = location;
          }
        });

        userLocation.city = closestLocation.city;
        userLocation.state = closestLocation.state;
      }

      // Calculate distance between two coordinates
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // Get weather data (simulated - you would use a real weather API)
      function getWeatherData() {
        // Simulate weather data based on location and time
        const hour = new Date().getHours();
        const season = getCurrentSeason();
        const weatherConditions = getWeatherForLocation(
          userLocation.city,
          season,
          hour
        );

        weatherData = {
          ...weatherData,
          ...weatherConditions,
        };

        updateWeatherDisplay();
      }

      // Get current season
      function getCurrentSeason() {
        const month = new Date().getMonth() + 1;
        if (month >= 3 && month <= 5) return "spring";
        if (month >= 6 && month <= 8) return "summer";
        if (month >= 9 && month <= 11) return "autumn";
        return "winter";
      }

      // Get weather based on location, season, and time
      function getWeatherForLocation(city, season, hour) {
        const weatherPatterns = {
          Casper: {
            winter: {
              temp: -2,
              desc: "Snow Showers",
              icon: "ðŸŒ¨ï¸",
              humidity: 78,
            },
            spring: {
              temp: 12,
              desc: "Partly Cloudy",
              icon: "â›…",
              humidity: 65,
            },
            summer: { temp: 26, desc: "Sunny", icon: "â˜€ï¸", humidity: 45 },
            autumn: { temp: 8, desc: "Cloudy", icon: "â˜ï¸", humidity: 70 },
          },
          "New York": {
            winter: { temp: 2, desc: "Overcast", icon: "â˜ï¸", humidity: 72 },
            spring: {
              temp: 18,
              desc: "Partly Cloudy",
              icon: "â›…",
              humidity: 68,
            },
            summer: { temp: 28, desc: "Sunny", icon: "â˜€ï¸", humidity: 65 },
            autumn: { temp: 15, desc: "Rainy", icon: "ðŸŒ§ï¸", humidity: 80 },
          },
          "Los Angeles": {
            winter: { temp: 18, desc: "Sunny", icon: "â˜€ï¸", humidity: 55 },
            spring: { temp: 22, desc: "Clear", icon: "â˜€ï¸", humidity: 60 },
            summer: { temp: 32, desc: "Hot", icon: "ðŸŒž", humidity: 50 },
            autumn: {
              temp: 25,
              desc: "Partly Cloudy",
              icon: "â›…",
              humidity: 58,
            },
          },
        };

        const baseWeather = weatherPatterns[city] || weatherPatterns["Casper"];
        const seasonWeather = baseWeather[season];

        // Add some randomization and time-based variations
        const tempVariation = Math.floor(Math.random() * 6) - 3; // Â±3 degrees
        const isNight = hour < 6 || hour > 20;

        return {
          temp: seasonWeather.temp + tempVariation + (isNight ? -3 : 0),
          description: seasonWeather.desc,
          icon:
            isNight && seasonWeather.icon === "â˜€ï¸" ? "ðŸŒ™" : seasonWeather.icon,
          humidity: seasonWeather.humidity + Math.floor(Math.random() * 10) - 5,
          wind: Math.floor(Math.random() * 20) + 5,
          pressure: 1013 + Math.floor(Math.random() * 40) - 20,
          uvIndex: isNight ? 0 : Math.floor(Math.random() * 8) + 1,
        };
      }

      // Update weather display
      function updateWeatherDisplay() {
        const elements = {
          weatherIcon: document.getElementById("weatherIcon"),
          weatherTemp: document.getElementById("weatherTemp"),
          weatherDesc: document.getElementById("weatherDesc"),
          weatherLocation: document.getElementById("weatherLocation"),
          humidity: document.getElementById("humidity"),
          wind: document.getElementById("wind"),
          pressure: document.getElementById("pressure"),
          uvIndex: document.getElementById("uvIndex"),
        };

        if (elements.weatherIcon)
          elements.weatherIcon.textContent = weatherData.icon;
        if (elements.weatherTemp)
          elements.weatherTemp.textContent = `${weatherData.temp}Â°C`;
        if (elements.weatherDesc)
          elements.weatherDesc.textContent = weatherData.description;
        if (elements.weatherLocation)
          elements.weatherLocation.textContent = `${userLocation.city}, ${userLocation.state}`;
        if (elements.humidity)
          elements.humidity.textContent = `${weatherData.humidity}%`;
        if (elements.wind)
          elements.wind.textContent = `${weatherData.wind} mph`;
        if (elements.pressure)
          elements.pressure.textContent = `${weatherData.pressure} mb`;
        if (elements.uvIndex)
          elements.uvIndex.textContent = weatherData.uvIndex;
      }

      function setupWifiMenu() {
        const wifiMenuButton = document.getElementById("wifiMenu");
        const wifiDropdown = document.getElementById("wifiDropdown");

        if (wifiMenuButton && wifiDropdown) {
          wifiMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = wifiDropdown.classList.contains("show");

            // Hide all other menus first
            document.querySelectorAll(".xorbit-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });
            document.querySelectorAll(".time-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });

            if (!isVisible) {
              wifiDropdown.classList.add("show");
              // Test network speed when menu opens
              testNetworkSpeed();
            }
          });

          // Prevent menu from closing when clicking inside
          wifiDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }

        // Update network type
        updateNetworkType();

        // Monitor online/offline status
        window.addEventListener("online", updateNetworkStatus);
        window.addEventListener("offline", updateNetworkStatus);
        updateNetworkStatus();
      }

      function updateNetworkType() {
        const networkType = document.getElementById("networkType");
        if (!networkType) return;

        const connection =
          navigator.connection ||
          navigator.mozConnection ||
          navigator.webkitConnection;
        if (connection && connection.effectiveType) {
          const typeMap = {
            "slow-2g": "2G (Slow)",
            "2g": "2G",
            "3g": "3G",
            "4g": "4G",
            "5g": "5G",
          };
          networkType.textContent =
            typeMap[connection.effectiveType] ||
            connection.effectiveType.toUpperCase();
        } else {
          networkType.textContent = "WiFi/Ethernet";
        }
      }

      function updateNetworkStatus() {
        const networkStatus = document.getElementById("networkStatus");
        const wifiIcon = document.getElementById("wifiIcon");

        if (!networkStatus || !wifiIcon) return;

        if (navigator.onLine) {
          networkStatus.innerHTML =
            '<i class="fas fa-check-circle"></i> Online';
          networkStatus.style.color = "#28ca42";
          wifiIcon.className = "fas fa-wifi";
          wifiIcon.style.color = "";
        } else {
          networkStatus.innerHTML =
            '<i class="fas fa-times-circle"></i> Offline';
          networkStatus.style.color = "#ff5757";
          wifiIcon.className = "fas fa-wifi-slash";
          wifiIcon.style.color = "#ff5757";
        }
      }

      async function testNetworkSpeed() {
        const pingLatency = document.getElementById("pingLatency");
        const jitterValue = document.getElementById("jitterValue");

        if (!pingLatency || !jitterValue) return;

        // Show loading state
        pingLatency.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Testing...';
        jitterValue.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Testing...';

        // Cloudflare's 1.1.1.1 DNS (use their speed test endpoint)
        const testUrl = "https://1.1.1.1/cdn-cgi/trace";
        const pingTests = 5;
        const results = [];

        try {
          for (let i = 0; i < pingTests; i++) {
            const startTime = performance.now();

            try {
              const response = await fetch(testUrl, {
                method: "GET",
                cache: "no-cache",
              });

              if (response.ok) {
                const endTime = performance.now();
                const latency = Math.round(endTime - startTime);
                results.push(latency);
              }
            } catch (err) {
              console.warn("Ping test failed:", err);
            }

            // Small delay between tests
            if (i < pingTests - 1) {
              await new Promise((resolve) => setTimeout(resolve, 100));
            }
          }

          if (results.length > 0) {
            // Calculate average ping
            const avgPing = Math.round(
              results.reduce((a, b) => a + b, 0) / results.length
            );

            // Calculate jitter (average deviation from mean)
            const jitter =
              results.length > 1
                ? Math.round(
                    results.reduce(
                      (sum, val) => sum + Math.abs(val - avgPing),
                      0
                    ) / results.length
                  )
                : 0;

            // Display results with color coding
            const pingColor =
              avgPing < 50 ? "#28ca42" : avgPing < 100 ? "#ffd700" : "#ff5757";
            const jitterColor =
              jitter < 10 ? "#28ca42" : jitter < 30 ? "#ffd700" : "#ff5757";

            pingLatency.innerHTML = `<span style="color: ${pingColor};">${avgPing} ms</span>`;
            jitterValue.innerHTML = `<span style="color: ${jitterColor};">${jitter} ms</span>`;
          } else {
            pingLatency.innerHTML =
              '<span style="color: #ff5757;">Failed</span>';
            jitterValue.innerHTML =
              '<span style="color: #ff5757;">Failed</span>';
          }
        } catch (error) {
          console.error("Network test error:", error);
          pingLatency.innerHTML = '<span style="color: #ff5757;">Error</span>';
          jitterValue.innerHTML = '<span style="color: #ff5757;">Error</span>';
        }
      }

      function setupUtilitiesMenu() {
        const utilitiesMenuButton = document.getElementById("utilitiesMenu");
        const utilitiesDropdown = document.getElementById("utilitiesDropdown");

        if (utilitiesMenuButton && utilitiesDropdown) {
          utilitiesMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = utilitiesDropdown.classList.contains("show");

            // Hide all other menus first
            document.querySelectorAll(".xorbit-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });
            document.querySelectorAll(".time-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });

            if (!isVisible) {
              utilitiesDropdown.classList.add("show");
              updateFullscreenText();
            }
          });

          // Prevent menu from closing when clicking inside
          utilitiesDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }

        // Listen for fullscreen changes
        document.addEventListener("fullscreenchange", updateFullscreenText);
        document.addEventListener(
          "webkitfullscreenchange",
          updateFullscreenText
        );
        document.addEventListener("mozfullscreenchange", updateFullscreenText);
        document.addEventListener("MSFullscreenChange", updateFullscreenText);
      }

      function toggleFullscreen() {
        if (
          !document.fullscreenElement &&
          !document.webkitFullscreenElement &&
          !document.mozFullScreenElement &&
          !document.msFullscreenElement
        ) {
          // Enter fullscreen
          enterFullscreen();
        } else {
          // Exit fullscreen
          exitFullscreen();
        }

        // Close menu
        const dropdown = document.getElementById("utilitiesDropdown");
        if (dropdown) dropdown.classList.remove("show");
      }

      function exitFullscreen() {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }

      function updateFullscreenText() {
        const fullscreenIcon = document.getElementById("fullscreenIcon");
        const fullscreenText = document.getElementById("fullscreenText");

        if (!fullscreenIcon || !fullscreenText) return;

        const isFullscreen =
          document.fullscreenElement ||
          document.webkitFullscreenElement ||
          document.mozFullScreenElement ||
          document.msFullscreenElement;

        if (isFullscreen) {
          fullscreenIcon.className = "fas fa-compress";
          fullscreenText.textContent = "Exit Fullscreen";
        } else {
          fullscreenIcon.className = "fas fa-expand";
          fullscreenText.textContent = "Enter Fullscreen";
        }
      }

      function refreshDesktop() {
        // Close menu
        const dropdown = document.getElementById("utilitiesDropdown");
        if (dropdown) dropdown.classList.remove("show");

        // Reload the page
        location.reload();
      }

      function openTaskManager() {
        // Close menu
        const dropdown = document.getElementById("utilitiesDropdown");
        if (dropdown) dropdown.classList.remove("show");

        // Build window list HTML
        let windowListHTML = '';
        if (activeWindows.size === 0) {
          windowListHTML = `
            <div style="text-align: center; padding: 24px; color: #a8b4d9;">
              <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 12px; display: block;"></i>
              No windows open
            </div>
          `;
        } else {
          activeWindows.forEach((windowId, title) => {
            windowListHTML += `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(120, 80, 255, 0.05); border-radius: 10px; margin-bottom: 8px; border: 1px solid rgba(120, 80, 255, 0.15);">
                <div style="flex: 1;">
                  <div style="color: #e8f0ff; font-weight: 500; margin-bottom: 4px;">
                    <i class="fas fa-window-restore" style="margin-right: 8px; color: #7d5cff;"></i>
                    ${title}
                  </div>
                  <div style="color: #a8b4d9; font-size: 0.75rem;">
                    ID: ${windowId}
                  </div>
                </div>
                <button 
                  onclick="killWindow('${windowId}', '${title}')" 
                  style="padding: 8px 16px; background: rgba(255, 87, 87, 0.2); border: 1px solid rgba(255, 87, 87, 0.4); border-radius: 8px; color: #ff5757; cursor: pointer; transition: all 0.2s ease; font-size: 0.85rem; font-weight: 500;"
                  onmouseover="this.style.background='rgba(255, 87, 87, 0.3)'; this.style.transform='scale(1.05)';"
                  onmouseout="this.style.background='rgba(255, 87, 87, 0.2)'; this.style.transform='scale(1)';"
                >
                  <i class="fas fa-times-circle"></i> Kill
                </button>
              </div>
            `;
          });
        }

        // Create task manager content
        const taskContent = `
    <div style="padding: 24px; max-height: 600px; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="color: #e8f0ff; font-size: 1.4rem; margin: 0;">
          <i class="fas fa-tasks" style="margin-right: 12px; color: #7d5cff;"></i>
          Task Manager
        </h2>
        <div style="color: #7d5cff; font-weight: 600; background: rgba(120, 80, 255, 0.2); padding: 6px 12px; border-radius: 8px;">
          ${activeWindows.size} window${activeWindows.size !== 1 ? 's' : ''}
        </div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <button 
          onclick="killAllWindows()" 
          ${activeWindows.size === 0 ? 'disabled' : ''}
          style="width: 100%; padding: 12px 20px; background: ${activeWindows.size === 0 ? 'rgba(120, 80, 255, 0.1)' : 'linear-gradient(135deg, rgba(255, 87, 87, 0.3), rgba(255, 107, 107, 0.3))'}; border: 2px solid ${activeWindows.size === 0 ? 'rgba(120, 80, 255, 0.2)' : 'rgba(255, 87, 87, 0.5)'}; border-radius: 12px; color: ${activeWindows.size === 0 ? '#64748b' : '#ff5757'}; font-size: 1rem; font-weight: 600; cursor: ${activeWindows.size === 0 ? 'not-allowed' : 'pointer'}; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;"
          ${activeWindows.size === 0 ? '' : 'onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 16px rgba(255, 87, 87, 0.4)\';" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\';"'}
        >
          <i class="fas fa-trash-alt"></i>
          Kill All Windows
        </button>
      </div>

      <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
        <div style="color: #7d5cff; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between;">
          <span>Active Windows</span>
          <span style="font-size: 0.85rem; background: rgba(120, 80, 255, 0.2); padding: 4px 8px; border-radius: 6px;">${activeWindows.size} running</span>
        </div>
        <div id="taskManagerWindowList">
          ${windowListHTML}
        </div>
      </div>
      
      <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2); margin-top: 16px;">
        <div style="color: #7d5cff; font-weight: 600; margin-bottom: 12px;">System Information</div>
        <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
          <i class="fas fa-globe" style="margin-right: 8px; color: #7d5cff;"></i>
          Browser: ${navigator.userAgent.split(" ").pop()}
        </div>
        <div style="color: #a8b4d9; font-size: 0.85rem;">
          <i class="fas fa-desktop" style="margin-right: 8px; color: #7d5cff;"></i>
          Platform: ${navigator.platform}
        </div>
        <div style="color: #a8b4d9; font-size: 0.85rem; margin-top: 4px;">
          <i class="fas fa-user" style="margin-right: 8px; color: #7d5cff;"></i>
          User: ${currentUser.username || 'Guest'}
        </div>
      </div>
    </div>
  `;

        openCustomWindow("Task Manager", taskContent, "fas fa-tasks", 600, 650);
      }

      // Kill a specific window
      function killWindow(windowId, title) {
        const windowEl = document.getElementById(windowId);
        if (windowEl) {
          if (settings.animations) {
            windowEl.classList.remove("window-visible");
            setTimeout(() => {
              windowEl.remove();
              activeWindows.delete(title);
              // Refresh task manager if it's open
              refreshTaskManager();
            }, 400);
          } else {
            windowEl.remove();
            activeWindows.delete(title);
            refreshTaskManager();
          }
        }
      }

      // Kill all windows
      function killAllWindows() {
        if (activeWindows.size === 0) return;
        
        const _winCount = activeWindows.size;
        xModal.confirm(
          `This will close all ${_winCount} open window${_winCount !== 1 ? 's' : ''}. Any unsaved work will be lost.`,
          () => {
          activeWindows.forEach((windowId, title) => {
            const windowEl = document.getElementById(windowId);
            if (windowEl) {
              // Skip the Task Manager window itself
              if (title === "Task Manager") return;
              windowEl.remove();
              activeWindows.delete(title);
            }
          });
          refreshTaskManager();
        },
        { title: "Close All Windows?", icon: '<i class="fas fa-window-restore" style="color:#9070ff"></i>', confirmText: "Close All", danger: true }
        );
      }

      // Refresh the task manager window content
      function refreshTaskManager() {
        const taskManagerId = activeWindows.get("Task Manager");
        if (taskManagerId) {
          const taskManagerWindow = document.getElementById(taskManagerId);
          if (taskManagerWindow) {
            // Close and reopen task manager to refresh
            taskManagerWindow.remove();
            activeWindows.delete("Task Manager");
            setTimeout(() => openTaskManager(), 100);
          }
        }
      }

      // Update location function
      function updateLocation() {
        const locationUpdate = document.querySelector(".location-update");
        if (locationUpdate) {
          locationUpdate.innerHTML = "ðŸ”„ Updating...";
          locationUpdate.style.pointerEvents = "none";
        }

        setTimeout(() => {
          getUserLocation();
          if (locationUpdate) {
            locationUpdate.innerHTML = "ðŸ“ Update location";
            locationUpdate.style.pointerEvents = "auto";
          }
        }, 1500);
      }

      // Setup X-ORBIT menu functionality
      function setupXORBITMenu() {
        const xorbitMenuButton = document.getElementById("xorbitMenu");
        const xorbitDropdown = document.getElementById("xorbitDropdown");

        if (xorbitMenuButton && xorbitDropdown) {
          xorbitMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = xorbitDropdown.classList.contains("show");

            // Hide all other menus first
            document.querySelectorAll(".xorbit-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });

            if (!isVisible) {
              xorbitDropdown.classList.add("show");
            }
          });

          // Close menu when clicking outside
          document.addEventListener("click", function () {
            xorbitDropdown.classList.remove("show");
            // Also close time menu if open
            const timeDropdown = document.getElementById("timeDropdown");
            if (timeDropdown) {
              timeDropdown.classList.remove("show");
            }
          });

          // Prevent menu from closing when clicking inside
          xorbitDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }
      }

      function setupUserMenu() {
        const userMenuButton = document.getElementById("userNameplate");
        const userDropdown = document.getElementById("userDropdown");

        if (userMenuButton && userDropdown) {
          userMenuButton.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = userDropdown.classList.contains("show");

            // Hide all other menus first
            document.querySelectorAll(".xorbit-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });
            document.querySelectorAll(".time-menu.show").forEach((menu) => {
              menu.classList.remove("show");
            });

            if (!isVisible) {
              userDropdown.classList.add("show");
            }
          });

          // Prevent menu from closing when clicking inside
          userDropdown.addEventListener("click", function (e) {
            e.stopPropagation();
          });
        }

        // Update user display name
        updateUserDisplay();
      }

      function updateUserDisplay() {
        const userNameDisplay = document.getElementById("userNameDisplay");
        if (!userNameDisplay) return;

        const authData =
          sessionStorage.getItem("xorbit_auth_session") ||
          localStorage.getItem("xorbit_auth_session");

        if (authData) {
          try {
            const authSession = JSON.parse(authData);
            const username = authSession.username || authSession.name || "User";
            userNameDisplay.textContent = username;
          } catch (e) {
            console.warn("Could not parse auth data");
            userNameDisplay.textContent = "User";
          }
        } else {
          userNameDisplay.textContent = "Guest";
        }
      }

      // X-ORBIT Menu Functions
      // Global variable to store session start time
      let sessionStartTime = new Date();

      function showAccountInfo() {
        const authData =
          sessionStorage.getItem("xorbit_auth_session") ||
          localStorage.getItem("xorbit_auth_session");

        let username = "Guest";
        let email = "Not logged in";

        if (authData) {
          try {
            const authSession = JSON.parse(authData);
            username = authSession.username || authSession.name || "User";
            email = authSession.email || "No email on file";
          } catch (e) {
            console.warn("Could not parse auth data");
          }
        }

        // Format last login time
        const lastLogin = sessionStartTime.toLocaleString("en-US", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        // Calculate session duration
        const now = new Date();
        const sessionDuration = Math.floor((now - sessionStartTime) / 1000); // in seconds
        const hours = Math.floor(sessionDuration / 3600);
        const minutes = Math.floor((sessionDuration % 3600) / 60);
        const seconds = sessionDuration % 60;
        const sessionTime = `${hours}h ${minutes}m ${seconds}s`;

        const accountContent = `
    <div style="padding: 24px;">
      <h2 style="color: #e8f0ff; margin-bottom: 24px; font-size: 1.4rem;">
        <i class="fas fa-user-circle" style="margin-right: 12px; color: #7d5cff;"></i>
        Account Information
      </h2>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">User Profile</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-user" style="margin-right: 8px; color: #7d5cff;"></i>
            Username: <strong>${username}</strong>
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-envelope" style="margin-right: 8px; color: #7d5cff;"></i>
            Email: ${email}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Session Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-clock" style="margin-right: 8px; color: #7d5cff;"></i>
            Last Login: ${lastLogin}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-hourglass-half" style="margin-right: 8px; color: #7d5cff;"></i>
            Session Duration: ${sessionTime}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Location Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #7d5cff;"></i>
            Location: ${userLocation.city}, ${userLocation.state}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-globe" style="margin-right: 8px; color: #7d5cff;"></i>
            Timezone: ${userLocation.timezone}
          </div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">System Status</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">
            <i class="fas fa-check-circle" style="margin-right: 8px; color: #28ca42;"></i>
            Status: ${isAuthenticated ? "Authenticated" : "Guest Mode"}
          </div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">
            <i class="fas fa-window-restore" style="margin-right: 8px; color: #7d5cff;"></i>
            Active Windows: ${activeWindows.size}
          </div>
        </div>
      </div>

      <button onclick="openWindow('Manage Account', 'account.html', 'fas fa-user-gear')" style="margin-top: 20px; width: 100%; padding: 12px; border-radius: 10px; border: 1px solid rgba(120, 80, 255, 0.4); background: rgba(120, 80, 255, 0.15); color: #c084fc; font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit; letter-spacing: 0.5px; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(120,80,255,0.28)'; this.style.borderColor='rgba(120,80,255,0.7)'" onmouseout="this.style.background='rgba(120,80,255,0.15)'; this.style.borderColor='rgba(120,80,255,0.4)'">
        <i class="fas fa-user-gear" style="margin-right: 8px;"></i>Manage Account
      </button>
    </div>
  `;

        openCustomWindow(
          "Account Information",
          accountContent,
          "fas fa-user-circle",
          600,
          500
        );

        // Close both possible dropdowns
        const xorbitDropdown = document.getElementById("xorbitDropdown");
        if (xorbitDropdown) xorbitDropdown.classList.remove("show");

        const userDropdown = document.getElementById("userDropdown");
        if (userDropdown) userDropdown.classList.remove("show");
      }

      function showAboutDialog() {
        openWindow(
          "Build Information",
          "build-info.html",
          "fas fa-info-circle"
        );
        document.getElementById("xorbitDropdown").classList.remove("show");
      }

      function showSystemInfo() {
        const systemContent = `
    <div style="padding: 24px;">
      <h2 style="color: #e8f0ff; margin-bottom: 24px; font-size: 1.4rem;">
        <i class="fas fa-desktop" style="margin-right: 12px; color: #7d5cff;"></i>
        System Information
      </h2>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Browser Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">User Agent: ${
            navigator.userAgent
          }</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Platform: ${
            navigator.platform
          }</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Display Information</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Resolution: ${
            window.screen.width
          } Ã— ${window.screen.height}</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Available: ${
            window.screen.availWidth
          } Ã— ${window.screen.availHeight}</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">X-ORBIT Status</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Authentication: ${
            isAuthenticated ? "âœ… Active" : "âŒ Inactive"
          }</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Active Windows: ${
            activeWindows.size
          }</div>
        </div>
        
        <div style="background: rgba(120, 80, 255, 0.1); padding: 16px; border-radius: 12px; border: 1px solid rgba(120, 80, 255, 0.2);">
          <div style="color: #7d5cff; font-weight: 600; margin-bottom: 8px;">Current Settings</div>
          <div style="color: #e8f0ff; font-size: 0.9rem; margin-bottom: 4px;">Theme: ${
            settings.theme
          }</div>
          <div style="color: #a8b4d9; font-size: 0.85rem;">Dock Position: ${
            settings.dockPosition
          }</div>
        </div>
      </div>
    </div>
  `;

        openCustomWindow(
          "System Information",
          systemContent,
          "fas fa-desktop",
          600,
          500
        );
        document.getElementById("xorbitDropdown").classList.remove("show");
      }

      function checkForUpdates() {
        const updateContent = `
    <div style="padding: 32px 28px 28px; display:flex; flex-direction:column; align-items:center; font-family: system-ui, -apple-system, sans-serif;">
      <div style="width:52px;height:52px;border-radius:50%;background:rgba(120,80,255,0.12);border:1px solid rgba(120,80,255,0.22);display:flex;align-items:center;justify-content:center;margin-bottom:16px;">
        <i class="fas fa-arrow-down" style="font-size:1.25rem;color:#8b6fff;"></i>
      </div>
      <div style="font-size:0.95rem;font-weight:600;color:#e8e0ff;margin-bottom:4px;letter-spacing:-0.01em;">Software Update</div>
      <div style="font-size:0.78rem;color:rgba(160,148,210,0.75);margin-bottom:24px;">X-ORBIT Desktop</div>

      <div id="updateStatus" style="width:100%;">
        <div style="font-size:0.78rem;color:rgba(160,148,210,0.8);text-align:center;margin-bottom:14px;">
          <i class="fas fa-spinner fa-spin" style="margin-right:6px;"></i>Checking for updatesâ€¦
        </div>
        <div style="width:100%;height:6px;background:rgba(255,255,255,0.08);border-radius:99px;overflow:hidden;">
          <div id="updateProgress" style="width:0%;height:100%;background:linear-gradient(90deg,#7d5cff,#5b8fff);border-radius:99px;transition:width 2s cubic-bezier(0.4,0,0.2,1);"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:7px;">
          <span style="font-size:0.7rem;color:rgba(140,128,190,0.6);">Connecting to serverâ€¦</span>
          <span style="font-size:0.7rem;color:rgba(140,128,190,0.6);" id="updateProgressPct">0%</span>
        </div>
      </div>
    </div>
  `;

        const windowEl = openCustomWindow(
          "Software Update",
          updateContent,
          "fas fa-download",
          450,
          300
        );

        // Simulate update check
        setTimeout(() => {
          const progressBar = windowEl.querySelector("#updateProgress");
          const statusDiv = windowEl.querySelector("#updateStatus");
          const pctLabel = windowEl.querySelector("#updateProgressPct");

          if (progressBar) progressBar.style.width = "100%";
          if (pctLabel) {
            let p = 0;
            const tick = setInterval(() => { p = Math.min(p + 5, 100); pctLabel.textContent = p + "%"; if (p >= 100) clearInterval(tick); }, 100);
          }

          setTimeout(() => {
            if (statusDiv) {
              statusDiv.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;gap:10px;padding-top:4px;">
            <div style="width:40px;height:40px;border-radius:50%;background:rgba(52,199,89,0.12);border:1px solid rgba(52,199,89,0.25);display:flex;align-items:center;justify-content:center;">
              <i class="fas fa-check" style="color:#34c759;font-size:1rem;"></i>
            </div>
            <div style="font-size:0.9rem;font-weight:600;color:#34c759;letter-spacing:-0.01em;">You're up to date</div>
            <div style="font-size:0.76rem;color:rgba(160,148,210,0.7);">X-ORBIT Desktop v5.2.3B Ventas is the latest version.</div>
          </div>
        `;
            }
          }, 2000);
        }, 1000);

        document.getElementById("xorbitDropdown").classList.remove("show");
      }

      function restartDesktop() {
        document.getElementById("xorbitDropdown").classList.remove("show");
        xModal.confirm(
          "All open windows will be closed and the desktop will reload.",
          () => {
            activeWindows.forEach((windowId) => {
              const windowEl = document.getElementById(windowId);
              if (windowEl) windowEl.remove();
            });
            activeWindows.clear();
            const restartDiv = document.createElement("div");
            restartDiv.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(10,5,25,0.9);backdrop-filter:blur(60px);display:flex;align-items:center;justify-content:center;z-index:10000;color:#e8f0ff;flex-direction:column;gap:20px;">
          <i class="fas fa-sync fa-spin" style="font-size:3rem;color:#7d5cff;"></i>
          <div style="font-size:1.2rem;font-weight:500;">Restarting Desktop...</div>
        </div>`;
            document.body.appendChild(restartDiv);
            setTimeout(() => { restartDiv.remove(); initDesktop(); }, 2000);
          },
          { title: "Restart Desktop?", icon: '<i class="fas fa-sync-alt" style="color:#9070ff"></i>', confirmText: "Restart" }
        );
      }

      function logout() {
        document.getElementById("xorbitDropdown").classList.remove("show");

        function doLogout() {
          stopBanChecking();
          stopAutomaticUpdateChecking();
          activeWindows.forEach((windowId) => {
            const windowEl = document.getElementById(windowId);
            if (windowEl) windowEl.remove();
          });
          activeWindows.clear();
          isAuthenticated = false;
          const logoutDiv = document.createElement("div");
          logoutDiv.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(10,5,25,0.9);backdrop-filter:blur(60px);display:flex;align-items:center;justify-content:center;z-index:10000;color:#e8f0ff;flex-direction:column;gap:20px;">
          <i class="fas fa-sign-out-alt" style="font-size:3rem;color:#ff6b6b;"></i>
          <div style="font-size:1.2rem;font-weight:500;">Logging out...</div>
        </div>`;
          document.body.appendChild(logoutDiv);
          setTimeout(() => {
            logoutDiv.remove();
            const welcomeOverlay = document.getElementById("welcomeOverlay");
            if (welcomeOverlay) welcomeOverlay.style.display = "flex";
          }, 1500);
        }

        if (pendingUpdateOnClose && latestUpdateData) {
          xModal.confirm(
            "An update is ready to install. Would you like to install it before logging out?",
            () => performUpdate(),
            { title: "Update Available", icon: '<i class="fas fa-arrow-circle-up" style="color:#9070ff"></i>', confirmText: "Install Update" }
          );
          return;
        }

        xModal.confirm(
          "All unsaved work will be lost.",
          () => doLogout(),
          { title: "Log Out?", icon: '<i class="fas fa-sign-out-alt" style="color:#ff453a"></i>', confirmText: "Log Out", danger: true }
        );
      }

      // Helper function to create custom content windows
      function openCustomWindow(
        title,
        content,
        icon,
        width = 600,
        height = 450
      ) {
        if (!isAuthenticated) return null;

        if (activeWindows.has(title)) {
          focusWindow(activeWindows.get(title));
          return document.getElementById(activeWindows.get(title));
        }

        windowCounter++;
        const windowId = "win" + windowCounter;

        const windowEl = document.createElement("div");
        windowEl.className = "window";
        if (settings.animations) {
          windowEl.classList.add("window-opening");
        }
        windowEl.id = windowId;

        // Calculate safe position to prevent overflow - SIMPLIFIED
        // Get viewport size
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        // Safe margins
        const leftMargin = 50;
        const rightMargin = 50;
        const topMargin = 80;
        const bottomMargin = 120;

        // Calculate actual available space
        const availableWidth = vw - leftMargin - rightMargin;
        const availableHeight = vh - topMargin - bottomMargin;

        // Reduce window size if it won't fit
        const actualWidth = Math.min(width, availableWidth);
        const actualHeight = Math.min(height, availableHeight);

        // Calculate safe position range
        const minX = leftMargin;
        const maxX = vw - actualWidth - rightMargin;
        const minY = topMargin;
        const maxY = vh - actualHeight - bottomMargin;

        // Generate position (centered with slight randomness)
        const centerX = (vw - actualWidth) / 2;
        const centerY = (vh - actualHeight) / 2;
        const randomOffsetX = (Math.random() - 0.5) * 100;
        const randomOffsetY = (Math.random() - 0.5) * 100;

        let x = centerX + randomOffsetX;
        let y = centerY + randomOffsetY;

        // Clamp to bounds
        x = Math.max(minX, Math.min(x, maxX));
        y = Math.max(minY, Math.min(y, maxY));

        windowEl.style.left = Math.floor(x) + "px";
        windowEl.style.top = Math.floor(y) + "px";
        windowEl.style.width = Math.floor(actualWidth) + "px";
        windowEl.style.height = Math.floor(actualHeight) + "px";

        windowEl.innerHTML =
          '<div class="window-titlebar">' +
          '<div class="window-controls">' +
          '<div class="window-control close"></div>' +
          '<div class="window-control minimize"></div>' +
          '<div class="window-control maximize"></div>' +
          "</div>" +
          '<div class="window-title">' +
          '<i class="' +
          icon +
          '" style="margin-right: 8px;"></i>' +
          title +
          "</div>" +
          "</div>" +
          '<div class="window-content" style="padding: 0; background: rgba(10, 10, 25, 0.3); border-radius: 0 0 16px 16px; overflow: auto;">' +
          content +
          "</div>";

        const desktop = document.getElementById("desktop");
        if (desktop) {
          desktop.appendChild(windowEl);
        }
        activeWindows.set(title, windowId);
        focusWindow(windowId);

        setupWindowEvents(windowEl, windowId, title);

        // Add resize observer to prevent overflow
        constrainWindowSize(windowEl);

        // Force immediate position check
        setTimeout(() => {
          forceWindowInBounds(windowEl);
          // Trigger smooth animation like weather UI
          windowEl.classList.add("window-visible");
        }, 0);

        return windowEl;
      }

      function forceWindowInBounds(windowEl) {
        const rect = windowEl.getBoundingClientRect();
        const menuBarHeight = 32;
        const margin = 10;

        let needsUpdate = false;
        let newLeft = parseFloat(windowEl.style.left);
        let newTop = parseFloat(windowEl.style.top);
        let newWidth = parseFloat(windowEl.style.width);
        let newHeight = parseFloat(windowEl.style.height);

        // Check right overflow
        if (rect.right > window.innerWidth - margin) {
          newLeft = window.innerWidth - rect.width - margin;
          needsUpdate = true;
        }

        // Check bottom overflow
        if (rect.bottom > window.innerHeight - margin) {
          newTop = window.innerHeight - rect.height - margin;
          needsUpdate = true;
        }

        // Check left overflow
        if (rect.left < margin) {
          newLeft = margin;
          needsUpdate = true;
        }

        // Check top overflow
        if (rect.top < menuBarHeight + margin) {
          newTop = menuBarHeight + margin;
          needsUpdate = true;
        }

        // Check if window is too wide
        if (rect.width > window.innerWidth - 2 * margin) {
          newWidth = window.innerWidth - 2 * margin;
          newLeft = margin;
          needsUpdate = true;
        }

        // Check if window is too tall
        if (rect.height > window.innerHeight - menuBarHeight - 2 * margin) {
          newHeight = window.innerHeight - menuBarHeight - 2 * margin;
          newTop = menuBarHeight + margin;
          needsUpdate = true;
        }

        if (needsUpdate) {
          windowEl.style.left = Math.round(newLeft) + "px";
          windowEl.style.top = Math.round(newTop) + "px";
          windowEl.style.width = Math.round(newWidth) + "px";
          windowEl.style.height = Math.round(newHeight) + "px";
        }
      }

      function constrainWindowSize(windowEl) {
        const resizeObserver = new ResizeObserver((entries) => {
          for (let entry of entries) {
            const rect = entry.target.getBoundingClientRect();
            const menuBarHeight = 32;
            const dockHeight = 70;
            const margin = 20;

            let needsAdjustment = false;
            let newWidth = rect.width;
            let newHeight = rect.height;
            let newLeft = parseFloat(windowEl.style.left) || rect.left;
            let newTop = parseFloat(windowEl.style.top) || rect.top;

            // Check if window extends beyond right edge
            if (rect.right > window.innerWidth - margin) {
              newWidth = window.innerWidth - newLeft - margin;
              needsAdjustment = true;
            }

            // Check if window extends beyond bottom edge
            if (rect.bottom > window.innerHeight - dockHeight - margin) {
              newHeight = window.innerHeight - dockHeight - newTop - margin;
              needsAdjustment = true;
            }

            // Check if window position needs adjustment
            if (newLeft < margin) {
              newLeft = margin;
              needsAdjustment = true;
            }

            if (newTop < menuBarHeight + margin) {
              newTop = menuBarHeight + margin;
              needsAdjustment = true;
            }

            // Apply constraints
            if (needsAdjustment) {
              if (newWidth !== rect.width) {
                windowEl.style.width = Math.max(400, newWidth) + "px";
              }
              if (newHeight !== rect.height) {
                windowEl.style.height = Math.max(300, newHeight) + "px";
              }
              if (newLeft !== rect.left) {
                windowEl.style.left = newLeft + "px";
              }
              if (newTop !== rect.top) {
                windowEl.style.top = newTop + "px";
              }
            }
          }
        });

        resizeObserver.observe(windowEl);
      }

      // Terminal communication handler
      // Terminal communication handler
      window.addEventListener("message", function (event) {
        if (event.data.type === "terminal-request") {
          switch (event.data.command) {
            case "theme":
              settings.theme = event.data.value;
              applySettings();
              break;
            case "dock":
              switch (event.data.setting) {
                case "position":
                  settings.dockPosition = event.data.value;
                  break;
                case "size":
                  settings.dockSize = parseInt(event.data.value);
                  break;
                case "autohide":
                  settings.dockAutohide = event.data.value === "on";
                  break;
              }
              applySettings();
              break;
            case "close-windows":
              // Close all open windows
              activeWindows.forEach((windowId) => {
                const windowEl = document.getElementById(windowId);
                if (windowEl) windowEl.remove();
              });
              activeWindows.clear();
              break;
            case "restart":
              restartDesktop();
              break;
            case "logout":
              logout();
              break;
            case "refresh":
              // Refresh the current webpage
              location.reload();
              break;
            case "browser-refresh":
              // Attempt to refresh the browser window
              if (window.parent) {
                window.parent.location.reload();
              }
              break;
          }
        }
      });
      // Supabase initialization for ban checking
      let supabaseClient = null;

      // Initialize Supabase client
      function initSupabaseClient() {
        try {
          if (window.supabase && window.supabase.createClient) {
            const { createClient } = window.supabase;
            const supabaseUrl = "https://rujvmtvozorylfzsqppc.supabase.co";
            const supabaseKey =
              "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1anZtdHZvem9yeWxmenNxcHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQxNDEsImV4cCI6MjA3MzA0MDE0MX0.b7jJz3Se_oXXDwwd0dWQ8-rEvhY0aU4JDHQVioE39iY";
            supabaseClient = createClient(supabaseUrl, supabaseKey);
            console.log("Supabase client initialized");
            return true;
          } else {
            console.error("Supabase library not loaded");
            return false;
          }
        } catch (e) {
          console.error("Error initializing Supabase:", e);
          return false;
        }
      }

      // Ban checking variables
      let banCheckInterval = null;

      // Check if account is banned or doesn't exist
      async function checkAccountBanStatus() {
        try {
          console.log("=== BAN CHECK START ===");

          // Initialize Supabase if not already done
          if (!supabaseClient) {
            console.log("Supabase client not initialized, initializing now...");
            const initialized = initSupabaseClient();
            if (!initialized) {
              console.error(
                "Cannot check ban status: Supabase not initialized"
              );
              return false;
            }
          }

          const authData =
            sessionStorage.getItem("xorbit_auth_session") ||
            localStorage.getItem("xorbit_auth_session");

          console.log("Auth data found:", !!authData);

          if (!authData) {
            console.log("No auth data found for ban check");
            return false;
          }

          const authSession = JSON.parse(authData);
          const email = authSession.email; // Using email instead of username

          console.log("Checking email:", email);

          if (!email) {
            console.log("No email in session for ban check");
            return false;
          }

          console.log("Querying Supabase for email:", email);

          // Query Supabase to check if account exists and is banned
          const { data, error } = await supabaseClient
            .from("clients")
            .select("blocked, ban_reason, name")
            .eq("email", email)
            .single();

          console.log("Supabase response - Data:", data);
          console.log("Supabase response - Error:", error);

          // Handle errors - account doesn't exist or other database issues
          if (error) {
            console.error("Error checking ban status:", error);
            console.log("Error code:", error.code);
            console.log("Error message:", error.message);

            // If the error is because no rows were found, the account doesn't exist
            if (
              error.code === "PGRST116" ||
              error.message.includes("No rows found") ||
              error.message.includes("multiple")
            ) {
              console.log("Account does not exist in database - logging out");

              // Stop the interval check
              if (banCheckInterval) {
                clearInterval(banCheckInterval);
              }

              // Store a generic message for account not found
              sessionStorage.setItem(
                "ban_reason",
                "Your account could not be found in our system. Please contact support if you believe this is an error."
              );
              sessionStorage.setItem("banned_username", email);

              // Redirect to blocked page
              console.log("Redirecting to blocked.html (account not found)");
              window.location.href = "blocked.html";
              return true;
            }

            // For other errors, return false and continue checking
            return false;
          }

          // If no data returned, account doesn't exist
          if (!data) {
            console.log(
              "No data returned - account does not exist in database - logging out"
            );

            // Stop the interval check
            if (banCheckInterval) {
              clearInterval(banCheckInterval);
            }

            // Store a generic message for account not found
            sessionStorage.setItem(
              "ban_reason",
              "Your account could not be found in our system. Please contact support if you believe this is an error."
            );
            sessionStorage.setItem("banned_username", email);

            // Redirect to blocked page
            console.log("Redirecting to blocked.html (no data)");
            window.location.href = "blocked.html";
            return true;
          }

          console.log("Data.blocked value:", data.blocked);
          console.log("Data.blocked type:", typeof data.blocked);
          console.log(
            'Checking if blocked === "true":',
            data.blocked === "true"
          );
          console.log("Checking if blocked === true:", data.blocked === true);

          // Check if blocked is 'true' (string comparison) OR boolean true
          if (data.blocked === "true" || data.blocked === true) {
            console.log(
              "ðŸš« ACCOUNT IS BANNED! Ban reason:",
              data.ban_reason || "No reason provided"
            );

            // Stop the interval check
            if (banCheckInterval) {
              clearInterval(banCheckInterval);
            }

            // Store ban reason and name in session storage
            if (data.ban_reason) {
              sessionStorage.setItem("ban_reason", data.ban_reason);
              console.log("Stored ban reason in session");
            }
            if (data.name) {
              sessionStorage.setItem("banned_username", data.name);
              console.log("Stored username in session:", data.name);
            }

            // Redirect to blocked page
            console.log("ðŸ”´ Redirecting to blocked.html (account banned)");
            window.location.href = "blocked.html";
            return true;
          }

          console.log("âœ… Account status: Active (not banned)");
          console.log("=== BAN CHECK END ===");
          return false;
        } catch (e) {
          console.error("ðŸ’¥ Error in checkAccountBanStatus:", e);
          console.error("Error stack:", e.stack);
          return false;
        }
      }

      // Start periodic ban checking
      function startBanChecking() {
        // Clear any existing interval
        if (banCheckInterval) {
          clearInterval(banCheckInterval);
        }

        // Check immediately
        checkAccountBanStatus();

        // Then check every 15 seconds
        banCheckInterval = setInterval(() => {
          checkAccountBanStatus();
        }, 15000); // 15 seconds

        console.log("Ban checking started (every 15 seconds)");
      }

      // Stop ban checking (useful when logging out)
      function stopBanChecking() {
        if (banCheckInterval) {
          clearInterval(banCheckInterval);
          banCheckInterval = null;
          console.log("Ban checking stopped");
        }
      }
      // ============================================
      // X-ORBIT UPDATE SYSTEM - JAVASCRIPT CODE
      // Add this to your existing <script> section
      // ============================================

      // Add these global variables at the top with your other global variables:
      const CURRENT_VERSION = "v5.2.3B";
      const CURRENT_VERSION_NAME = "X-ORBIT Desktop v5.2.3B Ventas";
      let pendingUpdateOnClose = false;
      let latestUpdateData = null;

      // Update checker function
      async function checkForSystemUpdates() {
        try {
          console.log("Checking for system updates...");

          // Initialize Supabase if not already done
          if (!supabaseClient) {
            const initialized = initSupabaseClient();
            if (!initialized) {
              console.error("Cannot check updates: Supabase not initialized");
              showUpdateError();
              return;
            }
          }

          // Query the update_check table
          const { data, error } = await supabaseClient
            .from("update_check")
            .select("*")
            .single();

          if (error) {
            console.error("Error checking for updates:", error);
            showUpdateError();
            return;
          }

          if (!data) {
            console.error("No update data found");
            showUpdateError();
            return;
          }

          console.log("Update data received:", data);

          // Compare versions
          const latestVersion = data.version;
          const latestVersionName =
            data.version_name || `X-ORBIT Desktop ${latestVersion}`;
          const updateSize = data.update_size || "Unknown";

          if (latestVersion !== CURRENT_VERSION) {
            // Update available
            console.log("Update available:", latestVersion);
            latestUpdateData = {
              version: latestVersion,
              versionName: latestVersionName,
              size: updateSize,
            };
            showUpdateAvailable(latestVersionName, latestVersion, updateSize);
          } else {
            // Up to date
            console.log("System is up to date");
            showUpToDate();
          }
        } catch (e) {
          console.error("Error in checkForSystemUpdates:", e);
          showUpdateError();
        }
      }

      // UI update functions
      function showUpdateCheckStatus() {
        const statusDiv = document.getElementById("updateCheckStatus");
        const availableDiv = document.getElementById("updateAvailable");
        const upToDateDiv = document.getElementById("upToDate");
        const errorDiv = document.getElementById("updateError");

        if (statusDiv) statusDiv.style.display = "block";
        if (availableDiv) availableDiv.style.display = "none";
        if (upToDateDiv) upToDateDiv.style.display = "none";
        if (errorDiv) errorDiv.style.display = "none";
      }

      function showUpdateAvailable(versionName, version, size) {
        const statusDiv = document.getElementById("updateCheckStatus");
        const availableDiv = document.getElementById("updateAvailable");
        const upToDateDiv = document.getElementById("upToDate");
        const errorDiv = document.getElementById("updateError");

        const versionNameEl = document.getElementById("updateVersionName");
        const versionNumberEl = document.getElementById("updateVersionNumber");
        const updateSizeEl = document.getElementById("updateSize");

        if (statusDiv) statusDiv.style.display = "none";
        if (availableDiv) availableDiv.style.display = "block";
        if (upToDateDiv) upToDateDiv.style.display = "none";
        if (errorDiv) errorDiv.style.display = "none";

        if (versionNameEl) versionNameEl.textContent = versionName;
        if (versionNumberEl) versionNumberEl.textContent = version;
        if (updateSizeEl) updateSizeEl.textContent = size;
      }

      function showUpToDate() {
        const statusDiv = document.getElementById("updateCheckStatus");
        const availableDiv = document.getElementById("updateAvailable");
        const upToDateDiv = document.getElementById("upToDate");
        const errorDiv = document.getElementById("updateError");

        if (statusDiv) statusDiv.style.display = "none";
        if (availableDiv) availableDiv.style.display = "none";
        if (upToDateDiv) upToDateDiv.style.display = "block";
        if (errorDiv) errorDiv.style.display = "none";
      }

      function showUpdateError() {
        const statusDiv = document.getElementById("updateCheckStatus");
        const availableDiv = document.getElementById("updateAvailable");
        const upToDateDiv = document.getElementById("upToDate");
        const errorDiv = document.getElementById("updateError");

        if (statusDiv) statusDiv.style.display = "none";
        if (availableDiv) availableDiv.style.display = "none";
        if (upToDateDiv) upToDateDiv.style.display = "none";
        if (errorDiv) errorDiv.style.display = "block";
      }

      // Update button handlers
      function setupUpdateHandlers(settingsContent) {
        const updateNowBtn = settingsContent.querySelector("#updateNowBtn");
        const updateLaterBtn = settingsContent.querySelector("#updateLaterBtn");
        const recheckUpdateBtn =
          settingsContent.querySelector("#recheckUpdateBtn");
        const retryUpdateBtn = settingsContent.querySelector("#retryUpdateBtn");

        if (updateNowBtn) {
          updateNowBtn.addEventListener("click", function () {
            performUpdate();
          });
        }

        if (updateLaterBtn) {
          updateLaterBtn.addEventListener("click", function () {
            pendingUpdateOnClose = true;
            updateLaterBtn.innerHTML = '<i class="fas fa-check"></i> Scheduled';
            updateLaterBtn.style.background = "rgba(120, 80, 255, 0.18)";
            updateLaterBtn.style.borderColor = "rgba(120, 80, 255, 0.4)";
            updateLaterBtn.style.color = "#a888ff";
            updateLaterBtn.disabled = true;

            // Show confirmation
            showSaveIndicator();
          });
        }

        if (recheckUpdateBtn) {
          recheckUpdateBtn.addEventListener("click", function () {
            showUpdateCheckStatus();
            setTimeout(() => {
              checkForSystemUpdates();
            }, 500);
          });
        }

        if (retryUpdateBtn) {
          retryUpdateBtn.addEventListener("click", function () {
            showUpdateCheckStatus();
            setTimeout(() => {
              checkForSystemUpdates();
            }, 500);
          });
        }
      }

      function performUpdate() {
        // Show inline progress section
        const inlineProgress = document.getElementById("updateInlineProgress");
        if (inlineProgress) inlineProgress.style.display = "block";

        // Hide the action buttons
        const nowBtn = document.getElementById("updateNowBtn");
        const laterBtn = document.getElementById("updateLaterBtn");
        if (nowBtn) nowBtn.style.display = "none";
        if (laterBtn) laterBtn.style.display = "none";

        const progressBar = document.getElementById("updateProgressBar");
        const progressPercent = document.getElementById("updateProgressPercent");
        const progressStatus = document.getElementById("updateProgressStatus");
        const progressTime = document.getElementById("updateProgressTime");

        // Cancel not needed inline â€” no cancelBtn
        let updateCancelled = false;

        // Realistic 5-minute update process with detailed steps
        const updateSteps = [
          // Initial connection (15 seconds)
          {
            progress: 1,
            status: "Connecting to update server...",
            delay: 3000,
          },
          { progress: 2, status: "Authenticating connection...", delay: 2000 },
          {
            progress: 3,
            status: "Verifying update availability...",
            delay: 2000,
          },
          { progress: 5, status: "Retrieving update manifest...", delay: 3000 },
          {
            progress: 7,
            status: "Checking system compatibility...",
            delay: 2000,
          },
          { progress: 8, status: "Preparing download...", delay: 3000 },

          // Download phase 1 - Core files (90 seconds)
          {
            progress: 10,
            status: "Downloading core system files...",
            delay: 4000,
          },
          {
            progress: 12,
            status: "Downloading framework updates...",
            delay: 5000,
          },
          { progress: 15, status: "Downloading UI components...", delay: 4000 },
          {
            progress: 18,
            status: "Downloading application modules...",
            delay: 5000,
          },
          {
            progress: 22,
            status: "Downloading security patches...",
            delay: 4000,
          },
          {
            progress: 25,
            status: "Downloading system libraries...",
            delay: 5000,
          },
          { progress: 28, status: "Downloading asset files...", delay: 4000 },
          {
            progress: 32,
            status: "Downloading configuration files...",
            delay: 5000,
          },
          {
            progress: 35,
            status: "Downloading language packs...",
            delay: 4000,
          },

          // Download phase 2 - Additional content (60 seconds)
          {
            progress: 38,
            status: "Downloading theme resources...",
            delay: 4000,
          },
          { progress: 42, status: "Downloading icon sets...", delay: 5000 },
          { progress: 45, status: "Downloading sound effects...", delay: 4000 },
          { progress: 48, status: "Downloading wallpapers...", delay: 4000 },
          { progress: 51, status: "Downloading fonts...", delay: 4000 },
          { progress: 54, status: "Downloading documentation...", delay: 5000 },

          // Verification phase (45 seconds)
          {
            progress: 57,
            status: "Verifying download integrity...",
            delay: 5000,
          },
          { progress: 60, status: "Checking file checksums...", delay: 4000 },
          {
            progress: 63,
            status: "Validating package signatures...",
            delay: 5000,
          },
          { progress: 66, status: "Scanning for corruption...", delay: 4000 },
          { progress: 68, status: "Verifying all components...", delay: 4000 },

          // Extraction phase (45 seconds)
          { progress: 70, status: "Extracting update package...", delay: 5000 },
          { progress: 73, status: "Decompressing core files...", delay: 4000 },
          {
            progress: 76,
            status: "Extracting system components...",
            delay: 5000,
          },
          {
            progress: 79,
            status: "Unpacking application files...",
            delay: 4000,
          },
          { progress: 82, status: "Extracting resource files...", delay: 4000 },

          // Installation phase (45 seconds)
          {
            progress: 84,
            status: "Preparing installation environment...",
            delay: 4000,
          },
          { progress: 86, status: "Backing up current system...", delay: 5000 },
          { progress: 88, status: "Installing core updates...", delay: 5000 },
          {
            progress: 90,
            status: "Updating system components...",
            delay: 4000,
          },
          { progress: 92, status: "Installing new features...", delay: 5000 },
          {
            progress: 94,
            status: "Applying configuration changes...",
            delay: 4000,
          },

          // Finalization phase (30 seconds)
          {
            progress: 95,
            status: "Cleaning up temporary files...",
            delay: 4000,
          },
          { progress: 96, status: "Updating system registry...", delay: 3000 },
          { progress: 97, status: "Configuring services...", delay: 3000 },
          { progress: 98, status: "Optimizing system...", delay: 4000 },
          { progress: 99, status: "Finalizing installation...", delay: 3000 },
          { progress: 100, status: "Update complete!", delay: 2000 },
        ];

        let currentStep = 0;
        const startTime = Date.now();
        const totalDuration = updateSteps.reduce(
          (sum, step) => sum + step.delay,
          0
        );

        function formatTime(ms) {
          const totalSeconds = Math.ceil(ms / 1000);
          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          return `${minutes}m ${seconds}s`;
        }

        function nextUpdateStep() {
          if (updateCancelled) return;

          if (currentStep >= updateSteps.length) {
            // Update complete
            setTimeout(() => {
              if (progressStatus)
                progressStatus.textContent = "Update installed successfully!";
              if (progressTime)
                progressTime.textContent = "Restartingâ€¦";

              // Reload the page after 3 seconds
              setTimeout(() => {
                location.reload();
              }, 3000);
            }, 500);
            return;
          }

          const step = updateSteps[currentStep];
          const elapsedTime = Date.now() - startTime;
          const remainingTime = totalDuration - elapsedTime;

          if (progressBar) progressBar.style.width = step.progress + "%";
          if (progressPercent)
            progressPercent.textContent = step.progress + "%";
          if (progressStatus) progressStatus.textContent = step.status;
          if (progressTime && remainingTime > 0) {
            progressTime.textContent = formatTime(remainingTime) + " remaining";
          }

          currentStep++;
          setTimeout(nextUpdateStep, step.delay);
        }

        // Start update process
        setTimeout(nextUpdateStep, 500);
      }
      // â”€â”€ Modal System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const xModal = {
        _close() {
          const el = document.getElementById("xModal");
          if (el) el.classList.remove("show");
        },
        _show(icon, title, message, buttons) {
          const overlay = document.getElementById("xModal");
          const iconEl   = document.getElementById("xModalIcon");
          const titleEl  = document.getElementById("xModalTitle");
          const msgEl    = document.getElementById("xModalMessage");
          const actionsEl = document.getElementById("xModalActions");
          if (!overlay || !iconEl || !titleEl || !msgEl || !actionsEl) return;

          iconEl.innerHTML      = icon;
          titleEl.textContent   = title;
          msgEl.textContent     = message;
          actionsEl.innerHTML   = "";

          buttons.forEach(btn => {
            const el = document.createElement("button");
            el.className = "xorbit-button" +
              (btn.danger  ? " danger"             : "") +
              (btn.primary ? " xmodal-btn-primary"  : "");
            el.textContent = btn.label;
            el.type = "button";
            el.addEventListener("click", function(e) {
              e.stopPropagation();
              xModal._close();
              if (btn.action) btn.action();
            });
            actionsEl.appendChild(el);
          });

          overlay.classList.add("show");
        },
        alert(message, { title = "Notice", icon = '<i class="fas fa-info-circle" style="color:#9070ff"></i>' } = {}) {
          xModal._show(icon, title, message, [{ label: "OK", primary: true }]);
        },
        confirm(message, onConfirm, { title = "Confirm", icon = '<i class="fas fa-question-circle" style="color:#9070ff"></i>', confirmText = "Confirm", danger = false } = {}) {
          xModal._show(icon, title, message, [
            { label: "Cancel" },
            { label: confirmText, primary: !danger, danger, action: onConfirm }
          ]);
        }
      };
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // â”€â”€ Data & Backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // Fields that must never leave the device
      const DEVICE_ONLY_FIELDS = [
        "deviceId", "device_id", "uuid", "UUID", "machineId", "machine_id",
        "fingerprint", "deviceFingerprint", "hardwareId", "hardware_id",
        "sessionToken", "session_token", "token", "authToken", "auth_token",
        "sessionId", "session_id", "refreshToken", "refresh_token"
      ];

      function exportBackup() {
        // Grab and sanitize settings â€” strip any device-only fields
        let settingsData = {};
        try {
          settingsData = JSON.parse(localStorage.getItem("xorbit-settings") || "{}");
        } catch(e) {}
        DEVICE_ONLY_FIELDS.forEach(f => delete settingsData[f]);

        // Grab safe user identity â€” username + email only, no session data
        let safeIdentity = null;
        try {
          const raw = sessionStorage.getItem("xorbit_auth_session") || localStorage.getItem("xorbit_auth_session");
          if (raw) {
            const parsed = JSON.parse(raw);
            safeIdentity = {
              username: parsed.username || parsed.name || null,
              email:    parsed.email || null
            };
          }
        } catch(e) {}

        const backup = {
          _xorbit_backup: true,
          version: "1.0",
          exportedAt: new Date().toISOString(),
          settings: settingsData,
          tutorialCompleted: localStorage.getItem("xorbit-tutorial-completed") || null,
          userIdentity: safeIdentity   // display info only â€” no tokens, no device IDs
        };

        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement("a");
        a.href     = url;
        a.download = "xorbit-backup.json";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backup = JSON.parse(e.target.result);

            if (!backup._xorbit_backup || !backup.settings) {
              xModal.alert("This doesn't look like a valid X-ORBIT backup file.", { title: "Invalid Backup", icon: '<i class="fas fa-exclamation-triangle" style="color:#ff453a"></i>' });
              return;
            }

            // Strip device fields again in case the file was manually edited
            DEVICE_ONLY_FIELDS.forEach(f => delete backup.settings[f]);

            // Restore settings
            localStorage.setItem("xorbit-settings", JSON.stringify(backup.settings));
            settings = { ...settings, ...backup.settings };

            // Restore tutorial state
            if (backup.tutorialCompleted) {
              localStorage.setItem("xorbit-tutorial-completed", backup.tutorialCompleted);
            }

            // Apply everything immediately â€” never touch auth session or device data
            applySettings();
            if (backup.settings.customWallpaper) {
              applyWallpaper(backup.settings.customWallpaper);
            }

            xModal.alert("Your settings and wallpaper have been applied successfully.", { title: "Backup Restored", icon: '<i class="fas fa-check-circle" style="color:#34c759"></i>' });
          } catch(err) {
            xModal.alert("The file may be corrupted or not a valid X-ORBIT backup.", { title: "Import Failed", icon: '<i class="fas fa-exclamation-triangle" style="color:#ff453a"></i>' });
          }
          event.target.value = "";
        };
        reader.readAsText(file);
      }
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // REPLACE YOUR EXISTING logout() function with this one:
      function logout() {
        // Check if there's a pending update
        if (pendingUpdateOnClose && latestUpdateData) {
          if (
            confirm(
              "An update is ready to install. Would you like to install it now before logging out?"
            )
          ) {
            performUpdate();
            return;
          }
        }

        // Original logout code
        if (
          confirm(
            "Are you sure you want to logout? All unsaved work will be lost."
          )
        ) {
          stopBanChecking();
          activeWindows.forEach((windowId) => {
            const windowEl = document.getElementById(windowId);
            if (windowEl) windowEl.remove();
          });
          activeWindows.clear();
          isAuthenticated = false;

          const logoutDiv = document.createElement("div");
          logoutDiv.innerHTML = `
      <div style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(10, 5, 25, 0.9);
        backdrop-filter: blur(60px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        color: #e8f0ff;
        flex-direction: column;
        gap: 20px;
      ">
        <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #ff6b6b;"></i>
        <div style="font-size: 1.2rem; font-weight: 500;">Logging out...</div>
      </div>
    `;
          document.body.appendChild(logoutDiv);

          setTimeout(() => {
            logoutDiv.remove();
            const welcomeOverlay = document.getElementById("welcomeOverlay");
            if (welcomeOverlay) {
              welcomeOverlay.style.display = "flex";
            }
          }, 1500);
        }

        const xorbitDropdown = document.getElementById("xorbitDropdown");
        if (xorbitDropdown) xorbitDropdown.classList.remove("show");
      }

      // MODIFY YOUR EXISTING setupSettingsEvents function
      // Find this function and ADD this code at the END of it (before the closing brace):

      // Add to setupSettingsEvents function:
      function enhanceSettingsWithUpdateChecker(settingsContent) {
        if (!settingsContent) return;

        // Add update handlers
        setupUpdateHandlers(settingsContent);

        // Start update check when System section is activated
        const systemNavItem = settingsContent.querySelector(
          '[data-section="general"]'
        );
        if (systemNavItem) {
          systemNavItem.addEventListener("click", function () {
            setTimeout(() => {
              checkForSystemUpdates();
            }, 300);
          });
        }

        // Check for updates on settings open if System section is active
        const systemSection = settingsContent.querySelector("#general-section");
        if (systemSection && systemSection.classList.contains("active")) {
          setTimeout(() => {
            checkForSystemUpdates();
          }, 500);
        }
      }

      // Call this at the end of your setupSettingsEvents function:
      // enhanceSettingsWithUpdateChecker(settingsContent);
    </script>
  </body>
</html>
